<form xmlns:xf="http://www.w3.org/2002/xforms" xmlns:ev="http://www.w3.org/2001/xml-events">
    <xf:switch>
        <xf:case id="referencesPanel" selected="true">
            <xf:group ref="instance('xprExpertise')/xpr:sourceDesc">
                <xf:label>Références</xf:label>
                <xf:group>
                    <xf:label>Identifiants</xf:label>
                    <xf:input ref="xpr:idno[@type='unitid']" incremental="true">
                        <xf:label>Cote</xf:label>
                        <xf:help>La cote doit respecter le format suivant : Z1JXXX</xf:help>
                        <xf:alert>Le champ "Cote" est requis.</xf:alert>
                    </xf:input>
                    <xf:input ref="xpr:idno[@type = 'item']" incremental="true">
                        <xf:label>Dossier</xf:label>
                        <xf:alert>Le champ "Dossier" est requis.</xf:alert>
                    </xf:input>
                    <xf:select1 ref="xpr:idno[@type = 'supplement']" incremental="true" appearance="full">
                        <xf:label>Supplement cote</xf:label>
                        <xf:item>
                            <xf:label>bis</xf:label>
                            <xf:value>bis</xf:value>
                        </xf:item>
                        <xf:item>
                            <xf:label>ter</xf:label>
                            <xf:value>ter</xf:value>
                        </xf:item>
                    </xf:select1>
                    <xf:trigger ref="instance('xprExpertise')/xpr:sourceDesc[not(xpr:idno[@type='supplement'])]">
                        <xf:label>bis/ter</xf:label>
                        <xf:action ev:event="DOMActivate">
                            <xf:insert if="not(instance('xprExpertise')/xpr:sourceDesc/xpr:idno[@type='supplement'])" context="." origin="instance('xprExpertiseCopy')/xpr:sourceDesc/xpr:idno[@type='item']" nodeset="xpr:idno[@type='item']" position="after"/>
                            <xf:setvalue ev:event="xforms-insert" ref="instance('xprExpertise')/xpr:sourceDesc/xpr:idno[@type='item'][2]/@type" value="'supplement'"/>
                        </xf:action>
                    </xf:trigger>
                    <xf:trigger ref="instance('xprExpertise')/xpr:sourceDesc[xpr:idno[@type='supplement']]">
                        <xf:label>Supprimer le supplement cote</xf:label>
                        <xf:action ev:event="DOMActivate">
                            <xf:delete if="instance('xprExpertise')/xpr:sourceDesc/xpr:idno[@type='supplement']" nodeset="instance('xprExpertise')/xpr:sourceDesc/xpr:idno[@type='supplement']"/>
                        </xf:action>
                    </xf:trigger>
                </xf:group>
                <xf:group ref="xpr:facsimile">
                    <xf:label>Identifiants des vues</xf:label>
                    <xf:input ref="@from" incremental="true">
                        <xf:label>Première vue</xf:label>
                    </xf:input>
                    <xf:input ref="@to" incremental="true">
                        <xf:label>Dernière vue</xf:label>
                    </xf:input>
                </xf:group>
                <xf:group ref="xpr:physDesc">
                    <xf:label>Description physique du procès-verbal et des pièces annexes</xf:label>
                    <xf:input ref="xpr:extent" incremental="true">
                        <xf:label>Nombre de feuillets</xf:label>
                    </xf:input>
                    <xf:select1 ref="xpr:extent/@sketch" appearance="full">
                        <xf:label>Croquis sur le procès-verbal</xf:label>
                        <xf:item>
                            <xf:label>oui</xf:label>
                            <xf:value>true</xf:value>
                        </xf:item>
                        <xf:item>
                            <xf:label>non</xf:label>
                            <xf:value>false</xf:value>
                        </xf:item>
                    </xf:select1>
                    <xf:group ref="xpr:appendices">
                        <xf:label>Pièces annexes</xf:label>
                        <xf:output value="count(xpr:appendice)">
                            <xf:label>Nombre de pièces annexes</xf:label>
                        </xf:output>
                        <xf:repeat nodeset="xpr:appendice" appearance="full">
                            <xf:repeat nodeset="xpr:type">
                                <xf:select1 ref="@type">
                                    <xf:label>Type de pièce annexe</xf:label>
                                    <xf:item>
                                        <xf:label>Dessin</xf:label>
                                        <xf:value>drawing</xf:value>
                                        <xf:setvalue ref="parent::xpr:type" ev:event="xforms-select">Dessin</xf:setvalue>
                                    </xf:item>
                                    <xf:item>
                                        <xf:label>Plan, coupe, élévation</xf:label>
                                        <xf:value>plan</xf:value>
                                        <xf:action ev:event="xforms-select">
                                            <xf:setvalue ref="parent::xpr:type">Plan, coupe, élévation</xf:setvalue>
                                        </xf:action>
                                    </xf:item>
                                    <xf:item>
                                        <xf:label>Croquis</xf:label>
                                        <xf:value>sketch</xf:value>
                                        <xf:action ev:event="xforms-select">
                                            <xf:setvalue ref="parent::xpr:type">Croquis</xf:setvalue>
                                        </xf:action>
                                    </xf:item>
                                    <xf:item>
                                        <xf:label>Brouillon</xf:label>
                                        <xf:value>rough</xf:value>
                                        <xf:action ev:event="xforms-select">
                                            <xf:setvalue ref="parent::xpr:type">Brouillon</xf:setvalue>
                                        </xf:action>
                                    </xf:item>
                                    <xf:item>
                                        <xf:label>Pouvoir/procuration (acte sous seing privé)</xf:label>
                                        <xf:value>proxyPA</xf:value>
                                        <xf:action ev:event="xforms-select">
                                            <xf:setvalue ref="parent::xpr:type">Pouvoir/procuration (acte sous seing privé)</xf:setvalue>
                                        </xf:action>
                                    </xf:item>
                                    <xf:item>
                                        <xf:label>Pouvoir/procuration (acte notarié)</xf:label>
                                        <xf:value>proxyNA</xf:value>
                                        <xf:action ev:event="xforms-select">
                                            <xf:setvalue ref="parent::xpr:type">Pouvoir/procuration (acte notarié)</xf:setvalue>
                                        </xf:action>
                                    </xf:item>
                                    <xf:item>
                                        <xf:label>Requête</xf:label>
                                        <xf:value>petition</xf:value>
                                        <xf:action ev:event="xforms-select">
                                            <xf:setvalue ref="parent::xpr:type">Requête</xf:setvalue>
                                        </xf:action>
                                    </xf:item>
                                    <xf:item>
                                        <xf:label>Autre</xf:label>
                                        <xf:value>other</xf:value>
                                        <xf:action ev:event="xforms-select">
                                            <xf:setvalue ref="parent::xpr:type">À préciser</xf:setvalue>
                                        </xf:action>
                                    </xf:item>
                                </xf:select1>
                                <xf:input ref="self::node()[@type='other']" incremental="true"> </xf:input>
                                <xf:trigger class="delete">
                                    <xf:label>&#10007;</xf:label>
                                    <xf:delete nodeset="." at="1" if="count(parent::xpr:appendice/xpr:type) > 1" ev:event="DOMActivate"/>
                                    <xf:help>Supprimer un type d'annexe.</xf:help>
                                </xf:trigger>
                            </xf:repeat>
                            <xf:trigger class="insert">
                                <xf:label>Ajouter un type</xf:label>
                                <xf:insert context="." origin="instance('xprExpertiseCopy')/xpr:sourceDesc/xpr:physDesc/xpr:appendices/xpr:appendice/xpr:type" nodeset="xpr:type[last()]" position="after" ev:event="DOMActivate"/>
                                <xf:help>Ajouter un type d'annexe</xf:help>
                            </xf:trigger>
                            <xf:input ref="xpr:extent" incremental="true">
                                <xf:label>Nombre de feuillets</xf:label>
                            </xf:input>
                            <xf:textarea ref="xpr:desc" incremental="true">
                                <xf:label>Description physique</xf:label>
                            </xf:textarea>
                            <xf:textarea ref="xpr:note" incremental="true">
                                <xf:label>Commentaires</xf:label>
                            </xf:textarea>
                            <xf:trigger class="delete">
                                <xf:label>Supprimer une annexe</xf:label>
                                <xf:delete nodeset="." at="1" if="count(parent::xpr:appendices/xpr:appendice) > 1" ev:event="DOMActivate"/>
                                <xf:help>Supprimer une annexe</xf:help>
                            </xf:trigger>
                        </xf:repeat>
                        <xf:trigger class="insert">
                            <xf:label>Ajouter une pièce annexe</xf:label>
                            <xf:insert context="." origin="instance('xprExpertiseCopy')/xpr:sourceDesc/xpr:physDesc/xpr:appendices/xpr:appendice" nodeset="xpr:appendice[last()]" position="after" ev:event="DOMActivate"/>
                            <xf:help>Ajouter une pièce annexe</xf:help>
                        </xf:trigger>
                    </xf:group>
                    <xf:trigger ref="self::node()[not(xpr:appendices)]">
                        <xf:label>Ajouter des pièces annexes</xf:label>
                        <xf:insert context="instance('xprExpertise')/xpr:sourceDesc/xpr:physDesc" origin="instance('xprExpertiseCopy')/xpr:sourceDesc/xpr:physDesc/xpr:appendices" nodeset="xpr:extent" position="after" ev:event="DOMActivate"/>
                        <xf:help>Ajouter des pièces annexes</xf:help>
                    </xf:trigger>
                    <xf:trigger ref="self::node()[xpr:appendices]">
                        <xf:label>Supprimer toutes les pièces annexes</xf:label>
                        <xf:delete nodeset="instance('xprExpertise')/xpr:sourceDesc/xpr:physDesc/xpr:appendices" ev:event="DOMActivate"/>
                        <xf:help>Supprimer toutes les pièces annexes</xf:help>
                    </xf:trigger>
                </xf:group>
            </xf:group>
        </xf:case>
        <xf:case id="sessionsPanel" selected="false">
            <xf:label>Vacations</xf:label>
            <xf:group ref="xpr:description/xpr:sessions">
                <xf:repeat id="repeatSession" nodeset="xpr:date">
                    <xf:input ref="@when" incremental="true">
                        <xf:label>Date</xf:label>
                        <xf:alert>La date indiquée ne respecte pas le format requis.</xf:alert>
                        <xf:hint>La date indiquée doit respecter les formats suivants : AAAA-MM-JJ ou JJ/MM/AAAA</xf:hint>
                        <xf:help>Vous pouvez vous aider du calendrier pour sélectionner directement une date.</xf:help>
                    </xf:input>
                    <xf:select1 ref="@type">
                        <xf:label>Lieu</xf:label>
                        <xf:item>
                            <xf:label>Paris et faubourgs</xf:label>
                            <xf:value>paris</xf:value>
                        </xf:item>
                        <xf:item>
                            <xf:label>Banlieue</xf:label>
                            <xf:value>suburbs</xf:value>
                        </xf:item>
                        <xf:item>
                            <xf:label>Campagne</xf:label>
                            <xf:value>province</xf:value>
                        </xf:item>
                    </xf:select1>
                    <xf:trigger class="delete">
                        <xf:label>&#10007;</xf:label>
                        <xf:delete nodeset="." at="1" ev:event="DOMActivate" if="count(//xpr:description/xpr:sessions/xpr:date) > 1"/>
                        <xf:help>Supprimer une vacation.</xf:help>
                    </xf:trigger>
                </xf:repeat>
                <xf:trigger class="insert">
                    <xf:label>Ajouter une vacation</xf:label>
                    <xf:action ev:event="DOMActivate">
                        <xf:insert context="." origin="instance('xprExpertiseCopy')/xpr:description/xpr:sessions/xpr:date" nodeset="xpr:date" at="last()" position="after"/>
                    </xf:action>
                    <xf:help>Ajouter une vacation.</xf:help>
                </xf:trigger>
            </xf:group>
            <xf:label>Lieux de l’expertise</xf:label>
            <xf:group ref="xpr:description/xpr:places">
                <xf:repeat id="repeatPlace" nodeset="xpr:place" appearance="full">
                    <xf:select1 ref="@type">
                        <xf:label>Lieu de l’expertise</xf:label>
                        <xf:item>
                            <xf:label>Paris</xf:label>
                            <xf:value>paris</xf:value>
                        </xf:item>
                        <xf:item>
                            <xf:label>Banlieue</xf:label>
                            <xf:value>suburbs</xf:value>
                        </xf:item>
                        <xf:item>
                            <xf:label>Campagne</xf:label>
                            <xf:value>province</xf:value>
                        </xf:item>
                        <xf:item>
                            <xf:label>Bureau des experts</xf:label>
                            <xf:value>office</xf:value>
                        </xf:item>
                        <xf:item>
                            <xf:label>Bureau du greffier</xf:label>
                            <xf:value>clerkOffice</xf:value>
                        </xf:item>
                        <xf:item>
                            <xf:label>Indéterminé</xf:label>
                            <xf:value>indeterminate</xf:value>
                        </xf:item>
                    </xf:select1>
                    <xf:input ref="xpr:address/xpr:street" incremental="true">
                        <xf:label>Voie</xf:label>
                    </xf:input>
                    <xf:input ref="xpr:address/xpr:buildingNumber" incremental="true">
                        <xf:label>Numéro</xf:label>
                    </xf:input>
                    <xf:input ref="xpr:complement" incremental="true">
                        <xf:label>Précisions géographiques</xf:label>
                    </xf:input>
                    <xf:input ref="xpr:parish" incremental="true">
                        <xf:label>Paroisse</xf:label>
                    </xf:input>
                    <xf:input ref="xpr:city" incremental="true">
                        <xf:label>Ville</xf:label>
                    </xf:input>
                    <xf:input ref="xpr:district" incremental="true">
                        <xf:label>Département</xf:label>
                    </xf:input>
                    <xf:repeat id="repeatOwner" nodeset="xpr:owner" appearance="full">
                        <xf:input ref="." incremental="true">
                            <xf:label>Propriétaire</xf:label>
                        </xf:input>
                        <xf:trigger class="delete">
                            <xf:label>Supprimer un propriétaire</xf:label>
                            <xf:delete nodeset="." at="1" ev:event="DOMActivate" if="count(//xpr:description/xpr:places/xpr:place[index('repeatPlace')]/xpr:owner) > 1"/>
                            <xf:help>Supprimer un propriétaire.</xf:help>
                        </xf:trigger>
                    </xf:repeat>
                    <xf:trigger class="insert" ref="//xpr:place[index('repeatPlace')][@type='paris' or @type='suburbs' or @type='province' or @type='indeterminate']">
                        <xf:label>Ajouter un propriétaire</xf:label>
                        <xf:action ev:event="DOMActivate">
                            <xf:insert context="." origin="instance('xprExpertiseCopy')/xpr:description/xpr:places/xpr:place/xpr:owner" nodeset="xpr:owner" at="last()" position="after"/>
                        </xf:action>
                        <xf:help>Ajouter un propriétaire.</xf:help>
                    </xf:trigger>
                    <xf:trigger class="delete">
                        <xf:label>Supprimer un lieu</xf:label>
                        <xf:delete nodeset="." at="1" ev:event="DOMActivate" if="count(//xpr:description/xpr:places/xpr:place) > 1"/>
                        <xf:delete nodeset="instance('xprExpertise')/xpr:description/xpr:conclusions/xpr:estimates/xpr:place[position() = index('repeatPlace')]" ev:event="DOMActivate" if="instance('xprExpertise')/xpr:description/xpr:categories/xpr:category[@type='estimation'] and count(//xpr:description/xpr:conclusions/xpr:estimates/xpr:place) > 1"/>
                        <xf:help>Supprimer un lieu.</xf:help>
                    </xf:trigger>
                </xf:repeat>
                <xf:trigger class="insert">
                    <xf:label>Ajouter un lieu</xf:label>
                    <xf:action ev:event="DOMActivate">
                        <xf:insert if="instance('xprExpertise')/xpr:description/xpr:categories/xpr:category[@type='estimation']" context="instance('xprExpertise')/xpr:description/xpr:conclusions/xpr:estimates" origin="instance('xprExpertiseCopy')/xpr:description/xpr:conclusions/xpr:estimates/xpr:place" nodeset="xpr:place" at="index('repeatPlace')" position="after" ev:event="DOMActivate"/>
                        <xf:insert context="." origin="instance('xprExpertiseCopy')/xpr:description/xpr:places/xpr:place" nodeset="xpr:place" at="index('repeatPlace')" position="after" ev:event="DOMActivate"/>
                    </xf:action>
                    <xf:help>Ajouter un lieu.</xf:help>
                </xf:trigger>
            </xf:group>
        </xf:case>
        <xf:case id="procedurePanel" selected="false">
            <xf:group ref="instance('xprExpertise')/xpr:description/xpr:categories">
                <xf:label>Types d’expertise</xf:label>
                <xf:select ref="instance('xprExpertiseCategories')/xpr:category[not(@type)]" appearance="full">
                    <xf:label>Catégories d’expertise</xf:label>
                    <xf:item>
                        <xf:label>Estimer la valeur des biens</xf:label>
                        <xf:value>estimation</xf:value>
                        <xf:action ev:event="xforms-select">
                            <xf:insert context="instance('xprExpertise')/xpr:description/xpr:categories" origin="instance('xprExpertiseCategories')/xpr:category[@type='estimation']"/>
                            <xf:insert context="instance('xprExpertise')/xpr:description/xpr:conclusions" origin="instance('xprExpertiseCopy')/xpr:description/xpr:conclusions/xpr:estimates" nodeset="xpr:estimate" position="after"/>
                            <xf:action while="count(instance('xprExpertise')/xpr:description/xpr:conclusions/xpr:estimates/xpr:place) &lt; count(instance('xprExpertise')/xpr:description/xpr:places/xpr:place)">
                                <xf:insert context="instance('xprExpertise')/xpr:description/xpr:conclusions/xpr:estimates" origin="instance('xprExpertiseCopy')/xpr:description/xpr:conclusions/xpr:estimates/xpr:place" nodeset="xpr:place[last()]"/>
                            </xf:action>
                        </xf:action>
                        <xf:action ev:event="xforms-deselect">
                            <xf:delete nodeset="instance('xprExpertise')/xpr:description/xpr:categories/xpr:category[@type='estimation']"/>
                            <xf:delete nodeset="instance('xprExpertise')/xpr:description/xpr:conclusions/xpr:estimates"/>
                        </xf:action>
                    </xf:item>
                    <xf:item>
                        <xf:label>Recevoir et évaluer le travail réalisé</xf:label>
                        <xf:value>acceptation</xf:value>
                        <xf:action ev:event="xforms-select">
                            <xf:insert context="instance('xprExpertise')/xpr:description/xpr:categories" origin="instance('xprExpertiseCategories')/xpr:category[@type='acceptation']"/>
                        </xf:action>
                        <xf:action ev:event="xforms-deselect">
                            <xf:delete nodeset="instance('xprExpertise')/xpr:description/xpr:categories/xpr:category[@type='acceptation']"/>
                        </xf:action>
                    </xf:item>
                    <xf:item>
                        <xf:label>Enregistrer</xf:label>
                        <xf:value>registration</xf:value>
                        <xf:action ev:event="xforms-select">
                            <xf:insert context="instance('xprExpertise')/xpr:description/xpr:categories" origin="instance('xprExpertiseCategories')/xpr:category[@type='registration']"/>
                        </xf:action>
                        <xf:action ev:event="xforms-deselect">
                            <xf:delete nodeset="instance('xprExpertise')/xpr:description/xpr:categories/xpr:category[@type='registration']"/>
                        </xf:action>
                    </xf:item>
                    <xf:item>
                        <xf:label>Départager</xf:label>
                        <xf:value>settlement</xf:value>
                        <xf:action ev:event="xforms-select">
                            <xf:insert context="instance('xprExpertise')/xpr:description/xpr:categories" origin="instance('xprExpertiseCategories')/xpr:category[@type='settlement']"/>
                        </xf:action>
                        <xf:action ev:event="xforms-deselect">
                            <xf:delete nodeset="instance('xprExpertise')/xpr:description/xpr:categories/xpr:category[@type='settlement']"/>
                        </xf:action>
                    </xf:item>
                    <xf:item>
                        <xf:label>Décrire et évaluer les travaux à venir</xf:label>
                        <xf:value>assessment</xf:value>
                        <xf:action ev:event="xforms-select">
                            <xf:insert context="instance('xprExpertise')/xpr:description/xpr:categories" origin="instance('xprExpertiseCategories')/xpr:category[@type='assessment']"/>
                        </xf:action>
                        <xf:action ev:event="xforms-deselect">
                            <xf:delete nodeset="instance('xprExpertise')/xpr:description/xpr:categories/xpr:category[@type='assessment']"/>
                        </xf:action>
                    </xf:item>
                    <xf:help>Plusieurs cases peuvent être cochées.</xf:help>
                </xf:select>
                <xf:input ref="xpr:designation" incremental="true">
                    <xf:label>Désignation</xf:label>
                </xf:input>
                <xf:select1 ref="xpr:designation/@rubric" appearance="full">
                    <xf:label>En rubrique</xf:label>
                    <xf:item>
                        <xf:label>oui</xf:label>
                        <xf:value>true</xf:value>
                    </xf:item>
                    <xf:item>
                        <xf:label>non</xf:label>
                        <xf:value>false</xf:value>
                    </xf:item>
                </xf:select1>
            </xf:group>
            <xf:group ref="xpr:description/xpr:procedure">
                <xf:label>Procédure et cadre de l’expertise</xf:label>
                <xf:group ref="xpr:framework">
                    <xf:select1 ref="@type" appearance="full">
                        <xf:label>Procédure</xf:label>
                        <xf:item>
                            <xf:label>A/ Commun accord des parties</xf:label>
                            <xf:value>a</xf:value>
                            <xf:action ev:event="xforms-select">
                                <xf:setvalue ref="parent::xpr:framework">Commun accord des parties</xf:setvalue>
                                <xf:setvalue ref="instance('xprExpertise')/xpr:description/xpr:procedure/xpr:origination" value="'Les parties'"/>
                                <xf:setvalue ref="instance('xprExpertise')/xpr:description/xpr:procedure/xpr:origination/@type" value="'parties'"/>
                            </xf:action>
                        </xf:item>
                        <xf:choices>
                            <xf:label>B/ Saisie d’une institution</xf:label>
                            <xf:item>
                                <xf:label>B1/ Requête auprès d’une institution pour qu’elle demande une expertise</xf:label>
                                <xf:value>b1</xf:value>
                                <xf:action ev:event="xforms-select">
                                    <xf:setvalue ref="parent::xpr:framework">Requête auprès d’une institution pour qu’elle demande une expertise</xf:setvalue>
                                    <xf:setvalue ref="instance('xprExpertise')/xpr:description/xpr:procedure/xpr:origination" value="'Les parties'"/>
                                    <xf:setvalue ref="instance('xprExpertise')/xpr:description/xpr:procedure/xpr:origination/@type" value="'parties'"/>
                                </xf:action>
                            </xf:item>
                            <xf:item>
                                <xf:label>B2/ Une institution est saisie dans le cadre d’une procédure</xf:label>
                                <xf:value>b2</xf:value>
                                <xf:action ev:event="xforms-select">
                                    <xf:setvalue ref="parent::xpr:framework">L’institution est saisie dans le cadre d’une procédure (les parties nomment chacune leur expert ou un expert en commun)</xf:setvalue>
                                    <xf:setvalue ref="instance('xprExpertise')/xpr:description/xpr:procedure/xpr:origination" value="'Une institution'"/>
                                    <xf:setvalue ref="instance('xprExpertise')/xpr:description/xpr:procedure/xpr:origination/@type" value="'institution'"/>
                                </xf:action>
                            </xf:item>
                        </xf:choices>
                        <xf:item>
                            <xf:label>C/ Cas problématique</xf:label>
                            <xf:value>c</xf:value>
                            <xf:action ev:event="xforms-select">
                                <xf:setvalue ref="parent::xpr:framework">Cas problématique</xf:setvalue>
                                <xf:setvalue ref="instance('xprExpertise')/xpr:description/xpr:procedure/xpr:origination" value="''"/>
                                <xf:setvalue ref="instance('xprExpertise')/xpr:description/xpr:procedure/xpr:origination/@type" value="''"/>
                            </xf:action>
                        </xf:item>
                    </xf:select1>
                </xf:group>
                <xf:group ref="xpr:origination">
                    <xf:label>Origine de l’expertise</xf:label>
                    <xf:select1 ref="@type" appearance="full">
                        <xf:label>Déclenchement de l’expertise</xf:label>
                        <xf:item>
                            <xf:label>Les parties</xf:label>
                            <xf:value>parties</xf:value>
                            <xf:action ev:event="xforms-select">
                                <xf:setvalue ref="ancestor::xpr:origination" value="'Les parties'"/>
                            </xf:action>
                        </xf:item>
                        <xf:item>
                            <xf:label>Une institution</xf:label>
                            <xf:value>institution</xf:value>
                            <xf:action ev:event="xforms-select">
                                <xf:setvalue ref="ancestor::xpr:origination" value="'Une institution'"/>
                            </xf:action>
                        </xf:item>
                    </xf:select1>
                </xf:group>
                <xf:group ref="xpr:sentences">
                    <xf:label>Intervention d’une institution</xf:label>
                    <xf:repeat id="repeatSentence" nodeset="xpr:sentence" appearance="full">
                        <xf:input ref="xpr:orgName" incremental="true">
                            <xf:label>Institution :</xf:label>
                        </xf:input>
                        <xf:repeat id="repeatDateSentence" nodeset="xpr:date">
                            <xf:input ref="@when" incremental="true">
                                <xf:label>Date</xf:label>
                            </xf:input>
                            <xf:trigger class="delete">
                                <xf:label>Supprimer une date</xf:label>
                                <xf:delete nodeset="." at="1" ev:event="DOMActivate" if="count(//xpr:description/xpr:procedure/xpr:sentences/xpr:sentence/xpr:date) > 1"/>
                                <xf:help>Supprimer une date.</xf:help>
                            </xf:trigger>
                        </xf:repeat>
                        <xf:trigger class="insert">
                            <xf:label>Ajouter une date</xf:label>
                            <xf:action ev:event="DOMActivate">
                                <xf:insert context="." origin="instance('xprExpertiseCopy')/xpr:description/xpr:procedure/xpr:sentences/xpr:sentence/xpr:date" nodeset="xpr:date" at="last()" position="after" ev:event="DOMActivate"/>
                            </xf:action>
                            <xf:help>Ajouter une date.</xf:help>
                        </xf:trigger>
                        <xf:trigger class="delete">
                            <xf:label>Supprimer une institution</xf:label>
                            <xf:delete nodeset="." at="1" ev:event="DOMActivate" if="count(//xpr:description/xpr:procedure/xpr:sentences/xpr:sentence) > 1"/>
                            <xf:help>Supprimer une institution.</xf:help>
                        </xf:trigger>
                    </xf:repeat>
                    <xf:trigger class="insert">
                        <xf:label>Ajouter une institution</xf:label>
                        <xf:action ev:event="DOMActivate">
                            <xf:insert context="." origin="instance('xprExpertiseCopy')/xpr:description/xpr:procedure/xpr:sentences/xpr:sentence" nodeset="xpr:sentence" at="last()" position="after" ev:event="DOMActivate"/>
                        </xf:action>
                        <xf:help>Ajouter une institution.</xf:help>
                    </xf:trigger>
                </xf:group>
                <xf:group ref="xpr:case">
                    <xf:input ref="." incremental="true">
                        <xf:label>Cause de l’expertise</xf:label>
                    </xf:input>
                </xf:group>
                <xf:group ref="xpr:objects">
                    <xf:select ref="instance('xprExpertise')/xpr:description/xpr:procedure/xpr:objects" appearance="full">
                        <xf:label>Objet de l’expertise</xf:label>
                        <xf:itemset nodeset="instance('xprExpertiseObjects')/xpr:object[@type]">
                            <xf:label value="if(normalize-space(.[not(@type='other')])!='' , ., 'Autre')"></xf:label>
                            <!--for xsltforms 1.5<xf:label><xf:output value="if(normalize-space(.[not(@type='other')])!='' , ., 'Autre')"/></xf:label>-->
                            <xf:copy ref="."/>
                        </xf:itemset>
                    </xf:select>
                    <xf:input ref="xpr:object[@type='other']" incremental="true">
                        <xf:label>Autre, à préciser</xf:label>
                    </xf:input>
                </xf:group>
            </xf:group>
        </xf:case>
        <xf:case id="participantsPanel" selected="false">
            <xf:label>Acteurs de l’expertise</xf:label>
            <xf:group ref="xpr:description/xpr:participants/xpr:experts">
                <xf:var name="experts" value="."/>
                <xf:label><xf:output value="if(count(xpr:expert) > 1, 'Experts', 'Expert')"/></xf:label>
                <xf:repeat id="repeatExpert" nodeset="xpr:expert" appearance="full">
                    <xf:var name="expert" value="."/>
                    <xf:select1 ref="@ref" incremental="true">
                        <xf:label>Patronyme</xf:label>
                        <xf:itemset nodeset="instance('xprExperts')/xpr:entity[contains(@type, 'expert') or contains(@type, 'altExpert')]">
                            <xf:label ref="xpr:label"/>
                            <xf:value value="concat('#', @xml:id)"/>
                        </xf:itemset>
                        <xf:action ev:event="xforms-deselect">
                            <xf:show dialog="warningOpinion" if="instance('xprExpertise')//xpr:conclusions/xpr:opinion[contains(@ref, instance('xprExpertise')/xpr:description/xpr:participants/xpr:experts/xpr:expert[index('repeatExpert')]/@ref[normalize-space(.)!=''])]/@ref"/>
                            <xf:setvalue  ref="instance('xprExpertise')//xpr:conclusions/xpr:opinion[contains(@ref, $expert/@ref)]/@ref" value="normalize-space(replace(instance('xprExpertise')//xpr:conclusions/xpr:opinion[contains(@ref, $expert/@ref)]/@ref, $expert/@ref , ''))"/>
                        </xf:action>
                        <!-- set new ref for opinion if disagreement is checked when expert is modified-->
                        <xf:action ev:event="xforms-value-changed">
                            <xf:setvalue if="instance('xprExpertise')//xpr:conclusions/xpr:agreement/@type = 'disagreement'"
                                         ref="instance('xprExpertise')//xpr:opinion[@ref!=''][not(@ref=instance('xprExpertise')//xpr:participants/xpr:experts/xpr:expert/@ref)]/@ref"
                                         value="$expert/@ref"/>
                            <xf:setvalue if="instance('xprExpertise')//xpr:conclusions/xpr:fees/@detail='true'"
                                         ref="instance('xprExpertise')//xpr:conclusions/xpr:fees/xpr:fee[@ref!=''][@type='expert'][not(@ref=instance('xprExpertise')//xpr:participants/xpr:experts/xpr:expert/@ref)]/@ref"
                                         value="$expert/@ref"/>
                            <xf:setvalue ref="instance('xprExpertise')//xpr:participants/xpr:parties/xpr:party/xpr:expert[@ref!=''][not(@ref=instance('xprExpertise')//xpr:participants/xpr:experts/xpr:expert/@ref)]/@ref"
                                         value="$expert/@ref"/>
                        </xf:action>
                    </xf:select1>
                    <xf:dialog id="warningOpinion">
                        <xf:label>Vous venez de modifier un expert alors qu’une ou plusieurs conclusions lui étaient associées. Merci de vérifier les différentes conclusions avant de sauvegarder la fiche.</xf:label>
                        <xf:trigger>
                            <xf:label>Ok</xf:label>
                            <xf:hide ev:event="DOMActivate" dialog="warningOpinion"/>
                        </xf:trigger>
                    </xf:dialog>
                    <xf:input ref="xpr:title" incremental="true">
                        <xf:label>Dénomination de l’expert dans l’acte</xf:label>
                    </xf:input>
                    <xf:select1 ref="@context" appearance="minimal">
                        <xf:label>Qualité de l’expert</xf:label>
                        <xf:item>
                            <xf:label>premier lieu</xf:label>
                            <xf:value>primary</xf:value>
                        </xf:item>
                        <xf:item>
                            <xf:label>tiers expert</xf:label>
                            <xf:value>third-party</xf:value>
                        </xf:item>
                        <xf:item>
                            <xf:label>indéterminé</xf:label>
                            <xf:value>unknown</xf:value>
                        </xf:item>
                    </xf:select1>
                    <xf:select1 ref="@appointment" appearance="minimal">
                        <xf:label>Origine de la nomination</xf:label>
                        <xf:item>
                            <xf:label>d’office (par une institution)</xf:label>
                            <xf:value>court-appointed</xf:value>
                        </xf:item>
                        <xf:item>
                            <xf:label>par les parties</xf:label>
                            <xf:value>appointed</xf:value>
                        </xf:item>
                        <xf:item>
                            <xf:label>par les experts</xf:label>
                            <xf:value>experts</xf:value>
                        </xf:item>
                        <xf:item>
                            <xf:label>mixte</xf:label>
                            <xf:value>mixed</xf:value>
                        </xf:item>
                        <xf:item>
                            <xf:label>indéterminé</xf:label>
                            <xf:value>unknown</xf:value>
                        </xf:item>
                    </xf:select1>
                    <xf:group ref=".[not(@recalled)]">
                        <xf:trigger>
                            <xf:label>Expert rappelé</xf:label>
                            <xf:insert ev:event="DOMActivate"
                                       context="."
                                       origin="instance('xprExpertiseCopy')//xpr:participants/xpr:experts/xpr:expert/@recalled"/>
                            <xf:setvalue ev:event="DOMActivate" ref="@recalled" value="'true'"/>
                        </xf:trigger>
                    </xf:group>
                    <xf:select ref="@recalled" appearance="full">
                        <xf:label>Expert rappelé</xf:label>
                        <xf:item>
                            <xf:label>oui</xf:label>
                            <xf:value>true</xf:value>
                            <xf:delete ev:event="xforms-deselect" nodeset="."/>
                        </xf:item>
                    </xf:select>
                    <xf:trigger class="delete">
                        <xf:label>Supprimer un expert</xf:label>
                        <xf:setvalue ref="instance('xprExpertise')//xpr:conclusions/xpr:opinion[contains(@ref, $expert/@ref)]/@ref" value="normalize-space(replace(instance('xprExpertise')//xpr:conclusions/xpr:opinion[contains(@ref, $expert/@ref)]/@ref, $expert/@ref , ''))" ev:event="DOMActivate"/>
                        <!--<xf:delete nodeset="instance('xprExpertise')//xpr:conclusions/xpr:opinion[@ref = current()/@ref]" at="1" ev:event="DOMActivate" if="count(//xpr:description/xpr:participants/xpr:experts/xpr:expert) > 1"/>-->
                        <xf:delete nodeset="instance('xprExpertise')//xpr:conclusions/xpr:fees/xpr:fee[@type='expert'][@ref = current()/@ref]" at="1" ev:event="DOMActivate" if="count(//xpr:description/xpr:participants/xpr:experts/xpr:expert) > 1"/>
                        <xf:delete nodeset="." at="1" ev:event="DOMActivate" if="count(//xpr:description/xpr:participants/xpr:experts/xpr:expert) > 1"/>
                        <xf:help>Supprimer un expert.</xf:help>
                    </xf:trigger>
                </xf:repeat>
                <xf:trigger class="insert">
                    <xf:label>Ajouter un expert</xf:label>
                    <xf:insert if="instance('xprExpertise')//xpr:conclusions/xpr:agreement[not(@type='conclusion')]"
                               context="."
                               origin="instance('xprExpertiseCopy')/xpr:description/xpr:participants/xpr:experts/xpr:expert"
                               nodeset="xpr:expert"
                               at="last()"
                               position="after"
                               ev:event="DOMActivate"/>
                    <xf:delete if="instance('xprExpertise')//xpr:conclusions/xpr:agreement[not(@type='conclusion')]"
                               nodeset="instance('xprExpertise')/xpr:description/xpr:participants/xpr:experts/xpr:expert[last()]/@recalled"
                               ev:event="DOMActivate"/>
                    <xf:show ev:event="DOMActivate"
                             dialog="warningAgreement"
                             if="count(instance('xprExpertise')/xpr:description/xpr:participants/xpr:experts/xpr:expert) >= 1 and not(instance('xprExpertise')/xpr:description/xpr:participants/xpr:experts/xpr:expert[@context='third-party']) and instance('xprExpertise')//xpr:conclusions/xpr:agreement[@type='conclusion']"/>
                    <xf:action if="instance('xprExpertise')//xpr:conclusions/xpr:fees/@detail= 'true'"
                               ev:event="DOMActivate">
                        <xf:insert context="instance('xprExpertise')//xpr:conclusions/xpr:fees"
                                   origin="instance('xprExpertiseFees')/xpr:fee[@type='expert']"
                                   nodeset="xpr:fee[@type='expert'][last()]"
                                   position="after"/>
                    </xf:action>
                    <xf:help>Ajouter un expert.</xf:help>
                </xf:trigger>
                <xf:dialog id="warningAgreement">
                    <xf:label>Vous êtes sur le point d'ajouter un expert alors que le champ « Dispositif de l’expertise » est positionné sur « conclusion », si vous poursuivez ce champ sera réinitialisé.</xf:label>
                    <xf:trigger>
                        <xf:label>Annuler</xf:label>
                        <xf:hide ev:event="DOMActivate" dialog="warningAgreement"/>
                    </xf:trigger>
                    <xf:trigger>
                        <xf:label>Ajouter un expert</xf:label>
                        <xf:action ev:event="DOMActivate">
                            <xf:insert context="." origin="instance('xprExpertiseCopy')/xpr:description/xpr:participants/xpr:experts/xpr:expert" nodeset="xpr:expert" at="last()" position="after"/>
                            <xf:delete nodeset="instance('xprExpertise')/xpr:description/xpr:participants/xpr:experts/xpr:expert[last()]/@recalled" ev:event="DOMActivate"/>
                            <xf:setvalue ref="instance('xprExpertise')//xpr:conclusions/xpr:agreement" value="''"/>
                            <xf:setvalue ref="instance('xprExpertise')//xpr:conclusions/xpr:agreement/@type" value="''"/>
                            <xf:hide ev:event="DOMActivate" dialog="warningAgreement"/>
                        </xf:action>
                    </xf:trigger>
                </xf:dialog>
            </xf:group>
            <xf:group ref="xpr:description/xpr:participants/xpr:clerks">
                <xf:label><xf:output value="if(count(xpr:clerk) > 1, 'Greffiers', 'Greffier')"/></xf:label>
                <xf:repeat id="repeatClerk" nodeset="xpr:clerk" appearance="full">
                    <xf:label>Patronyme</xf:label>
                    <xf:input ref="xpr:persName/xpr:surname" incremental="true">
                        <xf:label>Nom</xf:label>
                    </xf:input>
                    <xf:input ref="xpr:persName/xpr:forename" incremental="true">
                        <xf:label>Prénom</xf:label>
                    </xf:input>
                    <xf:select1 ref="@ref" incremental="true">
                        <xf:label>Référence</xf:label>
                        <xf:itemset nodeset="instance('xprExperts')/xpr:entity[contains(@type, 'clerk')]">
                            <xf:label ref="xpr:label"/>
                            <xf:value value="concat('#', @xml:id)"/>
                        </xf:itemset>
                    </xf:select1>
                    <xf:trigger class="delete">
                        <xf:label>Supprimer un greffier</xf:label>
                        <xf:delete nodeset="." at="1" ev:event="DOMActivate" if="count(//xpr:description/xpr:participants/xpr:clerks/xpr:clerk) > 1"/>
                        <xf:help>Supprimer un greffier.</xf:help>
                    </xf:trigger>
                </xf:repeat>
                <xf:trigger class="insert">
                    <xf:label>Ajouter un greffier</xf:label>
                    <xf:action ev:event="DOMActivate">
                        <xf:insert context="." origin="instance('xprExpertiseCopy')/xpr:description/xpr:participants/xpr:clerks/xpr:clerk" nodeset="xpr:clerk" at="last()" position="after" ev:event="DOMActivate"/>
                    </xf:action>
                    <xf:help>Ajouter un greffier.</xf:help>
                </xf:trigger>
            </xf:group>
            <xf:group ref="xpr:description/xpr:participants/xpr:parties">
                <xf:label><xf:output value="if(count(xpr:party) > 1, 'Parties', 'Partie')"/></xf:label>
                <xf:repeat id="repeatParty" nodeset="xpr:party" appearance="full">
                    <xf:repeat id="repeatPerson" nodeset="xpr:person" appearance="full">
                        <xf:label>Patronyme</xf:label>
                        <xf:input ref="xpr:persName/xpr:surname" incremental="true">
                            <xf:label>Nom</xf:label>
                        </xf:input>
                        <xf:input ref="xpr:persName/xpr:forename" incremental="true">
                            <xf:label>Prénom</xf:label>
                        </xf:input>
                        <xf:input ref="xpr:occupation" incremental="true">
                            <xf:label>Qualité, profession</xf:label>
                        </xf:input>
                        <xf:trigger class="delete">
                            <xf:label>Supprimer une personne</xf:label>
                            <xf:delete nodeset="." at="1" ev:event="DOMActivate" if="count(//xpr:description/xpr:participants/xpr:parties/xpr:party[index('repeatParty')]/xpr:person) > 1"/>
                            <xf:help>Supprimer une personne.</xf:help>
                        </xf:trigger>
                    </xf:repeat>
                    <xf:trigger class="insert">
                        <xf:label>Ajouter une personne</xf:label>
                        <xf:action ev:event="DOMActivate">
                            <xf:insert context="." origin="instance('xprExpertiseCopy')/xpr:description/xpr:participants/xpr:parties/xpr:party/xpr:person" nodeset="xpr:person" at="last()" position="after" ev:event="DOMActivate"/>
                        </xf:action>
                        <xf:help>Ajouter une personne.</xf:help>
                    </xf:trigger>
                    <xf:select1 ref="@role">
                        <xf:label>Partie</xf:label>
                        <xf:item>
                            <xf:label>Requérante</xf:label>
                            <xf:value>petitioner</xf:value>
                        </xf:item>
                        <xf:item>
                            <xf:label>Opposante</xf:label>
                            <xf:value>opponent</xf:value>
                        </xf:item>
                    </xf:select1>
                    <xf:select1 ref="xpr:status">
                        <xf:label>Qualification individuelle</xf:label>
                        <xf:item>
                            <xf:label>Entrepreneur</xf:label>
                            <xf:value>builder</xf:value>
                        </xf:item>
                        <xf:item>
                            <xf:label>Propriétaire</xf:label>
                            <xf:value>owner</xf:value>
                        </xf:item>
                        <xf:item>
                            <xf:label>Copropriétaire</xf:label>
                            <xf:value>joint-owner</xf:value>
                        </xf:item>
                        <xf:item>
                            <xf:label>Commanditaire</xf:label>
                            <xf:value>limited-partner</xf:value>
                        </xf:item>
                        <xf:item>
                            <xf:label>Héritier</xf:label>
                            <xf:value>heir</xf:value>
                        </xf:item>
                        <xf:item>
                            <xf:label>Voisin</xf:label>
                            <xf:value>neighbour</xf:value>
                        </xf:item>
                        <xf:item>
                            <xf:label>Locataire</xf:label>
                            <xf:value>tenant</xf:value>
                        </xf:item>
                        <xf:item>
                            <xf:label>Principal locataire</xf:label>
                            <xf:value>main-tenant</xf:value>
                        </xf:item>
                        <xf:item>
                            <xf:label>Créancier</xf:label>
                            <xf:value>creditor</xf:value>
                        </xf:item>
                        <xf:item>
                            <xf:label>Débiteur</xf:label>
                            <xf:value>mortgagor</xf:value>
                        </xf:item>
                        <xf:item>
                            <xf:label>Fermier judiciaire</xf:label>
                            <xf:value>contractor</xf:value>
                        </xf:item>
                        <xf:item>
                            <xf:label>Police</xf:label>
                            <xf:value>police</xf:value>
                        </xf:item>
                    </xf:select1>
                    <xf:select1 ref="xpr:expert/@ref">
                        <xf:label>Expert agissant pour cette partie</xf:label>
                        <xf:item>
                            <xf:label/>
                            <xf:value/>
                        </xf:item>
                        <xf:itemset nodeset="instance('xprExperts')//xpr:entity[contains(@type, 'expert') or @type='altExpert'][concat('#', @xml:id) = instance('xprExpertise')/xpr:description/xpr:participants/xpr:experts/xpr:expert[@context!='third-party']/@ref]">
                            <xf:label ref="."/>
                            <xf:value value="concat('#', @xml:id)"/>
                        </xf:itemset>
                    </xf:select1>
                    <xf:select1 ref="@presence">
                        <xf:label>Partie présente</xf:label>
                        <xf:item>
                            <xf:label>oui</xf:label>
                            <xf:value>true</xf:value>
                        </xf:item>
                        <xf:item>
                            <xf:label>non</xf:label>
                            <xf:value>false</xf:value>
                        </xf:item>
                    </xf:select1>
                    <xf:select1 ref="@intervention">
                        <xf:label>Partie intervenante</xf:label>
                        <xf:item>
                            <xf:label>oui</xf:label>
                            <xf:value>true</xf:value>
                        </xf:item>
                        <xf:item>
                            <xf:label>non</xf:label>
                            <xf:value>false</xf:value>
                        </xf:item>
                    </xf:select1>
                    <xf:group>
                        <xf:label><xf:output value="if(count(xpr:representative) > 1, 'Représentants', 'Représentant')"/></xf:label>
                        <xf:repeat id="repeatRepresentative" nodeset="xpr:representative" appearance="full">
                            <xf:label>Patronyme</xf:label>
                            <xf:input ref="xpr:persName/xpr:surname" incremental="true">
                                <xf:label>Nom</xf:label>
                            </xf:input>
                            <xf:input ref="xpr:persName/xpr:forename" incremental="true">
                                <xf:label>Prénom</xf:label>
                            </xf:input>
                            <xf:input ref="xpr:occupation" incremental="true">
                                <xf:label>Qualité, profession</xf:label>
                            </xf:input>
                            <xf:trigger class="delete">
                                <xf:label>Supprimer un représentant</xf:label>
                                <xf:delete nodeset="." at="1" ev:event="DOMActivate"/>
                                <xf:help>Supprimer un représentant.</xf:help>
                            </xf:trigger>
                        </xf:repeat>
                        <xf:trigger>
                            <xf:label>Ajouter un representant</xf:label>
                            <xf:action ev:event="DOMActivate">
                                <xf:insert if="xpr:representative" context="." origin="instance('xprExpertiseCopy')/xpr:description/xpr:participants/xpr:parties/xpr:party/xpr:representative" nodeset="xpr:representative" at="last()" position="after"/>
                                <xf:insert if="not(xpr:representative)" context="." origin="instance('xprExpertiseCopy')/xpr:description/xpr:participants/xpr:parties/xpr:party/xpr:representative" nodeset="xpr:expert" at="last()" position="after"/>
                            </xf:action>
                            <xf:help>Ajouter un représentant.</xf:help>
                        </xf:trigger>
                    </xf:group>
                    <xf:group>
                        <xf:label><xf:output value="if(count(xpr:prosecutor) > 1, 'Procureurs', 'Procureur')"/></xf:label>
                        <xf:repeat id="repeatProsecutor" nodeset="xpr:prosecutor" appearance="full">
                            <xf:label>Patronyme</xf:label>
                            <xf:input ref="xpr:persName/xpr:surname" incremental="true">
                                <xf:label>Nom</xf:label>
                            </xf:input>
                            <xf:input ref="xpr:persName/xpr:forename" incremental="true">
                                <xf:label>Prénom</xf:label>
                            </xf:input>
                            <xf:trigger class="delete">
                                <xf:label>Supprimer un procureur</xf:label>
                                <xf:delete nodeset="." at="1" ev:event="DOMActivate"/>
                                <xf:help>Supprimer un procureur.</xf:help>
                            </xf:trigger>
                        </xf:repeat>
                        <xf:trigger>
                            <xf:label>Ajouter un procureur</xf:label>
                            <xf:action ev:event="DOMActivate">
                                <xf:insert context="." origin="instance('xprExpertiseCopy')/xpr:description/xpr:participants/xpr:parties/xpr:party/xpr:prosecutor" nodeset="*" at="last()" position="after"/>
                            </xf:action>
                            <xf:help>Ajouter un procureur.</xf:help>
                        </xf:trigger>
                    </xf:group>
                    <xf:trigger class="delete">
                        <xf:label>Supprimer une partie</xf:label>
                        <xf:delete nodeset="." at="1" ev:event="DOMActivate" if="count(//xpr:description/xpr:participants/xpr:parties/xpr:party) > 1"/>
                        <xf:help>Supprimer une partie.</xf:help>
                    </xf:trigger>
                </xf:repeat>
                <xf:trigger class="insert">
                    <xf:label>Ajouter une partie</xf:label>
                    <xf:action ev:event="DOMActivate">
                        <xf:insert context="." origin="instance('xprExpertiseCopy')/xpr:description/xpr:participants/xpr:parties/xpr:party" nodeset="xpr:party" at="last()" position="after"/>
                        <xf:delete ref="xpr:party[last()]/xpr:representative"/>
                        <xf:delete ref="xpr:party[last()]/xpr:prosecutor"/>
                    </xf:action>
                    <xf:help>Ajouter une partie.</xf:help>
                </xf:trigger>
            </xf:group>
            <xf:group ref="xpr:description/xpr:participants/xpr:craftmen">
                <xf:label><xf:output value="if(count(xpr:craftman) > 1, 'Entrepreneurs, architectes ou maîtres d’œuvre', 'Entrepreneur, architecte ou maître d’œuvre')"/></xf:label>
                <xf:repeat id="repeatCraftman" nodeset="xpr:craftman" appearance="full">
                    <xf:label>Patronyme</xf:label>
                    <xf:input ref="xpr:persName/xpr:surname" incremental="true">
                        <xf:label>Nom</xf:label>
                    </xf:input>
                    <xf:input ref="xpr:persName/xpr:forename" incremental="true">
                        <xf:label>Prénom</xf:label>
                    </xf:input>
                    <xf:input ref="xpr:occupation" incremental="true">
                        <xf:label>profession</xf:label>
                    </xf:input>
                    <xf:trigger class="delete">
                        <xf:label>Supprimer un entrepreneur, architecte ou maître d’œuvre</xf:label>
                        <xf:delete nodeset="." at="1" ev:event="DOMActivate" if="count(//xpr:description/xpr:participants/xpr:craftmen/xpr:craftman) > 1"/>
                        <xf:help>Supprimer un entrepreneur, architecte ou maître d’œuvre.</xf:help>
                    </xf:trigger>
                </xf:repeat>
                <xf:trigger class="insert">
                    <xf:label>Ajouter un entrepreneur, architecte ou maître d’œuvre</xf:label>
                    <xf:action ev:event="DOMActivate">
                        <xf:insert context="." origin="instance('xprExpertiseCopy')/xpr:description/xpr:participants/xpr:craftmen/xpr:craftman" nodeset="xpr:craftman" at="last()" position="after"/>
                    </xf:action>
                    <xf:help>Ajouter un entrepreneur, architecte ou maître d’œuvre.</xf:help>
                </xf:trigger>
            </xf:group>
        </xf:case>
        <xf:case id="conclusionsPanel" selected="false">
            <xf:label>Conclusions ou dispositifs de l’expertise</xf:label>
            <xf:group ref="xpr:description/xpr:conclusions">
                <xf:select1 ref="xpr:agreement[ancestor::xpr:description[count(xpr:participants/xpr:experts//xpr:expert) = 1] or ancestor::xpr:description/xpr:participants/xpr:experts//xpr:expert[@context='third-party']]" appearance="full">
                    <xf:label>Dispositif de l’expertise</xf:label>
                    <xf:item>
                        <xf:label>Conclusion</xf:label>
                        <xf:value>Conclusion</xf:value>
                        <xf:action ev:event="xforms-select">
                            <xf:setvalue ref="@type" value="'conclusion'"/>
                        </xf:action>
                    </xf:item>
                    <xf:item>
                        <xf:label>Sans conclusion</xf:label>
                        <xf:value>Sans conclusion</xf:value>
                        <xf:action ev:event="xforms-select">
                            <xf:setvalue ref="@type" value="'noConclusion'"/>
                        </xf:action>
                    </xf:item>
                    <xf:item>
                        <xf:label>Affaire inachevée</xf:label>
                        <xf:value>Affaire inachevée</xf:value>
                        <xf:action ev:event="xforms-select">
                            <xf:setvalue ref="@type" value="'unfinished'"/>
                        </xf:action>
                    </xf:item>
                    <xf:help>ex. Sans conclusion : Alignement</xf:help>
                </xf:select1>
                <xf:select1 ref="xpr:agreement[ancestor::xpr:description[count(xpr:participants/xpr:experts//xpr:expert) &gt; 1] and not(ancestor::xpr:description/xpr:participants/xpr:experts//xpr:expert[@context='third-party'])]"
                            appearance="full">
                    <xf:label>Dispositif de l’expertise</xf:label>
                    <xf:item>
                        <xf:label>Accord</xf:label>
                        <xf:value>Accord</xf:value>
                        <xf:action ev:event="xforms-select">
                            <xf:setvalue ref="@type" value="'agreement'"/>
                        </xf:action>
                    </xf:item>
                    <xf:item>
                        <xf:label>Désaccord</xf:label>
                        <xf:value>Désaccord</xf:value>
                        <xf:action ev:event="xforms-select">
                            <xf:setvalue ref="@type" value="'disagreement'"/>
                        </xf:action>
                    </xf:item>
                    <xf:item>
                        <xf:label>Sans conclusion</xf:label>
                        <xf:value>Sans conclusion</xf:value>
                        <xf:action ev:event="xforms-select">
                            <xf:setvalue ref="@type" value="'noConclusion'"/>
                        </xf:action>
                    </xf:item>
                    <xf:item>
                        <xf:label>Affaire inachevée</xf:label>
                        <xf:value>Affaire inachevée</xf:value>
                        <xf:action ev:event="xforms-select">
                            <xf:setvalue ref="@type" value="'unfinished'"/>
                        </xf:action>
                    </xf:item>
                    <xf:help>ex. Sans conclusion : Alignement</xf:help>
                </xf:select1>
                <xf:repeat id="repeatOpinion" nodeset="xpr:opinion">
                    <xf:label>Conclusion</xf:label>
                    <xf:select ref="@ref" appearance="full">
                        <xf:label>Expert(s)</xf:label>
                        <xf:itemset nodeset="instance('xprExperts')//xpr:entity[@type='expert' or @type='altExpert'][concat('#', @xml:id) = instance('xprExpertise')/xpr:description/xpr:participants/xpr:experts/xpr:expert/@ref]" appearance="full">
                            <xf:label ref="."/>
                            <xf:value value="concat('#', @xml:id)"/>
                        </xf:itemset>
                    </xf:select>
                    <xf:textarea ref="." incremental="true">
                        <xf:label>Avis</xf:label>
                    </xf:textarea>
                    <xf:trigger class="delete">
                        <xf:label>Supprimer une conclusion</xf:label>
                        <xf:delete nodeset="." at="1" ev:event="DOMActivate"/>
                        <xf:help>Supprimer une conclusion.</xf:help>
                    </xf:trigger>
                </xf:repeat>
                <xf:trigger>
                    <xf:label>Ajouter une conclusion</xf:label>
                    <xf:action ev:event="DOMActivate">
                        <xf:insert context="." origin="instance('xprExpertiseCopy')/xpr:description/xpr:conclusions/xpr:opinion" nodeset="xpr:arrangement" position="before"/>
                    </xf:action>
                    <xf:help>Ajouter un entrepreneur, architecte ou maître d’œuvre.</xf:help>
                </xf:trigger>
                <xf:select ref="xpr:arrangement" appearance="full">
                    <xf:label>Accommodement</xf:label>
                    <xf:item>
                        <xf:label>Résolution par les parties</xf:label>
                        <!--@rmq /!\ select ne prend pas d'espace simple (separateur)
                            l'utilisation d'espace insécable règle le problème.-->
                        <xf:value>Résolution par les parties</xf:value>
                    </xf:item>
                </xf:select>
                <xf:group ref="xpr:estimate">
                    <xf:label>Montant global (pour les estimations)</xf:label>
                    <xf:input ref="@l" incremental="true">
                        <xf:label>livres</xf:label>
                    </xf:input>
                    <xf:input ref="@s" incremental="true">
                        <xf:label>sols</xf:label>
                    </xf:input>
                    <xf:input ref="@d" incremental="true">
                        <xf:label>deniers</xf:label>
                    </xf:input>
                </xf:group>
                <xf:group ref="xpr:estimates">
                    <xf:repeat id="estimatesPlace" nodeset="xpr:place">
                        <xf:label>
<!--                            <xf:output value="concat('Estimations pour ', instance('xprExpertise')/xpr:description/xpr:places/xpr:place[position() = count(current()/preceding-sibling::xpr:place) + 1]/xpr:address/xpr:street, ', ', instance('xprExpertise')/xpr:description/xpr:places/xpr:place[position() = count(current()/preceding-sibling::xpr:place) + 1]/xpr:address/xpr:buildingNumber)"/>-->
                            <xf:output value="concat('Estimations pour ', string-join(instance('xprExpertise')/xpr:description/xpr:places/xpr:place[position() = count(current()/preceding-sibling::xpr:place) + 1]//node()[not(node())][normalize-space(.)!=''], ', '))"/>
                        </xf:label>
                        <xf:repeat nodeset="xpr:appraisal">
                            <xf:input ref="xpr:desc" incremental="true">
                                <xf:label>Nature du bien</xf:label>
                            </xf:input>
                            <xf:input ref="@l" incremental="true">
                                <xf:label>livres</xf:label>
                            </xf:input>
                            <xf:input ref="@s" incremental="true">
                                <xf:label>sols</xf:label>
                            </xf:input>
                            <xf:input ref="@d" incremental="true">
                                <xf:label>deniers</xf:label>
                            </xf:input>
                            <xf:trigger class="delete">
                                <xf:label>Supprimer une estimation</xf:label>
                                <xf:delete ev:event="DOMActivate" nodeset="."/>
                                <xf:help>Supprimer une estimation</xf:help>
                            </xf:trigger>
                        </xf:repeat>
                        <xf:trigger>
                            <xf:label>Ajouter une estimation</xf:label>
                            <xf:insert ev:event="DOMActivate" context="." origin="instance('xprExpertiseCopy')/xpr:description/xpr:conclusions/xpr:estimates/xpr:place/xpr:appraisal" nodeset="xpr:appraisal[last()]" position="after"/>
                        </xf:trigger>
                    </xf:repeat>
                </xf:group>
                <xf:group ref="xpr:fees">
                    <xf:label>Coût de l’expertise</xf:label>
                    <xf:select1 ref="@detail" appearance="full">
                        <xf:label>Détail</xf:label>
                        <xf:item>
                            <xf:label>oui</xf:label>
                            <xf:value>true</xf:value>
                            <xf:action ev:event="xforms-select">
                                <xf:action while="count(//xpr:experts/xpr:expert) &gt; count(//xpr:fees/xpr:fee[@type='expert'])" ev:event="DOMActivate">
                                    <xf:insert context="ancestor::xpr:fees" origin="instance('xprExpertiseFees')/xpr:fee[@type='expert']" nodeset="xpr:total" position="before"/>
                                    <xf:setvalue ref="ancestor::xpr:fees/xpr:fee[@type='expert'][normalize-space(@ref) = '']/@ref" value="instance('xprExpertise')//xpr:experts/xpr:expert[not(@ref = instance('xprExpertise')/xpr:description/xpr:conclusions/xpr:fees/xpr:fee[@type='expert']/@ref)]/@ref"/>
                                </xf:action>
                                <xf:insert context="ancestor::xpr:fees" origin="instance('xprExpertiseFees')/xpr:fee[@type='clerk']" nodeset="xpr:fee[@type='expert'][last()]" position="after"/>
                                <xf:insert context="ancestor::xpr:fees" origin="instance('xprExpertiseFees')/xpr:fee[@type='rolls']" nodeset="xpr:fee[@type='clerk']" position="after"/>
                                <xf:insert context="ancestor::xpr:fees" origin="instance('xprExpertiseFees')/xpr:fee[@type='papers']" nodeset="xpr:fee[@type='rolls']" position="after"/>
                                <xf:insert context="ancestor::xpr:fees" origin="instance('xprExpertiseFees')/xpr:fee[@type='plans']" nodeset="xpr:fee[@type='papers']" position="after"/>
                                <xf:insert context="ancestor::xpr:fees" origin="instance('xprExpertiseFees')/xpr:fee[@type='prosecutors']" nodeset="xpr:fee[@type='plans']" position="after"/>
                                <xf:insert context="ancestor::xpr:fees" origin="instance('xprExpertiseFees')/xpr:fee[@type='help']" nodeset="xpr:fee[@type='prosecutors']" position="after"/>
                                <!-- rebuild to set the readonly on inserted/copied elements (for experts fees labels) -->
                                <xf:rebuild model="expertise"/>
                            </xf:action>
                        </xf:item>
                        <xf:item>
                            <xf:label>non</xf:label>
                            <xf:value>false</xf:value>
                            <xf:action ev:event="xforms-select">
                                <xf:delete ref="instance('xprExpertise')/xpr:description/xpr:conclusions/xpr:fees/xpr:fee[@type]"/>
                            </xf:action>
                        </xf:item>
                    </xf:select1>
                    <xf:group>
                        <xf:label>Expert(s)</xf:label>
                        <xf:repeat nodeset="xpr:fee[@type='expert']">
                            <xf:label>
                                <xf:output value="if(instance('xprExperts')/xpr:entity[@xml:id = substring-after(current()/@ref, '#')], concat('Expert (', instance('xprExperts')/xpr:entity[@xml:id = substring-after(current()/@ref, '#')]/xpr:label, ')'), 'Expert')"/>
                            </xf:label>
                            <xf:input ref="@l" incremental="true">
                                <xf:label>livres</xf:label>
                            </xf:input>
                            <xf:input ref="@s" incremental="true">
                                <xf:label>sols</xf:label>
                            </xf:input>
                            <xf:input ref="@d" incremental="true">
                                <xf:label>deniers</xf:label>
                            </xf:input>
                        </xf:repeat>
                    </xf:group>
                    <xf:group ref="xpr:fee[@type='clerk']">
                        <xf:label>Greffier</xf:label>
                        <xf:input ref="@l" incremental="true">
                            <xf:label>livres</xf:label>
                        </xf:input>
                        <xf:input ref="@s" incremental="true">
                            <xf:label>sols</xf:label>
                        </xf:input>
                        <xf:input ref="@d" incremental="true">
                            <xf:label>deniers</xf:label>
                        </xf:input>
                    </xf:group>
                    <xf:group ref="xpr:fee[@type='rolls']">
                        <xf:label>Rôles</xf:label>
                        <xf:input ref="@l" incremental="true">
                            <xf:label>livres</xf:label>
                        </xf:input>
                        <xf:input ref="@s" incremental="true">
                            <xf:label>sols</xf:label>
                        </xf:input>
                        <xf:input ref="@d" incremental="true">
                            <xf:label>deniers</xf:label>
                        </xf:input>
                    </xf:group>
                    <xf:group ref="xpr:fee[@type='papers']">
                        <xf:label>Papier et contrôle</xf:label>
                        <xf:input ref="@l" incremental="true">
                            <xf:label>livres</xf:label>
                        </xf:input>
                        <xf:input ref="@s" incremental="true">
                            <xf:label>sols</xf:label>
                        </xf:input>
                        <xf:input ref="@d" incremental="true">
                            <xf:label>deniers</xf:label>
                        </xf:input>
                    </xf:group>
                    <xf:group ref="xpr:fee[@type='plans']">
                        <xf:label>Plans</xf:label>
                        <xf:input ref="@l" incremental="true">
                            <xf:label>livres</xf:label>
                        </xf:input>
                        <xf:input ref="@s" incremental="true">
                            <xf:label>sols</xf:label>
                        </xf:input>
                        <xf:input ref="@d" incremental="true">
                            <xf:label>deniers</xf:label>
                        </xf:input>
                    </xf:group>
                    <xf:group ref="xpr:fee[@type='prosecutors']">
                        <xf:label>Procureur(s)</xf:label>
                        <xf:input ref="@l" incremental="true">
                            <xf:label>livres</xf:label>
                        </xf:input>
                        <xf:input ref="@s" incremental="true">
                            <xf:label>sols</xf:label>
                        </xf:input>
                        <xf:input ref="@d" incremental="true">
                            <xf:label>deniers</xf:label>
                        </xf:input>
                    </xf:group>
                    <xf:group ref="xpr:fee[@type='help']">
                        <xf:label>Aides</xf:label>
                        <xf:input ref="@l" incremental="true">
                            <xf:label>livres</xf:label>
                        </xf:input>
                        <xf:input ref="@s" incremental="true">
                            <xf:label>sols</xf:label>
                        </xf:input>
                        <xf:input ref="@d" incremental="true">
                            <xf:label>deniers</xf:label>
                        </xf:input>
                    </xf:group>
                    <xf:repeat id="repeatOtherFee" nodeset="xpr:fee[@type='other']" appearance="full">
                        <xf:label>Autres frais</xf:label>
                        <xf:input ref=".">
                            <xf:label>Intitulé</xf:label>
                        </xf:input>
                        <xf:input ref="@l" incremental="true">
                            <xf:label>livres</xf:label>
                        </xf:input>
                        <xf:input ref="@s" incremental="true">
                            <xf:label>sols</xf:label>
                        </xf:input>
                        <xf:input ref="@d" incremental="true">
                            <xf:label>deniers</xf:label>
                        </xf:input>
                        <xf:trigger class="delete">
                            <xf:label>Supprimer ces frais</xf:label>
                            <xf:delete nodeset="." at="1" ev:event="DOMActivate"/>
                            <xf:help>Supprimer ces frais.</xf:help>
                        </xf:trigger>
                    </xf:repeat>
                    <xf:trigger bind="addOtherFee">
                        <xf:label>Ajouter d'autres frais</xf:label>
                        <xf:insert context="instance('xprExpertise')/xpr:description/xpr:conclusions/xpr:fees" origin="instance('xprExpertiseFees')/xpr:fee[@type='other']" nodeset="xpr:total" position="before" ev:event="DOMActivate"/>
                        <xf:help>Ajouter d'autres frais.</xf:help>
                    </xf:trigger>
                    <xf:group ref="xpr:total">
                        <xf:label>Total</xf:label>
                        <xf:input ref="@l" incremental="true">
                            <xf:label>livres</xf:label>
                        </xf:input>
                        <xf:input ref="@s" incremental="true">
                            <xf:label>sols</xf:label>
                        </xf:input>
                        <xf:input ref="@d" incremental="true">
                            <xf:label>deniers</xf:label>
                        </xf:input>
                    </xf:group>
                </xf:group>
                <xf:group ref="xpr:expenses">
                    <xf:select ref="." appearance="full">
                        <xf:label>Bourse commune</xf:label>
                        <xf:itemset nodeset="instance('xprExpertiseExpenses')/xpr:expense">
                            <xf:label value="if(@type='expert' , 'Experts', 'Greffiers')"></xf:label>
                            <!--FOR XSLTFORMS 1.5<xf:label><xf:output value="if(@type='expert' , 'Experts', 'Greffiers')"/></xf:label>-->
                            <xf:copy ref="."/>
                        </xf:itemset>
                        <xf:repeat nodeset="xpr:expense">
                            <xf:label><xf:output value="if(@type='expert' , 'Bourse commune des experts', 'Bourse commune des greffiers')"/></xf:label>
                            <xf:input ref="@l" incremental="true">
                                <xf:label>livres</xf:label>
                            </xf:input>
                            <xf:input ref="@s" incremental="true">
                                <xf:label>sols</xf:label>
                            </xf:input>
                            <xf:input ref="@d" incremental="true">
                                <xf:label>deniers</xf:label>
                            </xf:input>
                        </xf:repeat>
                    </xf:select>
                </xf:group>
            </xf:group>
        </xf:case>
        <xf:case id="commentPanel" selected="false">
            <xf:label><!--Mots-clés et -->Commentaires</xf:label>
            <xf:group ref="xpr:description/xpr:analysis">
                <xf:label>Commentaires et première analyse</xf:label>
                <xf:textarea ref=".">
                    <xf:label>Passages intéressants</xf:label>
                </xf:textarea>
            </xf:group>
            <xf:group ref="xpr:description/xpr:noteworthy">
                <xf:label>Éléments remarquables</xf:label>
                <xf:textarea ref=".">
                    <xf:label/>
                </xf:textarea>
            </xf:group>
            <xf:trigger bind="addComment">
                <xf:label>Ajouter un commentaire sur ce formulaire</xf:label>
                <xf:action ev:event="DOMActivate">
                    <xf:insert context="instance('xprExpertise')" origin="instance('xprExpertiseComment')" nodeset="xpr:description" position="after"/>
                </xf:action>
                <xf:help>Ajouter un commentaire sur ce formulaire.</xf:help>
            </xf:trigger>
            <xf:group ref="xpr:comment">
                <xf:label>Commentaire sur ce formulaire</xf:label>
                <xf:textarea ref=".">
                    <xf:label/>
                </xf:textarea>
                <xf:trigger class="delete">
                    <xf:label>&#10007;</xf:label>
                    <xf:delete nodeset="." at="1" ev:event="DOMActivate"/>
                    <xf:help>Supprimer le commentaire.</xf:help>
                </xf:trigger>
            </xf:group>
        </xf:case>
    </xf:switch>
    <span id="keywordsControl" class="keywords">
        <span class="closeKeywords" onclick="closeKeywords()">&#10007;</span>
        <h2>Mots-clefs</h2>
        <xf:group ref="xpr:description">
            <xf:repeat nodeset="xpr:keywords">
                <xf:var name="group" value="."/>
                <xf:label>
                    <span>
                        <xf:output value="instance('xprExpertiseIndex')/xpr:group[@type=$group/@group]/xpr:label"/>
                    </span>
                </xf:label>
                <xf:select ref="." appearance="full">
                    <xf:itemset nodeset="instance('xprExpertiseIndex')/xpr:group[@type=$group/@group]/xpr:term">
                        <xf:label ref="."/>
                        <xf:copy ref="."/>
                    </xf:itemset>
                </xf:select>
            </xf:repeat>
        </xf:group>
    </span>
    <span class="save">
        <xf:select1 ref="instance('xprExpertise')/xpr:control/xpr:localControl/xpr:term" appearance="full" incremental="true">
            <xf:label>
                <span>Statut</span>
            </xf:label>
            <xf:item>
                <xf:label>En cours</xf:label>
                <xf:value>in progress</xf:value>
            </xf:item>
            <xf:item>
                <xf:label>À revoir</xf:label>
                <xf:value>to revise</xf:value>
            </xf:item>
            <xf:item>
                <xf:label>Terminée</xf:label>
                <xf:value>completed</xf:value>
            </xf:item>
        </xf:select1>
        <xf:dialog id="control">
            <xf:group ref="xpr:control/xpr:maintenanceHistory/xpr:maintenanceEvent[1]">
                <xf:input ref="xpr:eventDescription">
                    <xf:label>Motif de la révision</xf:label>
                </xf:input>
            </xf:group>
            <xf:trigger>
                <xf:label>Annuler</xf:label>
                <xf:hide ev:event="DOMActivate" dialog="control"/>
            </xf:trigger>
            <xf:submit submission="submit">
                <xf:show dialog="waitingMessage"/>
                <xf:label>Enregistrer</xf:label>
            </xf:submit>
        </xf:dialog>
        <xf:trigger>
            <xf:label>Enregistrer</xf:label>
            <xf:action if="/xpr:expertise/@xml:id" ev:event="DOMActivate">
                <xf:show dialog="control"/>
            </xf:action>
            <xf:action if="not(/xpr:expertise/@xml:id)" ev:event="DOMActivate">
                <xf:show dialog="waitingMessage"/>
                <xf:send submission="submit"/>
            </xf:action>
        </xf:trigger>
        <xf:dialog id="waitingMessage">Enregistrement en cours.</xf:dialog>
    </span>
</form>
