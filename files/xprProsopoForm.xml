<form xmlns:xf="http://www.w3.org/2002/xforms" xmlns:ev="http://www.w3.org/2001/xml-events">
    <xf:switch>
        <xf:case id="prosopoPanel" selected="true">
            <!-- identity -->
            <xf:group ref="instance('xprProsopo')/eac:cpfDescription/eac:identity">
                <xf:label>Identité</xf:label>
                <xf:select1 bind="entityType" appearance="full">
                    <xf:label>Type d'entité</xf:label>
                    <xf:item>
                        <xf:label>personne</xf:label>
                        <xf:value>person</xf:value>
                        <xf:action ev:event="xforms-select">
                            <xf:setvalue ref="instance('xprProsopo')/eac:cpfDescription/eac:identity/@localType" value="''"/>
                            <xf:delete ref="instance('xprProsopo')/eac:cpfDescription/eac:identity/eac:nameEntry[child::eac:alternativeForm]"/>
                            <xf:insert context="instance('xprProsopo')/eac:cpfDescription/eac:identity" origin="instance('xprProsopoCopy')/eac:cpfDescription/eac:identity/eac:nameEntry[eac:alternativeForm]" nodeset="eac:nameEntry[eac:authorizedForm]" position="after"/>
<!--                            <xf:delete ref="instance('xprProsopo')/eac:cpfDescription/eac:identity/eac:nameEntry[child::eac:alternativeForm]//eac:part[@localType='officeName']"/>-->
                        </xf:action>
                    </xf:item>
                    <xf:item>
                        <xf:label>office</xf:label>
                        <xf:value>corporateBody</xf:value>
                        <xf:action ev:event="xforms-select">
                            <xf:setvalue ref="instance('xprProsopo')/eac:cpfDescription/eac:identity/@localType" value="''"/>
                            <xf:delete ref="instance('xprProsopo')/eac:cpfDescription/eac:identity/eac:nameEntry[child::eac:alternativeForm]"/>
                            <xf:insert context="instance('xprProsopo')/eac:cpfDescription/eac:identity" origin="instance('xprProsopoCopy')/eac:cpfDescription/eac:identity/eac:nameEntry[eac:alternativeForm]" nodeset="eac:nameEntry[eac:authorizedForm]" position="after"/>
<!--                            <xf:delete ref="instance('xprProsopo')/eac:cpfDescription/eac:identity/eac:nameEntry[child::eac:alternativeForm]//eac:part[not(@localType='officeName')]"/>-->
                        </xf:action>
                    </xf:item>
                    <xf:item>
                        <xf:label>famille</xf:label>
                        <xf:value>family</xf:value>
                        <xf:action ev:event="xforms-select">
                            <xf:setvalue ref="instance('xprProsopo')/eac:cpfDescription/eac:identity/@localType" value="'family'"/>
                            <xf:delete ref="instance('xprProsopo')/eac:cpfDescription/eac:identity/eac:nameEntry[child::eac:alternativeForm]"/>
                            <xf:insert context="instance('xprProsopo')/eac:cpfDescription/eac:identity" origin="instance('xprProsopoCopy')/eac:cpfDescription/eac:identity/eac:nameEntry[eac:alternativeForm]" nodeset="eac:nameEntry[eac:authorizedForm]" at="last()" position="after"/>
<!--                            <xf:delete ref="instance('xprProsopo')/eac:cpfDescription/eac:identity/eac:nameEntry[child::eac:alternativeForm]//eac:part[not(@localType='surname')]"/>-->
                        </xf:action>
                    </xf:item>
                </xf:select1>
                <xf:select1 ref="@localType" appearance="full">
                    <xf:label>Répertoire</xf:label>
                    <xf:itemset model="prosopo" nodeset="instance('xprEntitiesTypes')/xpr:identity[@type = instance('xprProsopo')//eac:entityType]">
                        <xf:label ref="xpr:label"/>
                        <xf:value ref="xpr:value"/>
                    </xf:itemset>
                </xf:select1>
                <xf:group>
                    <xf:label>Forme(s) du nom</xf:label>
                    <xf:repeat id="repeatName" nodeset="eac:nameEntry[child::eac:alternativeForm]" appearance="full">
                        <xf:label>Forme attestée</xf:label>
                        <xf:repeat id="namePart" nodeset="eac:part" appearance="full">
                            <xf:input ref=".">
                                <xf:label>Composante du nom</xf:label>
                            </xf:input>
                            <xf:select1 ref="@localType">
                                <xf:label>Type de composante</xf:label>
                                <xf:item>
                                    <xf:label>Nom</xf:label>
                                    <xf:value>surname</xf:value>
                                </xf:item>
                                <xf:item>
                                    <xf:label>Prénom</xf:label>
                                    <xf:value>forename</xf:value>
                                </xf:item>
                                <xf:item>
                                    <xf:label>Particule</xf:label>
                                    <xf:value>particle</xf:value>
                                </xf:item>
                                <xf:item>
                                    <xf:label>Titre d’appel</xf:label>
                                    <xf:value>common</xf:value>
                                </xf:item>
                                <xf:item>
                                    <xf:label>Titre académique</xf:label>
                                    <xf:value>academic</xf:value>
                                </xf:item>
                                <xf:item>
                                    <xf:label>Titre religieux</xf:label>
                                    <xf:value>religious</xf:value>
                                </xf:item>
                                <xf:item>
                                    <xf:label>Titre de noblesse</xf:label>
                                    <xf:value>nobiliary</xf:value>
                                </xf:item>
                                <xf:item>
                                    <xf:label>Dénomination</xf:label>
                                    <xf:value>officeName</xf:value>
                                </xf:item>
                            </xf:select1>
                            <xf:trigger class="delete">
                                <xf:label>Supprimer une composante du nom</xf:label>
                                <xf:delete ev:event="DOMActivate" nodeset="." if="count(parent::eac:nameEntry/eac:part) > 1"/>
                            </xf:trigger>
                        </xf:repeat>
                        <xf:trigger class="insert">
                            <xf:label>Insérer une nouvelle composante du nom</xf:label>
                            <xf:insert ev:event="DOMActivate" origin="instance('xprProsopoCopy')/eac:cpfDescription/eac:identity/eac:nameEntry[child::eac:alternativeForm]/eac:part" context="instance('xprProsopo')/eac:cpfDescription/eac:identity/eac:nameEntry[child::eac:alternativeForm][index('repeatName')]" nodeset="eac:part" at="index('namePart')" position="after"/>
                        </xf:trigger>
                        <xf:group>
                            <xf:label>Sources</xf:label>
                            <!--<xf:repeat id="repeatNameSource" nodeset="xpr:source">
                                <xf:var name="source" value="."/>
                                <xf:label>Source</xf:label>
                                <xf:group ref="@xlink:href[.!='' and .=instance('xprSources')/xpr:source[@localType='new']/@xml:id]">
                                    <xf:trigger>
                                        <xf:label>Sélectionner une source dans la base</xf:label>
                                        <xf:setvalue ref="." value="''" ev:event="DOMActivate"/>
                                    </xf:trigger>
                                </xf:group>
                                <xf:group ref="@xlink:href[.='' or . = instance('xprSources')/xpr:source[not(@localType='new')]]">
                                    <xf:trigger>
                                        <xf:label>Ajouter une nouvelle source</xf:label>
                                        <xf:insert context="instance('xprSources')" origin="instance('xprNewEntries')/xpr:source" nodeset="xpr:source[1]" position="before" ev:event="DOMActivate"/>
                                        &lt;!&ndash; set a temporary xml:id value for added source &ndash;&gt;
                                        <xf:setvalue ref=".
                                                    | instance('xprSources')/xpr:source[@localType = 'new'][@xml:id = '']/@xml:id"
                                                     value="concat('local-id-source', number(count(instance('xprSources')//*:source[@localType='new'])))"
                                                     ev:event="DOMActivate"/>
                                    </xf:trigger>
                                    <xf:select1 ref="." incremental="true">
                                        <xf:itemset model="source" nodeset="instance('xprSources')/xpr:source">
                                            <xf:label ref="."/>
                                            <xf:value ref="choose(@xml:id, @xml:id, .)"/>
                                        </xf:itemset>
                                    </xf:select1>
                                </xf:group>
                                <xf:group ref="instance('xprSources')/xpr:source[@localType='new'][@xml:id = $source/@xlink:href]">
                                    <xf:label>Nouvelle source</xf:label>
                                    <xf:input ref="." incremental="true">
                                        <xf:label>Source</xf:label>
                                    </xf:input>
                                </xf:group>
                                <xf:input ref=".">
                                    <xf:label>commentaire</xf:label>
                                </xf:input>
                                <xf:trigger ref="." class="delete">
                                    <xf:label>Supprimer une source</xf:label>
                                    <xf:delete nodeset="." at="1" if="count(ancestor::eac:nameEntry/xpr:source) &gt; 1" ev:event="DOMActivate"/>
                                    <xf:help>Supprimer une source</xf:help>
                                </xf:trigger>
                            </xf:repeat>-->
                            <xf:repeat id="repeatNameSource" nodeset="xpr:source">
                                <xf:var name="source" value="."/>
                                <xf:label>Source</xf:label>
                                <xf:select1 ref="@xlink:href" incremental="true">
                                    <xf:itemset model="source" nodeset="instance('xprSources')/xpr:source">
                                        <xf:label ref="."/>
                                        <!--<xf:value ref="choose(@xml:id, @xml:id, .)"/>-->
                                        <xf:value value="concat('#', @xml:id)"/>
                                    </xf:itemset>
                                </xf:select1>
                                <xf:input ref=".">
                                    <xf:label>commentaire</xf:label>
                                </xf:input>
                                <xf:trigger ref="." class="delete">
                                    <xf:label>Supprimer une source</xf:label>
                                    <xf:delete nodeset="." at="1" if="count(ancestor::eac:nameEntry/xpr:source) &gt; 1" ev:event="DOMActivate"/>
                                    <xf:help>Supprimer une source</xf:help>
                                </xf:trigger>
                            </xf:repeat>
                            <xf:trigger class="insert">
                                <xf:label>Nouvelle source</xf:label>
                                <xf:action ev:event="DOMActivate">
                                    <xf:insert context="." origin="instance('xprProsopoCopy')/eac:cpfDescription/eac:identity/eac:nameEntry[eac:alternativeForm]/xpr:source" nodeset="xpr:source[last()]" position="after" ev:event="DOMActivate"/>
                                </xf:action>
                                <xf:help>Ajouter une source</xf:help>
                            </xf:trigger>
                        </xf:group>
                        <xf:trigger ref=".[eac:alternativeForm]">
                            <xf:label>Supprimer une forme du nom</xf:label>
                            <xf:delete nodeset="." at="1" if="count(instance('xprProsopo')/eac:cpfDescription/eac:identity/eac:nameEntry[child::eac:alternativeForm]) &gt; 1" ev:event="DOMActivate"/>
                            <xf:help>Supprimer une forme du nom</xf:help>
                        </xf:trigger>
                    </xf:repeat>
                    <xf:trigger ref=".[eac:nameEntry[eac:alternativeForm]]" class="insert">
                        <xf:label>Nouvelle forme attestée du nom</xf:label>
                        <xf:action ev:event="DOMActivate">
                            <xf:insert context="." origin="instance('xprProsopoCopy')/eac:cpfDescription/eac:identity/eac:nameEntry[eac:alternativeForm]" nodeset="eac:nameEntry[eac:alternativeForm][last()]" position="after" ev:event="DOMActivate"/>
                            <xf:delete if="eac:entityType = 'person'" ref="instance('xprProsopo')/eac:cpfDescription/eac:identity/eac:nameEntry[child::eac:alternativeForm]//eac:part[@localType='officeName']"/>
                            <xf:delete if="eac:entityType = 'corporateBody'" ref="instance('xprProsopo')/eac:cpfDescription/eac:identity/eac:nameEntry[child::eac:alternativeForm]//eac:part[not(@localType='officeName')]"/>
                            <xf:delete if="eac:entityType = 'family'" ref="instance('xprProsopo')/eac:cpfDescription/eac:identity/eac:nameEntry[child::eac:alternativeForm]//eac:part[not(@localType='surname')]"/>
                        </xf:action>
                        <xf:help>Ajouter une forme attestée du nom</xf:help>
                    </xf:trigger>
                    <xf:input ref="eac:nameEntry[child::eac:authorizedForm]/eac:part" incremental="true">
                        <xf:label>Forme contrôlée</xf:label>
                    </xf:input>
                    <xf:select1 ref="instance('xprIdentities')/eac:identity">
                        <xf:label>Établir la vedette à partir d'une forme attestée</xf:label>
                        <!-- @todo voir avec EC pour le détail, pour l'instant uniquement nom et prénom(s)-->
                        <xf:item>
                            <xf:label/>
                            <xf:value/>
                        </xf:item>
                        <!--
                        for xsltforms 1.5
                        replace xf:label into the itemset below with :
                        <xf:label><xf:output value="concat(
                                        if(instance('xprProsopo')/eac:cpfDescription/eac:identity/eac:entityType[. = 'person'], concat(eac:part[@localType='surname'], ', ', eac:part[@localType='forename'], ' (', if(instance('xprProsopo')/eac:cpfDescription/eac:description/eac:existDates/eac:dateRange/eac:fromDate/@*[not(. = '')], substring(instance('xprProsopo')/eac:cpfDescription/eac:description/eac:existDates/eac:dateRange/eac:fromDate/@*[not(. = '')], 1, 4), '?'), ' - ', if(instance('xprProsopo')/eac:cpfDescription/eac:description/eac:existDates/eac:dateRange/eac:toDate/@*[not(. = '')], substring(instance('xprProsopo')/eac:cpfDescription/eac:description/eac:existDates/eac:dateRange/eac:toDate/@*[not(. = '')], 1, 4), '?'), ')'), ''),
                                        if(instance('xprProsopo')/eac:cpfDescription/eac:identity/eac:entityType[. = 'corporateBody'], concat(eac:part[@localType='officeName'], ''), ''),
                                        if(instance('xprProsopo')/eac:cpfDescription/eac:identity/eac:entityType[. = 'family'], concat(eac:part[@localType='surname'], ''), ''))"/></xf:label>
                        -->
                        <xf:itemset model="prosopo" nodeset="instance('xprProsopo')/eac:cpfDescription/eac:identity/eac:nameEntry[child::eac:alternativeForm]">

                            <xf:label value="concat(
                                        if(instance('xprProsopo')/eac:cpfDescription/eac:identity/eac:entityType[. = 'person'], concat(eac:part[@localType='surname'], ', ', eac:part[@localType='forename'], ' (', if(instance('xprProsopo')/eac:cpfDescription/eac:description/eac:existDates/eac:dateRange/eac:fromDate/@*[not(. = '')], substring(instance('xprProsopo')/eac:cpfDescription/eac:description/eac:existDates/eac:dateRange/eac:fromDate/@*[not(. = '')], 1, 4), '?'), ' - ', if(instance('xprProsopo')/eac:cpfDescription/eac:description/eac:existDates/eac:dateRange/eac:toDate/@*[not(. = '')], substring(instance('xprProsopo')/eac:cpfDescription/eac:description/eac:existDates/eac:dateRange/eac:toDate/@*[not(. = '')], 1, 4), '?'), ')'), ''),
                                        if(instance('xprProsopo')/eac:cpfDescription/eac:identity/eac:entityType[. = 'corporateBody'], concat(eac:part[@localType='officeName'], ''), ''),
                                        if(instance('xprProsopo')/eac:cpfDescription/eac:identity/eac:entityType[. = 'family'], concat(eac:part[@localType='surname'], ''), ''))"/>
                            <xf:copy ref="."/>
                        </xf:itemset>
                        <xf:action ev:event="xforms-value-changed" if="instance('xprIdentities')/eac:identity/*:nameEntry//*:part[not(. = '')]">
                            <!-- @rmq lors de la copie le préfixe de l'espace de nom saute => utilisation de '*:element' -->
                            <!--
                                @rmq pour récupérer toutes les valeurs, faire une boucle while
                                avec une itération (faire une instance('xprIterator') pour boucler
                                sur eac:part qui ne sont pas vides et trouver leur position
                            -->
                            <xf:setvalue ref="instance('xprProsopo')/eac:cpfDescription/eac:identity/eac:nameEntry[child::eac:authorizedForm]/eac:part" value="concat(
                                if(instance('xprProsopo')/eac:cpfDescription/eac:identity/eac:entityType[. = 'person'], concat(instance('xprIdentities')/eac:identity/*:nameEntry/*:part[@localType='surname'], ', ', instance('xprIdentities')/eac:identity/*:nameEntry/*:part[@localType='forename'], ' (', if(instance('xprProsopo')/eac:cpfDescription/eac:description/eac:existDates/eac:dateRange/eac:fromDate/@*[not(. = '')], substring(instance('xprProsopo')/eac:cpfDescription/eac:description/eac:existDates/eac:dateRange/eac:fromDate/@*[not(. = '')], 1, 4), '?'), ' - ', if(instance('xprProsopo')/eac:cpfDescription/eac:description/eac:existDates/eac:dateRange/eac:toDate/@*[not(. = '')], substring(instance('xprProsopo')/eac:cpfDescription/eac:description/eac:existDates/eac:dateRange/eac:toDate/@*[not(. = '')], 1, 4), '?'), ')'), ''),
                                if(instance('xprProsopo')/eac:cpfDescription/eac:identity/eac:entityType[. = 'corporateBody'], concat(instance('xprIdentities')/eac:identity/*:nameEntry/*:part[@localType='officeName'], ''), ''),
                                if(instance('xprProsopo')/eac:cpfDescription/eac:identity/eac:entityType[. = 'family'], concat(instance('xprIdentities')/eac:identity/*:nameEntry/*:part[@localType='surname'], ''), '')
                                )"/>
                            <xf:refresh/>
                        </xf:action>
                    </xf:select1>
                </xf:group>
            </xf:group>
            <xf:group ref="instance('xprProsopo')/eac:cpfDescription/eac:description/eac:existDates/eac:dateRange">
                <xf:label>Existence</xf:label>
                <xf:group ref="eac:fromDate">
                    <xf:label>Naissance</xf:label>
                    <xf:input ref="@standardDate">
                        <xf:label>Certaine</xf:label>
                    </xf:input>
                    <xf:input ref="@notAfter">
                        <xf:label>Avant le</xf:label>
                    </xf:input>
                    <xf:input ref="@notBefore">
                        <xf:label>Après le</xf:label>
                    </xf:input>
                </xf:group>
                <xf:group ref="eac:toDate">
                    <xf:label>Décès</xf:label>
                    <xf:input ref="@standardDate">
                        <xf:label>Certaine</xf:label>
                    </xf:input>
                    <xf:input ref="@notAfter">
                        <xf:label>Avant le</xf:label>
                    </xf:input>
                    <xf:input ref="@notBefore">
                        <xf:label>Après le</xf:label>
                    </xf:input>
                </xf:group>
            </xf:group>
            <xf:group ref="instance('xprProsopo')/eac:cpfDescription[eac:identity/eac:entityType = 'person']/eac:description/eac:localDescription[@localType='sex']">
                <xf:select1 ref="eac:term">
                    <xf:label>Sexe</xf:label>
                    <!-- @q° français ou anglais ?
                        penser à modifier dans newEntity + IAD
                    -->
                    <xf:item>
                        <xf:label>Homme</xf:label>
                        <xf:value>male</xf:value>
                    </xf:item>
                    <xf:item>
                        <xf:label>Femme</xf:label>
                        <xf:value>female</xf:value>
                    </xf:item>
                </xf:select1>
            </xf:group>
            <xf:group ref="instance('xprProsopo')/eac:cpfDescription/eac:description/eac:places">
                <xf:label>Adresses</xf:label>
                <xf:repeat id="repeatPlace" nodeset="eac:place">
                    <xf:label>Adresse</xf:label>
                    <xf:input ref="eac:placeEntry">
                        <xf:label>Intitulé</xf:label>
                    </xf:input>
                    <xf:group ref="eac:dateSet">
                        <xf:repeat id="repeatPlaceDate" nodeset="*">
                            <xf:label>Date</xf:label>
                            <xf:trigger>
                                <xf:label>
                                    <xf:output value="if(.[self::eac:date], 'Intervalle', 'Date Unique')"/>
                                </xf:label>
                                <xf:action ev:event="DOMActivate" if="self::eac:date">
                                    <xf:insert context="ancestor::eac:dateSet" origin="instance('xprProsopoCopy')/eac:cpfDescription/eac:description/eac:existDates/eac:dateRange" nodeset="*[index('repeatPlaceDate')]" position="after"/>
                                    <xf:insert context="following-sibling::*[self::eac:dateRange][1]" origin="instance('xprProsopoCopy')/eac:cpfDescription/eac:description/eac:places/eac:place/eac:dateSet/eac:date/xpr:source" nodeset="eac:toDate" position="after"/>
                                    <xf:setvalue ref="following-sibling::eac:dateRange[1]/xpr:source/@xlink:href" value="current()/xpr:source/@xlink:href"/>
                                    <xf:setvalue ref="following-sibling::eac:dateRange[1]/xpr:source" value="current()/xpr:source"/>
                                    <xf:setvalue ref="following-sibling::eac:dateRange[1]/eac:fromDate/@standardDate" value="current()/@standardDate"/>
                                    <xf:setvalue ref="following-sibling::eac:dateRange[1]/eac:fromDate/@notAfter" value="current()/@notAfter"/>
                                    <xf:setvalue ref="following-sibling::eac:dateRange[1]/eac:fromDate/@notBefore" value="current()/@notBefore"/>
                                    <xf:delete nodeset="."/>
                                </xf:action>
                                <xf:action ev:event="DOMActivate" if="self::eac:dateRange">
                                    <xf:insert context="ancestor::eac:dateSet" origin="instance('xprProsopoCopy')/eac:cpfDescription/eac:description/eac:places/eac:place/eac:dateSet/eac:date" nodeset="*[index('repeatPlaceDate')]" position="after"/>
                                    <xf:setvalue ref="./following-sibling::eac:date[1]/xpr:source/@xlink:href" value="current()/xpr:source/@xlink:href"/>
                                    <xf:setvalue ref="./following-sibling::eac:date[1]/xpr:source" value="current()/xpr:source"/>
                                    <xf:setvalue ref="./following-sibling::eac:date[1]/@standardDate" value="current()/eac:fromDate/@standardDate"/>
                                    <xf:setvalue ref="./following-sibling::eac:date[1]/@notAfter" value="current()/eac:fromDate/@notAfter"/>
                                    <xf:setvalue ref="./following-sibling::eac:date[1]/@notBefore" value="current()/eac:fromDate/@notBefore"/>
                                    <xf:delete nodeset="."/>
                                </xf:action>
                            </xf:trigger>
                            <xf:group>
                                <xf:input ref="@standardDate | eac:fromDate/@standardDate">
                                    <xf:label>Certaine</xf:label>
                                </xf:input>
                                <xf:input ref="@notAfter | eac:fromDate/@notAfter">
                                    <xf:label>Avant le</xf:label>
                                </xf:input>
                                <xf:input ref="@notBefore | eac:fromDate/@notBefore">
                                    <xf:label>Après le</xf:label>
                                </xf:input>
                            </xf:group>
                            <xf:group ref="eac:toDate">
                                <xf:input ref="@standardDate">
                                    <xf:label>Certaine</xf:label>
                                </xf:input>
                                <xf:input ref="@notAfter">
                                    <xf:label>Avant le</xf:label>
                                </xf:input>
                                <xf:input ref="@notBefore">
                                    <xf:label>Après le</xf:label>
                                </xf:input>
                            </xf:group>
                            <xf:group>
                                <xf:label>Sources</xf:label>
                                <!--<xf:repeat id="repeatPlaceSource" nodeset="xpr:source">
                                    <xf:var name="source" value="."/>
                                    <xf:label>Source</xf:label>
                                    <xf:group ref="@xlink:href[.!='' and .=instance('xprSources')/xpr:source[@localType='new']/@xml:id]">
                                        <xf:trigger>
                                            <xf:label>Sélectionner une source dans la base</xf:label>
                                            <xf:setvalue ref="." value="''" ev:event="DOMActivate"/>
                                        </xf:trigger>
                                    </xf:group>
                                    <xf:group ref="@xlink:href[.='' or . = instance('xprSources')/xpr:source[not(@localType='new')]]">
                                        <xf:trigger>
                                            <xf:label>Ajouter une nouvelle source</xf:label>
                                            <xf:insert context="instance('xprSources')" origin="instance('xprNewEntries')/xpr:source" nodeset="xpr:source[1]" position="before" ev:event="DOMActivate"/>
                                            &lt;!&ndash; set a temporary xml:id value for added source &ndash;&gt;
                                            <xf:setvalue ref=".
                                                            | instance('xprSources')/xpr:source[@localType = 'new'][@xml:id = '']/@xml:id"
                                                         value="concat('local-id-source', number(count(instance('xprSources')//*:source[@localType='new'])))"
                                                         ev:event="DOMActivate"/>
                                        </xf:trigger>
                                        <xf:select1 ref="." incremental="true">
                                            <xf:itemset model="source" nodeset="instance('xprSources')/xpr:source">
                                                <xf:label ref="."/>
                                                <xf:value ref="choose(@xml:id, @xml:id, .)"/>
                                            </xf:itemset>
                                        </xf:select1>
                                    </xf:group>
                                    <xf:group ref="instance('xprSources')/xpr:source[@localType='new'][@xml:id = $source/@xlink:href]">
                                        <xf:label>Nouvelle source</xf:label>
                                        <xf:input ref="." incremental="true">
                                            <xf:label>Source</xf:label>
                                        </xf:input>
                                    </xf:group>
                                    <xf:input ref=".">
                                        <xf:label>commentaire</xf:label>
                                    </xf:input>
                                    <xf:trigger ref="." class="delete">
                                        <xf:label>Supprimer une source</xf:label>
                                        <xf:delete nodeset="." at="1" if="count(ancestor::eac:nameEntry/xpr:source) &gt; 1" ev:event="DOMActivate"/>
                                        <xf:help>Supprimer une source</xf:help>
                                    </xf:trigger>
                                </xf:repeat>-->
                                <xf:repeat id="repeatPlaceSource" nodeset="xpr:source">
                                    <xf:var name="source" value="."/>
                                    <xf:label>Source</xf:label>
                                    <xf:select1 ref="@xlink:href" incremental="true">
                                        <xf:itemset model="source" nodeset="instance('xprSources')/xpr:source">
                                            <xf:label ref="."/>
                                            <!--<xf:value ref="choose(@xml:id, @xml:id, .)"/>-->
                                            <xf:value value="concat('#', @xml:id)"/>
                                        </xf:itemset>
                                    </xf:select1>
                                    <xf:input ref=".">
                                        <xf:label>commentaire</xf:label>
                                    </xf:input>
                                    <xf:trigger ref="." class="delete">
                                        <xf:label>Supprimer une source</xf:label>
                                        <xf:delete nodeset="." at="1" if="count(ancestor::eac:nameEntry/xpr:source) &gt; 1" ev:event="DOMActivate"/>
                                        <xf:help>Supprimer une source</xf:help>
                                    </xf:trigger>
                                </xf:repeat>
                                <xf:trigger class="insert">
                                    <xf:label>Nouvelle source</xf:label>
                                    <xf:action ev:event="DOMActivate">
                                        <xf:insert context="." origin="instance('xprProsopoCopy')/eac:cpfDescription/eac:description/eac:places/eac:place/eac:dateSet/eac:date/xpr:source" nodeset="xpr:source[last()]" position="after" ev:event="DOMActivate"/>
                                    </xf:action>
                                    <xf:help>Ajouter une source</xf:help>
                                </xf:trigger>
                            </xf:group>
                            <xf:trigger class="delete">
                                <xf:label>Supprimer une date</xf:label>
                                <xf:delete nodeset="." at="1" if="count(ancestor::eac:dateSet/*) > 1" ev:event="DOMActivate"/>
                                <xf:help>Supprimer une date</xf:help>
                            </xf:trigger>
                        </xf:repeat>
                        <xf:trigger class="insert">
                            <xf:label>Ajouter une date</xf:label>
                            <xf:action ev:event="DOMActivate">
                                <xf:insert context="." origin="instance('xprProsopoCopy')/eac:cpfDescription/eac:description/eac:places/eac:place/eac:dateSet/eac:date" nodeset="*[last()]" position="after" ev:event="DOMActivate"/>
                            </xf:action>
                            <xf:help>Ajouter une date</xf:help>
                        </xf:trigger>
                    </xf:group>
                    <xf:input ref="eac:descriptiveNote">
                        <xf:label>Note</xf:label>
                    </xf:input>
                    <xf:trigger class="delete">
                        <xf:label>Supprimer un lieu</xf:label>
                        <xf:delete nodeset="." at="1" if="count(instance('xprProsopo')/eac:cpfDescription/eac:description/eac:places/eac:place) > 1" ev:event="DOMActivate"/>
                        <xf:help>Supprimer un lieu</xf:help>
                    </xf:trigger>
                </xf:repeat>
                <xf:trigger class="insert">
                    <xf:label>Ajouter un lieu</xf:label>
                    <xf:action ev:event="DOMActivate">
                        <xf:insert context="." origin="instance('xprProsopoCopy')/eac:cpfDescription/eac:description/eac:places/eac:place" nodeset="eac:place[last()]" position="after" ev:event="DOMActivate"/>
                    </xf:action>
                    <xf:help>Ajouter un lieu</xf:help>
                </xf:trigger>
            </xf:group>
            <xf:group ref="instance('xprProsopo')/eac:cpfDescription/eac:description/eac:functions">
                <xf:label>Fonctions</xf:label>
                <xf:repeat id="repeatFunction" nodeset="eac:function">
                    <xf:input ref="eac:term">
                        <xf:label>Intitulé</xf:label>
                    </xf:input>
                    <xf:group ref="eac:date">
                        <xf:label>Date</xf:label>
                        <xf:trigger>
                            <xf:label>Intervalle</xf:label>
                            <xf:action ev:event="DOMActivate" if="self::eac:date">
                                <xf:insert context="ancestor::eac:function" origin="instance('xprProsopoCopy')/eac:cpfDescription/eac:description/eac:existDates/eac:dateRange" nodeset="eac:term" position="after"/>
                                <xf:setvalue ref="./ancestor::eac:function/eac:dateRange/eac:fromDate/@standardDate" value="current()/@standardDate"/>
                                <xf:setvalue ref="./ancestor::eac:function/eac:dateRange/eac:fromDate/@notAfter" value="current()/@notAfter"/>
                                <xf:setvalue ref="./ancestor::eac:function/eac:dateRange/eac:fromDate/@notBefore" value="current()/@notBefore"/>
                                <xf:delete nodeset="."/>
                            </xf:action>
                        </xf:trigger>
                        <xf:input ref="@standardDate">
                            <xf:label>Certaine</xf:label>
                        </xf:input>
                        <xf:input ref="@notAfter">
                            <xf:label>Avant le</xf:label>
                        </xf:input>
                        <xf:input ref="@notBefore">
                            <xf:label>Après le</xf:label>
                        </xf:input>
                    </xf:group>
                    <xf:group ref="eac:dateRange">
                        <xf:label>Intervalle</xf:label>
                        <xf:trigger>
                            <xf:label>Date unique</xf:label>
                            <xf:action ev:event="DOMActivate" if="self::eac:dateRange">
                                <xf:insert context="ancestor::eac:function" origin="instance('xprProsopoCopy')/eac:cpfDescription/eac:description/eac:functions/eac:function/eac:date" nodeset="eac:term" position="after"/>
                                <xf:setvalue ref="./ancestor::eac:function/eac:date/@standardDate" value="current()/eac:fromDate/@standardDate"/>
                                <xf:setvalue ref="./ancestor::eac:function/eac:date/@notAfter" value="current()/eac:fromDate/@notAfter"/>
                                <xf:setvalue ref="./ancestor::eac:function/eac:date/@notBefore" value="current()/eac:fromDate/@notBefore"/>
                                <xf:delete nodeset="."/>
                            </xf:action>
                        </xf:trigger>
                        <xf:group ref="eac:fromDate">
                            <xf:label>Début</xf:label>
                            <xf:input ref="@standardDate">
                                <xf:label>Certaine</xf:label>
                            </xf:input>
                            <xf:input ref="@notAfter">
                                <xf:label>Avant le</xf:label>
                            </xf:input>
                            <xf:input ref="@notBefore">
                                <xf:label>Après le</xf:label>
                            </xf:input>
                        </xf:group>
                        <xf:group ref="eac:toDate">
                            <xf:label>Fin</xf:label>
                            <xf:input ref="@standardDate">
                                <xf:label>Certaine</xf:label>
                            </xf:input>
                            <xf:input ref="@notAfter">
                                <xf:label>Avant le</xf:label>
                            </xf:input>
                            <xf:input ref="@notBefore">
                                <xf:label>Après le</xf:label>
                            </xf:input>
                        </xf:group>
                    </xf:group>
                    <xf:input ref="eac:descriptiveNote">
                        <xf:label>Note</xf:label>
                    </xf:input>
                    <xf:group>
                        <xf:label>Sources</xf:label>
                        <!--<xf:repeat id="repeatFunctionSource" nodeset="xpr:source">
                            <xf:var name="source" value="."/>
                            <xf:label>Source</xf:label>
                            <xf:group ref="@xlink:href[.!='' and .=instance('xprSources')/xpr:source[@localType='new']/@xml:id]">
                                <xf:trigger>
                                    <xf:label>Sélectionner une source dans la base</xf:label>
                                    <xf:setvalue ref="." value="''" ev:event="DOMActivate"/>
                                </xf:trigger>
                            </xf:group>
                            <xf:group ref="@xlink:href[.='' or . = instance('xprSources')/xpr:source[not(@localType='new')]]">
                                <xf:trigger>
                                    <xf:label>Ajouter une nouvelle source</xf:label>
                                    <xf:insert context="instance('xprSources')" origin="instance('xprNewEntries')/xpr:source" nodeset="xpr:source[1]" position="before" ev:event="DOMActivate"/>
                                    &lt;!&ndash; set a temporary xml:id value for added source &ndash;&gt;
                                    <xf:setvalue ref=".
                                                    | instance('xprSources')/xpr:source[@localType = 'new'][@xml:id = '']/@xml:id"
                                                 value="concat('local-id-source', number(count(instance('xprSources')//*:source[@localType='new'])))"
                                                 ev:event="DOMActivate"/>
                                </xf:trigger>
                                <xf:select1 ref="." incremental="true">
                                    <xf:itemset model="source" nodeset="instance('xprSources')/xpr:source">
                                        <xf:label ref="."/>
                                        <xf:value ref="choose(@xml:id, @xml:id, .)"/>
                                    </xf:itemset>
                                </xf:select1>
                            </xf:group>
                            <xf:group ref="instance('xprSources')/xpr:source[@localType='new'][@xml:id = $source/@xlink:href]">
                                <xf:label>Nouvelle source</xf:label>
                                <xf:input ref="." incremental="true">
                                    <xf:label>Source</xf:label>
                                </xf:input>
                            </xf:group>
                            <xf:input ref=".">
                                <xf:label>commentaire</xf:label>
                            </xf:input>
                            <xf:trigger ref="." class="delete">
                                <xf:label>Supprimer une source</xf:label>
                                <xf:delete nodeset="." at="1" if="count(ancestor::eac:nameEntry/xpr:source) &gt; 1" ev:event="DOMActivate"/>
                                <xf:help>Supprimer une source</xf:help>
                            </xf:trigger>
                        </xf:repeat>-->
                        <xf:repeat id="repeatFunctionSource" nodeset="xpr:source">
                            <xf:var name="source" value="."/>
                            <xf:label>Source</xf:label>
                            <xf:select1 ref="@xlink:href" incremental="true">
                                <xf:itemset model="source" nodeset="instance('xprSources')/xpr:source">
                                    <xf:label ref="."/>
                                    <!--<xf:value ref="choose(@xml:id, @xml:id, .)"/>-->
                                    <xf:value value="concat('#', @xml:id)"/>
                                </xf:itemset>
                            </xf:select1>
                            <xf:input ref=".">
                                <xf:label>commentaire</xf:label>
                            </xf:input>
                            <xf:trigger ref="." class="delete">
                                <xf:label>Supprimer une source</xf:label>
                                <xf:delete nodeset="." at="1" if="count(ancestor::eac:nameEntry/xpr:source) &gt; 1" ev:event="DOMActivate"/>
                                <xf:help>Supprimer une source</xf:help>
                            </xf:trigger>
                        </xf:repeat>
                        <xf:trigger class="insert">
                            <xf:label>Nouvelle source</xf:label>
                            <xf:action ev:event="DOMActivate">
                                <xf:insert context="." origin="instance('xprProsopoCopy')/eac:cpfDescription/eac:description/eac:functions/eac:function/xpr:source" nodeset="xpr:source[last()]" position="after" ev:event="DOMActivate"/>
                            </xf:action>
                            <xf:help>Ajouter une source</xf:help>
                        </xf:trigger>
                    </xf:group>
                    <xf:trigger class="delete">
                        <xf:label>Supprimer une fonction</xf:label>
                        <xf:delete nodeset="." at="1" if="count(instance('xprProsopo')/eac:cpfDescription/eac:description/eac:functions/eac:function) > 1" ev:event="DOMActivate"/>
                        <xf:help>Supprimer une fonction</xf:help>
                    </xf:trigger>
                </xf:repeat>
                <xf:trigger class="insert">
                    <xf:label>Ajouter une fonction</xf:label>
                    <xf:action ev:event="DOMActivate">
                        <xf:insert context="." origin="instance('xprProsopoCopy')/eac:cpfDescription/eac:description/eac:functions/eac:function" nodeset="eac:function[last()]" position="after" ev:event="DOMActivate"/>
                    </xf:action>
                    <xf:help>Ajouter une fonction</xf:help>
                </xf:trigger>
            </xf:group>
            <xf:group ref="instance('xprProsopo')/eac:cpfDescription/eac:description/eac:occupations">
                <xf:label>Occupations</xf:label>
                <xf:repeat id="repeatOccupation" nodeset="eac:occupation">
                    <xf:input ref="eac:term">
                        <xf:label>Intitulé</xf:label>
                    </xf:input>
                    <xf:group ref="eac:date">
                        <xf:label>Date</xf:label>
                        <xf:trigger>
                            <xf:label>Intervalle</xf:label>
                            <xf:action ev:event="DOMActivate" if="self::eac:date">
                                <xf:insert context="ancestor::eac:occupation" origin="instance('xprProsopoCopy')/eac:cpfDescription/eac:description/eac:existDates/eac:dateRange" nodeset="eac:term" position="after"/>
                                <xf:setvalue ref="./ancestor::eac:occupation/eac:dateRange/eac:fromDate/@standardDate" value="current()/@standardDate"/>
                                <xf:setvalue ref="./ancestor::eac:occupation/eac:dateRange/eac:fromDate/@notAfter" value="current()/@notAfter"/>
                                <xf:setvalue ref="./ancestor::eac:occupation/eac:dateRange/eac:fromDate/@notBefore" value="current()/@notBefore"/>
                                <xf:delete nodeset="."/>
                            </xf:action>
                        </xf:trigger>
                        <xf:input ref="@standardDate">
                            <xf:label>Certaine</xf:label>
                        </xf:input>
                        <xf:input ref="@notAfter">
                            <xf:label>Avant le</xf:label>
                        </xf:input>
                        <xf:input ref="@notBefore">
                            <xf:label>Après le</xf:label>
                        </xf:input>
                    </xf:group>
                    <xf:group ref="eac:dateRange">
                        <xf:label>Intervalle</xf:label>
                        <xf:trigger>
                            <xf:label>Date unique</xf:label>
                            <xf:action ev:event="DOMActivate" if="self::eac:dateRange">
                                <xf:insert context="ancestor::eac:occupation" origin="instance('xprProsopoCopy')/eac:cpfDescription/eac:description/eac:occupations/eac:occupation/eac:date" nodeset="eac:term" position="after"/>
                                <xf:setvalue ref="./ancestor::eac:occupation/eac:date/@standardDate" value="current()/eac:fromDate/@standardDate"/>
                                <xf:setvalue ref="./ancestor::eac:occupation/eac:date/@notAfter" value="current()/eac:fromDate/@notAfter"/>
                                <xf:setvalue ref="./ancestor::eac:occupation/eac:date/@notBefore" value="current()/eac:fromDate/@notBefore"/>
                                <xf:delete nodeset="."/>
                            </xf:action>
                        </xf:trigger>
                        <xf:group ref="eac:fromDate">
                            <xf:label>Début</xf:label>
                            <xf:input ref="@standardDate">
                                <xf:label>Certaine</xf:label>
                            </xf:input>
                            <xf:input ref="@notAfter">
                                <xf:label>Avant le</xf:label>
                            </xf:input>
                            <xf:input ref="@notBefore">
                                <xf:label>Après le</xf:label>
                            </xf:input>
                        </xf:group>
                        <xf:group ref="eac:toDate">
                            <xf:label>Fin</xf:label>
                            <xf:input ref="@standardDate">
                                <xf:label>Certaine</xf:label>
                            </xf:input>
                            <xf:input ref="@notAfter">
                                <xf:label>Avant le</xf:label>
                            </xf:input>
                            <xf:input ref="@notBefore">
                                <xf:label>Après le</xf:label>
                            </xf:input>
                        </xf:group>
                    </xf:group>
                    <xf:input ref="eac:descriptiveNote">
                        <xf:label>Note</xf:label>
                    </xf:input>
                    <xf:group>
                        <xf:label>Sources</xf:label>
                        <!--<xf:repeat id="repeatOccupationSource" nodeset="xpr:source">
                            <xf:var name="source" value="."/>
                            <xf:label>Source</xf:label>
                            <xf:group ref="@xlink:href[.!='' and .=instance('xprSources')/xpr:source[@localType='new']/@xml:id]">
                                <xf:trigger>
                                    <xf:label>Sélectionner une source dans la base</xf:label>
                                    <xf:setvalue ref="." value="''" ev:event="DOMActivate"/>
                                </xf:trigger>
                            </xf:group>
                            <xf:group ref="@xlink:href[.='' or . = instance('xprSources')/xpr:source[not(@localType='new')]]">
                                <xf:trigger>
                                    <xf:label>Ajouter une nouvelle source</xf:label>
                                    <xf:insert context="instance('xprSources')" origin="instance('xprNewEntries')/xpr:source" nodeset="xpr:source[1]" position="before" ev:event="DOMActivate"/>
                                    &lt;!&ndash; set a temporary xml:id value for added source &ndash;&gt;
                                    <xf:setvalue ref=".
                                                    | instance('xprSources')/xpr:source[@localType = 'new'][@xml:id = '']/@xml:id"
                                                 value="concat('local-id-source', number(count(instance('xprSources')//*:source[@localType='new'])))"
                                                 ev:event="DOMActivate"/>
                                </xf:trigger>
                                <xf:select1 ref="." incremental="true">
                                    <xf:itemset model="source" nodeset="instance('xprSources')/xpr:source">
                                        <xf:label ref="."/>
                                        <xf:value ref="choose(@xml:id, @xml:id, .)"/>
                                    </xf:itemset>
                                </xf:select1>
                            </xf:group>
                            <xf:group ref="instance('xprSources')/xpr:source[@localType='new'][@xml:id = $source/@xlink:href]">
                                <xf:label>Nouvelle source</xf:label>
                                <xf:input ref="." incremental="true">
                                    <xf:label>Source</xf:label>
                                </xf:input>
                            </xf:group>
                            <xf:input ref=".">
                                <xf:label>commentaire</xf:label>
                            </xf:input>
                            <xf:trigger ref="." class="delete">
                                <xf:label>Supprimer une source</xf:label>
                                <xf:delete nodeset="." at="1" if="count(ancestor::eac:nameEntry/xpr:source) &gt; 1" ev:event="DOMActivate"/>
                                <xf:help>Supprimer une source</xf:help>
                            </xf:trigger>
                        </xf:repeat>-->
                        <xf:repeat id="repeatOccupationSource" nodeset="xpr:source">
                            <xf:var name="source" value="."/>
                            <xf:label>Source</xf:label>
                            <xf:select1 ref="@xlink:href" incremental="true">
                                <xf:itemset model="source" nodeset="instance('xprSources')/xpr:source">
                                    <xf:label ref="."/>
                                    <!--<xf:value ref="choose(@xml:id, @xml:id, .)"/>-->
                                    <xf:value value="concat('#', @xml:id)"/>
                                </xf:itemset>
                            </xf:select1>
                            <xf:input ref=".">
                                <xf:label>commentaire</xf:label>
                            </xf:input>
                            <xf:trigger ref="." class="delete">
                                <xf:label>Supprimer une source</xf:label>
                                <xf:delete nodeset="." at="1" if="count(ancestor::eac:nameEntry/xpr:source) &gt; 1" ev:event="DOMActivate"/>
                                <xf:help>Supprimer une source</xf:help>
                            </xf:trigger>
                        </xf:repeat>
                        <xf:trigger class="insert">
                            <xf:label>Nouvelle source</xf:label>
                            <xf:action ev:event="DOMActivate">
                                <xf:insert context="." origin="instance('xprProsopoCopy')/eac:cpfDescription/eac:description/eac:occupations/eac:occupation/xpr:source" nodeset="xpr:source[last()]" position="after" ev:event="DOMActivate"/>
                            </xf:action>
                            <xf:help>Ajouter une source</xf:help>
                        </xf:trigger>
                    </xf:group>
                    <xf:trigger class="delete">
                        <xf:label>Supprimer une occupation</xf:label>
                        <xf:delete nodeset="." at="1" if="count(instance('xprProsopo')/eac:cpfDescription/eac:description/eac:occupations/eac:occupation) > 1" ev:event="DOMActivate"/>
                        <xf:help>Supprimer une occupation</xf:help>
                    </xf:trigger>
                </xf:repeat>
                <xf:trigger class="insert">
                    <xf:label>Ajouter une occupation</xf:label>
                    <xf:action ev:event="DOMActivate">
                        <xf:insert nodeset="eac:occupation" at="last()" position="after" ev:event="DOMActivate"/>
                        <xf:setvalue ref="eac:occupation[last()]//* | eac:occupation[last()]//@*" value="''"/>
                    </xf:action>
                    <xf:help>Ajouter une occupation</xf:help>
                </xf:trigger>
            </xf:group>
            <xf:group ref="instance('xprProsopo')/eac:cpfDescription/eac:description/eac:biogHist/eac:chronList">
                <xf:label>Événements</xf:label>
                <xf:repeat id="repeatChronItem" bind="chronItem" appearance="full">
                    <xf:label>Événement</xf:label>
                    <xf:select1 ref="@localType">
                        <xf:itemset model="prosopo" nodeset="instance('xprEvents')/xpr:type">
                            <xf:label ref="xpr:label"/>
                            <xf:value ref="xpr:value"/>
                        </xf:itemset>
                        <xf:action ev:event="xforms-value-changed">
                            <xf:delete nodeset="ancestor::eac:chronItem/xpr:cost"/>
                        </xf:action>
                        <xf:action ev:event="xforms-value-changed" if="self::node()[. = 'officePurchase' or . = 'officeSale']">
                            <xf:insert context="ancestor::eac:chronItem" origin="instance('xprEventsAddon')/xpr:cost" nodeset="eac:event" position="after"/>
                        </xf:action>
                    </xf:select1>
                    <xf:group ref="eac:date">
                        <xf:label>Date</xf:label>
                        <xf:trigger>
                            <xf:label>Intervalle</xf:label>
                            <xf:action ev:event="DOMActivate" if="self::eac:date">
                                <xf:insert context="ancestor::eac:chronItem" origin="instance('xprProsopoCopy')/eac:cpfDescription/eac:description/eac:existDates/eac:dateRange" nodeset="eac:date" position="before"/>
                                <xf:setvalue ref="./ancestor::eac:chronItem/eac:dateRange/eac:fromDate/@standardDate" value="current()/@standardDate"/>
                                <xf:setvalue ref="./ancestor::eac:chronItem/eac:dateRange/eac:fromDate/@notAfter" value="current()/@notAfter"/>
                                <xf:setvalue ref="./ancestor::eac:chronItem/eac:dateRange/eac:fromDate/@notBefore" value="current()/@notBefore"/>
                                <xf:delete nodeset="."/>
                            </xf:action>
                        </xf:trigger>
                        <xf:input ref="@standardDate">
                            <xf:label>Certaine</xf:label>
                        </xf:input>
                        <xf:input ref="@notAfter">
                            <xf:label>Avant le</xf:label>
                        </xf:input>
                        <xf:input ref="@notBefore">
                            <xf:label>Après le</xf:label>
                        </xf:input>
                    </xf:group>
                    <xf:group ref="eac:dateRange">
                        <xf:label>Intervalle</xf:label>
                        <xf:trigger>
                            <xf:label>Date unique</xf:label>
                            <xf:action ev:event="DOMActivate" if="self::eac:dateRange">
                                <xf:insert context="ancestor::eac:chronItem" origin="instance('xprProsopoCopy')/eac:cpfDescription/eac:description/eac:biogHist/eac:chronList/eac:chronItem/eac:date" nodeset="eac:dateRange" position="before"/>
                                <xf:setvalue ref="./ancestor::eac:chronItem/eac:date/@standardDate" value="current()/eac:fromDate/@standardDate"/>
                                <xf:setvalue ref="./ancestor::eac:chronItem/eac:date/@notAfter" value="current()/eac:fromDate/@notAfter"/>
                                <xf:setvalue ref="./ancestor::eac:chronItem/eac:date/@notBefore" value="current()/eac:fromDate/@notBefore"/>
                                <xf:delete nodeset="."/>
                            </xf:action>
                        </xf:trigger>
                        <xf:group ref="eac:fromDate">
                            <xf:label>Début</xf:label>
                            <xf:input ref="@standardDate">
                                <xf:label>Certaine</xf:label>
                            </xf:input>
                            <xf:input ref="@notAfter">
                                <xf:label>Avant le</xf:label>
                            </xf:input>
                            <xf:input ref="@notBefore">
                                <xf:label>Après le</xf:label>
                            </xf:input>
                        </xf:group>
                        <xf:group ref="eac:toDate">
                            <xf:label>Fin</xf:label>
                            <xf:input ref="@standardDate">
                                <xf:label>Certaine</xf:label>
                            </xf:input>
                            <xf:input ref="@notAfter">
                                <xf:label>Avant le</xf:label>
                            </xf:input>
                            <xf:input ref="@notBefore">
                                <xf:label>Après le</xf:label>
                            </xf:input>
                        </xf:group>
                    </xf:group>
                    <xf:input ref="eac:placeEntry">
                        <xf:label>Lieu</xf:label>
                    </xf:input>
                    <xf:input ref="eac:event">
                        <xf:label>Intitulé</xf:label>
                    </xf:input>
                    <xf:input ref="xpr:cost">
                        <xf:label>Coût</xf:label>
                    </xf:input>
                    <!--<xf:repeat id="repeatParticipant" nodeset="rico:participant | rico:involve">
                        <xf:var name="participant" value="."/>
                        <xf:label><xf:output value="if(local-name()='participant', 'Participant', 'Involve')"/></xf:label>
                        <xf:group ref="@xlink:href[.!='' and substring-after(., '#')=instance('xprEntities')/xpr:entity[@localType='new']/@xml:id]">
                            <xf:trigger>
                                <xf:label>Personne dans la base</xf:label>
                                <xf:setvalue ref="." value="''" ev:event="DOMActivate"/>
                            </xf:trigger>
                        </xf:group>
                        <xf:group ref="@xlink:href[substring-after(., '#')='' or substring-after(., '#') = instance('xprEntities')/xpr:entity[not(@localType='new')]/@xml:id]">
                            <xf:trigger>
                                <xf:label>Nouvelle personne</xf:label>
                                <xf:insert context="instance('xprEntities')"
                                           origin="instance('xprNewEntries')/xpr:entity"
                                           nodeset="xpr:entity[1]"
                                           position="before"
                                           ev:event="DOMActivate"/>
                                <xf:insert context="instance('xprEntities')/xpr:entity[@localType = 'new'][@xml:id = '']"
                                           origin="instance('xprProsopoCopy')"
                                           nodeset="xpr:label"
                                           position="after"
                                           ev:event="DOMActivate"/>
                                &lt;!&ndash; set a temporary xml:id value for added entity &ndash;&gt;
                                <xf:setvalue ref="." value="concat('#local-id-participant', number(count(instance('xprEntities')/xpr:entity[@localType = 'new'])))"
                                             ev:event="DOMActivate"/>
                                <xf:setvalue ref="instance('xprEntities')/xpr:entity[@localType = 'new'][@xml:id = '']//eac:entityId
                                              | instance('xprEntities')/xpr:entity[@localType = 'new'][@xml:id = '']/@xml:id"
                                             value="concat('local-id-participant', number(count(instance('xprEntities')/xpr:entity[@localType = 'new'])))"
                                             ev:event="DOMActivate"/>
                            </xf:trigger>
                            <xf:select1 ref="." incremental="true">
                                <xf:itemset model="prosopo" nodeset="instance('xprEntities')/xpr:entity">
                                    <xf:label ref="xpr:label"/>
                                    <xf:value value="concat('#', @xml:id)"/>
                                </xf:itemset>
                            </xf:select1>
                        </xf:group>
                        <xf:group ref="instance('xprEntities')/xpr:entity[concat('#', @xml:id) = $participant/@xlink:href]/eac:eac-cpf">
                            <xf:var name="entityType" value="descendant::eac:entityType"/>
                            <xf:label>Nouvelle entrée</xf:label>
                            <xf:select1 ref="eac:cpfDescription/eac:identity/eac:entityType" appearance="minimal">
                                <xf:label>Type d'entité</xf:label>
                                <xf:item>
                                    <xf:label>personne</xf:label>
                                    <xf:value>person</xf:value>
                                    <xf:action ev:event="xforms-select">
                                        <xf:setvalue ref="ancestor::eac:eac-cpf/eac:cpfDescription/eac:identity/@localType" value="''"/>
                                        <xf:delete ref="ancestor::eac:eac-cpf/eac:cpfDescription//eac:nameEntry[eac:alternativeForm]"/>
                                        <xf:insert context="ancestor::eac:eac-cpf/eac:cpfDescription/eac:identity" origin="instance('xprProsopoCopy')/eac:cpfDescription/eac:identity/eac:nameEntry[eac:alternativeForm]" nodeset="eac:nameEntry[eac:authorizedForm]" position="after"/>
                                        <xf:delete ref="ancestor::eac:eac-cpf/eac:cpfDescription/eac:identity/eac:nameEntry[eac:alternativeForm]//eac:part[@localType='officeName']"/>
                                    </xf:action>
                                </xf:item>
                                <xf:item>
                                    <xf:label>office</xf:label>
                                    <xf:value>corporateBody</xf:value>
                                    <xf:action ev:event="xforms-select">
                                        <xf:setvalue ref="ancestor::eac:eac-cpf/eac:cpfDescription/eac:identity/@localType" value="''"/>
                                        <xf:delete ref="ancestor::eac:eac-cpf/eac:cpfDescription//eac:nameEntry[eac:alternativeForm]"/>
                                        <xf:insert context="ancestor::eac:eac-cpf/eac:cpfDescription/eac:identity" origin="instance('xprProsopoCopy')/eac:cpfDescription/eac:identity/eac:nameEntry[eac:alternativeForm]" nodeset="eac:nameEntry[eac:authorizedForm]" position="after"/>
                                        <xf:delete ref="ancestor::eac:eac-cpf/eac:cpfDescription/eac:identity/eac:nameEntry[eac:alternativeForm]//eac:part[not(@localType='officeName')]"/>
                                    </xf:action>
                                </xf:item>
                                <xf:item>
                                    <xf:label>famille</xf:label>
                                    <xf:value>family</xf:value>
                                    <xf:action ev:event="xforms-select">
                                        <xf:setvalue ref="ancestor::eac:eac-cpf/eac:cpfDescription//eac:identity/@localType" value="'family'"/>
                                        <xf:delete ref="ancestor::eac:eac-cpf/eac:cpfDescription//eac:nameEntry[eac:alternativeForm]"/>
                                        <xf:insert context="ancestor::eac:eac-cpf/eac:cpfDescription/eac:identity" origin="instance('xprProsopoCopy')/eac:cpfDescription/eac:identity/eac:nameEntry[eac:alternativeForm]" nodeset="eac:nameEntry[eac:authorizedForm]" position="after"/>
                                        <xf:delete ref="ancestor::eac:eac-cpf/eac:cpfDescription//eac:identity/eac:nameEntry[eac:alternativeForm]//eac:part[not(@localType='surname')]"/>
                                    </xf:action>
                                </xf:item>
                            </xf:select1>
                            <xf:select1 ref="eac:cpfDescription/eac:identity/@localType" appearance="minimal">
                                <xf:label>Répertoire</xf:label>
                                <xf:itemset nodeset="instance('xprEntitiesTypes')/xpr:identity[@type=$entityType]">
                                    <xf:label ref="xpr:label"/>
                                    <xf:value ref="xpr:value"/>
                                </xf:itemset>
                            </xf:select1>
                            <xf:input ref="eac:cpfDescription/eac:identity/eac:nameEntry[child::eac:authorizedForm]/eac:part">
                                <xf:label>Nom</xf:label>
                                <xf:action ev:event="xforms-value-changed">
                                    <xf:setvalue ref="ancestor::xpr:entity/xpr:label" value="current()"/>
                                </xf:action>
                            </xf:input>
                            <xf:group ref="eac:cpfDescription/eac:description/eac:existDates/eac:dateRange/eac:fromDate">
                                <xf:label>Naissance</xf:label>
                                <xf:input ref="@standardDate">
                                    <xf:label>Certaine</xf:label>
                                </xf:input>
                                <xf:input ref="@notAfter">
                                    <xf:label>Avant le</xf:label>
                                </xf:input>
                                <xf:input ref="@notBefore">
                                    <xf:label>Après le</xf:label>
                                </xf:input>
                            </xf:group>
                            <xf:group ref="eac:cpfDescription/eac:description/eac:existDates/eac:dateRange/eac:toDate">
                                <xf:label>Décès</xf:label>
                                <xf:input ref="@standardDate">
                                    <xf:label>Certaine</xf:label>
                                </xf:input>
                                <xf:input ref="@notAfter">
                                    <xf:label>Avant le</xf:label>
                                </xf:input>
                                <xf:input ref="@notBefore">
                                    <xf:label>Après le</xf:label>
                                </xf:input>
                            </xf:group>
                            <xf:group ref="eac:cpfDescription[eac:identity/eac:entityType = 'person']/eac:description/eac:localDescription[@localType='sex']">
                                <xf:select1 ref="eac:term">
                                    <xf:label>Sexe</xf:label>
                                    <xf:item>
                                        <xf:label>Homme</xf:label>
                                        <xf:value>male</xf:value>
                                    </xf:item>
                                    <xf:item>
                                        <xf:label>Femme</xf:label>
                                        <xf:value>female</xf:value>
                                    </xf:item>
                                </xf:select1>
                            </xf:group>
                        </xf:group>
                        <xf:trigger class="delete">
                            <xf:label><xf:output value="if(local-name()='participant', 'Supprimer un participant', 'Supprimer un Involve')"/></xf:label>
                            <xf:delete nodeset="." ev:event="DOMActivate"/>
                            <xf:help><xf:output value="if(local-name()='participant', 'Supprimer un participant', 'Supprimer un Involve')"/></xf:help>
                        </xf:trigger>
                    </xf:repeat>-->
                    <xf:repeat id="repeatParticipant" nodeset="rico:participant | rico:involve">
                        <xf:var name="participant" value="."/>
                        <xf:label><xf:output value="if(local-name()='participant', 'Participant', 'Involve')"/></xf:label>
                        <xf:select1 ref="@xlink:href" incremental="true">
                            <xf:itemset model="prosopo" nodeset="instance('xprEntities')/xpr:entity">
                                <xf:label ref="xpr:label"/>
                                <xf:value value="concat('#', @xml:id)"/>
                            </xf:itemset>
                        </xf:select1>
                        <xf:trigger class="delete">
                            <xf:label><xf:output value="if(local-name()='participant', 'Supprimer un participant', 'Supprimer un Involve')"/></xf:label>
                            <xf:delete nodeset="." ev:event="DOMActivate"/>
                            <xf:help><xf:output value="if(local-name()='participant', 'Supprimer un participant', 'Supprimer un Involve')"/></xf:help>
                        </xf:trigger>
                    </xf:repeat>
                    <xf:trigger class="insert">
                        <xf:label>Ajouter un participant</xf:label>
                        <xf:insert if="rico:participant" context="." origin="instance('xprProsopoCopy')/eac:cpfDescription/eac:description/eac:biogHist/eac:chronList/eac:chronItem/rico:participant" nodeset="rico:participant[last()]" position="after" ev:event="DOMActivate"/>
                        <xf:insert if="not(rico:participant)" context="." origin="instance('xprProsopoCopy')/eac:cpfDescription/eac:description/eac:biogHist/eac:chronList/eac:chronItem/rico:participant" nodeset="eac:event" position="after" ev:event="DOMActivate"/>
                        <xf:help>Ajouter un participant</xf:help>
                    </xf:trigger>
                    <xf:trigger class="insert">
                        <xf:label>Ajouter un involve</xf:label>
                        <xf:insert if="rico:involve" context="." origin="instance('xprProsopoCopy')/eac:cpfDescription/eac:description/eac:biogHist/eac:chronList/eac:chronItem/rico:involve" nodeset="rico:involve[last()]" position="after" ev:event="DOMActivate"/>
                        <xf:insert if="not(rico:involve)" context="." origin="instance('xprProsopoCopy')/eac:cpfDescription/eac:description/eac:biogHist/eac:chronList/eac:chronItem/rico:involve" nodeset="xpr:source" position="before" ev:event="DOMActivate"/>
                        <xf:help>Ajouter un involve</xf:help>
                    </xf:trigger>
                    <xf:group>
                        <xf:label>Sources</xf:label>
                        <!--<xf:repeat id="repeatEventSource" nodeset="xpr:source">
                            <xf:var name="source" value="."/>
                            <xf:label>Source</xf:label>
                            <xf:group ref="@xlink:href[.!='' and .=instance('xprSources')/xpr:source[@localType='new']/@xml:id]">
                                <xf:trigger>
                                    <xf:label>Sélectionner une source dans la base</xf:label>
                                    <xf:setvalue ref="." value="''" ev:event="DOMActivate"/>
                                </xf:trigger>
                            </xf:group>
                            <xf:group ref="@xlink:href[.='' or . = instance('xprSources')/xpr:source[not(@localType='new')]]">
                                <xf:trigger>
                                    <xf:label>Ajouter une nouvelle source</xf:label>
                                    <xf:insert context="instance('xprSources')" origin="instance('xprNewEntries')/xpr:source" nodeset="xpr:source[1]" position="before" ev:event="DOMActivate"/>
                                    &lt;!&ndash; set a temporary xml:id value for added source &ndash;&gt;
                                    <xf:setvalue ref=".
                                                    | instance('xprSources')/xpr:source[@localType = 'new'][@xml:id = '']/@xml:id"
                                                 value="concat('local-id-source', number(count(instance('xprSources')//*:source[@localType='new'])))"
                                                 ev:event="DOMActivate"/>
                                </xf:trigger>
                                <xf:select1 ref="." incremental="true">
                                    <xf:itemset model="source" nodeset="instance('xprSources')/xpr:source">
                                        <xf:label ref="."/>
                                        <xf:value ref="choose(@xml:id, @xml:id, .)"/>
                                    </xf:itemset>
                                </xf:select1>
                            </xf:group>
                            <xf:group ref="instance('xprSources')/xpr:source[@localType='new'][@xml:id = $source/@xlink:href]">
                                <xf:label>Nouvelle source</xf:label>
                                <xf:input ref="." incremental="true">
                                    <xf:label>Source</xf:label>
                                </xf:input>
                            </xf:group>
                            <xf:input ref=".">
                                <xf:label>commentaire</xf:label>
                            </xf:input>
                            <xf:trigger ref="." class="delete">
                                <xf:label>Supprimer une source</xf:label>
                                <xf:delete nodeset="." at="1" if="count(ancestor::eac:nameEntry/xpr:source) &gt; 1" ev:event="DOMActivate"/>
                                <xf:help>Supprimer une source</xf:help>
                            </xf:trigger>
                        </xf:repeat>-->
                        <xf:repeat id="repeatEventSource" nodeset="xpr:source">
                            <xf:var name="source" value="."/>
                            <xf:label>Source</xf:label>
                            <xf:select1 ref="@xlink:href" incremental="true">
                                <xf:itemset model="source" nodeset="instance('xprSources')/xpr:source">
                                    <xf:label ref="."/>
                                    <!--<xf:value ref="choose(@xml:id, @xml:id, .)"/>-->
                                    <xf:value value="concat('#', @xml:id)"/>
                                </xf:itemset>
                            </xf:select1>
                            <xf:input ref=".">
                                <xf:label>commentaire</xf:label>
                            </xf:input>
                            <xf:trigger ref="." class="delete">
                                <xf:label>Supprimer une source</xf:label>
                                <xf:delete nodeset="." at="1" if="count(ancestor::eac:nameEntry/xpr:source) &gt; 1" ev:event="DOMActivate"/>
                                <xf:help>Supprimer une source</xf:help>
                            </xf:trigger>
                        </xf:repeat>
                        <xf:trigger class="insert">
                            <xf:label>Nouvelle source</xf:label>
                            <xf:action ev:event="DOMActivate">
                                <xf:insert context="." origin="instance('xprProsopoCopy')/eac:cpfDescription/eac:description/eac:biogHist/eac:chronList/eac:chronItem/xpr:source" nodeset="xpr:source[last()]" position="after" ev:event="DOMActivate"/>
                            </xf:action>
                            <xf:help>Ajouter une source</xf:help>
                        </xf:trigger>
                    </xf:group>
                    <xf:trigger class="delete">
                        <xf:label>Supprimer un événement</xf:label>
                        <xf:delete nodeset="." at="1" if="count(instance('xprProsopo')/eac:cpfDescription/eac:description/eac:biogHist/eac:chronList/eac:chronItem) > 1" ev:event="DOMActivate"/>
                        <xf:help>Supprimer un événement</xf:help>
                    </xf:trigger>
                </xf:repeat>
                <xf:trigger class="insert">
                    <xf:label>Ajouter un événement</xf:label>
                    <xf:action ev:event="DOMActivate">
                        <xf:insert context="." origin="instance('xprProsopoCopy')/eac:cpfDescription/eac:description/eac:biogHist/eac:chronList/eac:chronItem" nodeset="eac:chronItem[last()]" position="after" ev:event="DOMActivate"/>
                    </xf:action>
                    <xf:help>Ajouter un événement</xf:help>
                </xf:trigger>
            </xf:group>
            <xf:group ref="instance('xprProsopo')/eac:cpfDescription/eac:relations">
                <xf:label>Relations</xf:label>
                <!--<xf:repeat id="repeatRelation" nodeset="eac:cpfRelation">
                    <xf:var name="relation" value="."/>
                    <xf:label>Relation</xf:label>
                    <xf:group ref="@xlink:href[.!='' and substring-after(., '#')=instance('xprEntities')/xpr:entity[@localType='new']/@xml:id]">
                        <xf:trigger>
                            <xf:label>Personne dans la base</xf:label>
                            <xf:setvalue ref="." value="''" ev:event="DOMActivate"/>
                        </xf:trigger>
                    </xf:group>
                    <xf:group ref="@xlink:href[substring-after(., '#')='' or substring-after(., '#') = instance('xprEntities')/xpr:entity[not(@localType='new')]/@xml:id]">
                        <xf:trigger>
                            <xf:label>Nouvelle personne</xf:label>
                            <xf:insert context="instance('xprEntities')"
                                       origin="instance('xprNewEntries')/xpr:entity"
                                       nodeset="xpr:entity[1]"
                                       position="before"
                                       ev:event="DOMActivate"/>
                            <xf:insert context="instance('xprEntities')/xpr:entity[@localType = 'new'][@xml:id = '']"
                                       origin="instance('xprProsopoCopy')"
                                       nodeset="xpr:label"
                                       position="after"
                                       ev:event="DOMActivate"/>
                            &lt;!&ndash; set a temporary xml:id value for added entity &ndash;&gt;
                            <xf:setvalue ref="." value="concat('#local-id-participant', number(count(instance('xprEntities')/xpr:entity[@localType = 'new'])))"
                                         ev:event="DOMActivate"/>
                            <xf:setvalue ref="instance('xprEntities')/xpr:entity[@localType = 'new'][@xml:id = '']//eac:entityId
                                              | instance('xprEntities')/xpr:entity[@localType = 'new'][@xml:id = '']/@xml:id"
                                         value="concat('local-id-participant', number(count(instance('xprEntities')/xpr:entity[@localType = 'new'])))"
                                         ev:event="DOMActivate"/>
                        </xf:trigger>
                        <xf:select1 ref="." incremental="true">
                            <xf:itemset model="prosopo" nodeset="instance('xprEntities')/xpr:entity">
                                <xf:label ref="xpr:label"/>
                                <xf:value value="concat('#', @xml:id)"/>
                            </xf:itemset>
                        </xf:select1>
                    </xf:group>

                    <xf:group ref="instance('xprEntities')/xpr:entity[concat('#', @xml:id) = $relation/@xlink:href]/eac:eac-cpf">
                        <xf:var name="entityType" value="descendant::eac:entityType"/>
                        <xf:label>Nouvelle entrée</xf:label>
                        <xf:select1 ref="eac:cpfDescription/eac:identity/eac:entityType" appearance="minimal">
                            <xf:label>Type d'entité</xf:label>
                            <xf:item>
                                <xf:label>personne</xf:label>
                                <xf:value>person</xf:value>
                                <xf:action ev:event="xforms-select">
                                    <xf:setvalue ref="ancestor::eac:eac-cpf/eac:cpfDescription/eac:identity/@localType" value="''"/>
                                    <xf:delete ref="ancestor::eac:eac-cpf/eac:cpfDescription//eac:nameEntry[eac:alternativeForm]"/>
                                    <xf:insert context="ancestor::eac:eac-cpf/eac:cpfDescription/eac:identity" origin="instance('xprProsopoCopy')/eac:cpfDescription/eac:identity/eac:nameEntry[eac:alternativeForm]" nodeset="eac:nameEntry[eac:authorizedForm]" position="after"/>
                                    <xf:delete ref="ancestor::eac:eac-cpf/eac:cpfDescription/eac:identity/eac:nameEntry[eac:alternativeForm]//eac:part[@localType='officeName']"/>
                                </xf:action>
                            </xf:item>
                            <xf:item>
                                <xf:label>office</xf:label>
                                <xf:value>corporateBody</xf:value>
                                <xf:action ev:event="xforms-select">
                                    <xf:setvalue ref="ancestor::eac:eac-cpf/eac:cpfDescription/eac:identity/@localType" value="''"/>
                                    <xf:delete ref="ancestor::eac:eac-cpf/eac:cpfDescription//eac:nameEntry[eac:alternativeForm]"/>
                                    <xf:insert context="ancestor::eac:eac-cpf/eac:cpfDescription/eac:identity" origin="instance('xprProsopoCopy')/eac:cpfDescription/eac:identity/eac:nameEntry[eac:alternativeForm]" nodeset="eac:nameEntry[eac:authorizedForm]" position="after"/>
                                    <xf:delete ref="ancestor::eac:eac-cpf/eac:cpfDescription/eac:identity/eac:nameEntry[eac:alternativeForm]//eac:part[not(@localType='officeName')]"/>
                                </xf:action>
                            </xf:item>
                            <xf:item>
                                <xf:label>famille</xf:label>
                                <xf:value>family</xf:value>
                                <xf:action ev:event="xforms-select">
                                    <xf:setvalue ref="ancestor::eac:eac-cpf/eac:cpfDescription//eac:identity/@localType" value="'family'"/>
                                    <xf:delete ref="ancestor::eac:eac-cpf/eac:cpfDescription//eac:nameEntry[eac:alternativeForm]"/>
                                    <xf:insert context="ancestor::eac:eac-cpf/eac:cpfDescription/eac:identity" origin="instance('xprProsopoCopy')/eac:cpfDescription/eac:identity/eac:nameEntry[eac:alternativeForm]" nodeset="eac:nameEntry[eac:authorizedForm]" position="after"/>
                                    <xf:delete ref="ancestor::eac:eac-cpf/eac:cpfDescription//eac:identity/eac:nameEntry[eac:alternativeForm]//eac:part[not(@localType='surname')]"/>
                                </xf:action>
                            </xf:item>
                        </xf:select1>
                        <xf:select1 ref="eac:cpfDescription/eac:identity/@localType" appearance="minimal">
                            <xf:label>Répertoire</xf:label>
                            <xf:itemset nodeset="instance('xprEntitiesTypes')/xpr:identity[@type=$entityType]">
                                <xf:label ref="xpr:label"/>
                                <xf:value ref="xpr:value"/>
                            </xf:itemset>
                        </xf:select1>
                        <xf:input ref="eac:cpfDescription/eac:identity/eac:nameEntry[child::eac:authorizedForm]/eac:part">
                            <xf:label>Nom</xf:label>
                            <xf:action ev:event="xforms-value-changed">
                                <xf:setvalue ref="ancestor::xpr:entity/xpr:label" value="current()"/>
                            </xf:action>
                        </xf:input>
                        <xf:group ref="eac:cpfDescription/eac:description/eac:existDates/eac:dateRange/eac:fromDate">
                            <xf:label>Naissance</xf:label>
                            <xf:input ref="@standardDate">
                                <xf:label>Certaine</xf:label>
                            </xf:input>
                            <xf:input ref="@notAfter">
                                <xf:label>Avant le</xf:label>
                            </xf:input>
                            <xf:input ref="@notBefore">
                                <xf:label>Après le</xf:label>
                            </xf:input>
                        </xf:group>
                        <xf:group ref="eac:cpfDescription/eac:description/eac:existDates/eac:dateRange/eac:toDate">
                            <xf:label>Décès</xf:label>
                            <xf:input ref="@standardDate">
                                <xf:label>Certaine</xf:label>
                            </xf:input>
                            <xf:input ref="@notAfter">
                                <xf:label>Avant le</xf:label>
                            </xf:input>
                            <xf:input ref="@notBefore">
                                <xf:label>Après le</xf:label>
                            </xf:input>
                        </xf:group>
                        <xf:group ref="eac:cpfDescription[eac:identity/eac:entityType = 'person']/eac:description/eac:localDescription[@localType='sex']">
                            <xf:select1 ref="eac:term">
                                <xf:label>Sexe</xf:label>
                                <xf:item>
                                    <xf:label>Homme</xf:label>
                                    <xf:value>male</xf:value>
                                </xf:item>
                                <xf:item>
                                    <xf:label>Femme</xf:label>
                                    <xf:value>female</xf:value>
                                </xf:item>
                            </xf:select1>
                        </xf:group>
                    </xf:group>
                    <xf:select1 ref="@xlink:arcrole" incremental="true">
                        <xf:label>Type de relation</xf:label>
                        <xf:itemset model="prosopo" nodeset="instance('xprRelationsTypes')/xpr:type">
                            <xf:label ref="xpr:label"/>
                            <xf:value ref="xpr:value"/>
                        </xf:itemset>
                    </xf:select1>
                    <xf:group>
                        <xf:label>Sources</xf:label>
                        &lt;!&ndash;<xf:repeat id="repeatRelationSource" nodeset="xpr:source">
                            <xf:var name="source" value="."/>
                            <xf:label>Source</xf:label>
                            <xf:group ref="@xlink:href[.!='' and .=instance('xprSources')/xpr:source[@localType='new']/@xml:id]">
                                <xf:trigger>
                                    <xf:label>Sélectionner une source dans la base</xf:label>
                                    <xf:setvalue ref="." value="''" ev:event="DOMActivate"/>
                                </xf:trigger>
                            </xf:group>
                            <xf:group ref="@xlink:href[.='' or . = instance('xprSources')/xpr:source[not(@localType='new')]]">
                                <xf:trigger>
                                    <xf:label>Ajouter une nouvelle source</xf:label>
                                    <xf:insert context="instance('xprSources')" origin="instance('xprNewEntries')/xpr:source" nodeset="xpr:source[1]" position="before" ev:event="DOMActivate"/>
                                    &lt;!&ndash; set a temporary xml:id value for added source &ndash;&gt;
                                    <xf:setvalue ref=".
                                                    | instance('xprSources')/xpr:source[@localType = 'new'][@xml:id = '']/@xml:id"
                                                 value="concat('local-id-source', number(count(instance('xprSources')//*:source[@localType='new'])))"
                                                 ev:event="DOMActivate"/>
                                </xf:trigger>
                                <xf:select1 ref="." incremental="true">
                                    <xf:itemset model="source" nodeset="instance('xprSources')/xpr:source">
                                        <xf:label ref="."/>
                                        <xf:value ref="choose(@xml:id, @xml:id, .)"/>
                                    </xf:itemset>
                                </xf:select1>
                            </xf:group>
                            <xf:group ref="instance('xprSources')/xpr:source[@localType='new'][@xml:id = $source/@xlink:href]">
                                <xf:label>Nouvelle source</xf:label>
                                <xf:input ref="." incremental="true">
                                    <xf:label>Source</xf:label>
                                </xf:input>
                            </xf:group>
                            <xf:input ref=".">
                                <xf:label>commentaire</xf:label>
                            </xf:input>
                            <xf:trigger ref="." class="delete">
                                <xf:label>Supprimer une source</xf:label>
                                <xf:delete nodeset="." at="1" if="count(ancestor::eac:nameEntry/xpr:source) &gt; 1" ev:event="DOMActivate"/>
                                <xf:help>Supprimer une source</xf:help>
                            </xf:trigger>
                        </xf:repeat>&ndash;&gt;
                        <xf:repeat id="repeatRelationSource" nodeset="xpr:source">
                            <xf:var name="source" value="."/>
                            <xf:label>Source</xf:label>
                            <xf:select1 ref="@xlink:href" incremental="true">
                                <xf:itemset model="source" nodeset="instance('xprSources')/xpr:source">
                                    <xf:label ref="."/>
                                    <xf:value ref="choose(@xml:id, @xml:id, .)"/>
                                </xf:itemset>
                            </xf:select1>
                            <xf:input ref=".">
                                <xf:label>commentaire</xf:label>
                            </xf:input>
                            <xf:trigger ref="." class="delete">
                                <xf:label>Supprimer une source</xf:label>
                                <xf:delete nodeset="." at="1" if="count(ancestor::eac:nameEntry/xpr:source) &gt; 1" ev:event="DOMActivate"/>
                                <xf:help>Supprimer une source</xf:help>
                            </xf:trigger>
                        </xf:repeat>
                        <xf:trigger class="insert">
                            <xf:label>Nouvelle source</xf:label>
                            <xf:action ev:event="DOMActivate">
                                <xf:insert context="." origin="instance('xprProsopoCopy')/eac:cpfDescription/eac:relations/eac:cpfRelation/xpr:source" nodeset="xpr:source[last()]" position="after" ev:event="DOMActivate"/>
                            </xf:action>
                            <xf:help>Ajouter une source</xf:help>
                        </xf:trigger>
                    </xf:group>
                    <xf:trigger ref="." class="delete">
                        <xf:label>Supprimer une relation</xf:label>
                        <xf:delete nodeset="." at="1" if="count(instance('xprProsopo')/eac:cpfDescription/eac:relations/eac:cpfRelation) &gt; 1" ev:event="DOMActivate"/>
                        <xf:help>Supprimer une relation</xf:help>
                    </xf:trigger>
                </xf:repeat>-->
                <xf:repeat id="repeatRelation" nodeset="eac:cpfRelation">
                    <xf:var name="relation" value="."/>
                    <xf:label>Relation</xf:label>
                    <xf:select1 ref="@xlink:href" incremental="true">
                        <xf:itemset model="prosopo" nodeset="instance('xprEntities')/xpr:entity">
                            <xf:label ref="xpr:label"/>
                            <xf:value value="concat('#', @xml:id)"/>
                        </xf:itemset>
                    </xf:select1>
                    <xf:select1 ref="@xlink:arcrole" incremental="true">
                        <xf:label>Type de relation</xf:label>
                        <xf:itemset model="prosopo" nodeset="instance('xprRelationsTypes')/xpr:type">
                            <xf:label ref="xpr:label"/>
                            <xf:value ref="xpr:value"/>
                        </xf:itemset>
                    </xf:select1>
                    <xf:group>
                        <xf:label>Sources</xf:label>
                        <xf:repeat id="repeatRelationSource" nodeset="xpr:source">
                            <xf:var name="source" value="."/>
                            <xf:label>Source</xf:label>
                            <xf:select1 ref="@xlink:href" incremental="true">
                                <xf:itemset model="source" nodeset="instance('xprSources')/xpr:source">
                                    <xf:label ref="."/>
                                    <!--<xf:value ref="choose(@xml:id, @xml:id, .)"/>-->
                                    <xf:value value="concat('#', @xml:id)"/>
                                </xf:itemset>
                            </xf:select1>
                            <xf:input ref=".">
                                <xf:label>commentaire</xf:label>
                            </xf:input>
                            <xf:trigger ref="." class="delete">
                                <xf:label>Supprimer une source</xf:label>
                                <xf:delete nodeset="." at="1" if="count(ancestor::eac:nameEntry/xpr:source) &gt; 1" ev:event="DOMActivate"/>
                                <xf:help>Supprimer une source</xf:help>
                            </xf:trigger>
                        </xf:repeat>
                        <xf:trigger class="insert">
                            <xf:label>Nouvelle source</xf:label>
                            <xf:action ev:event="DOMActivate">
                                <xf:insert context="." origin="instance('xprProsopoCopy')/eac:cpfDescription/eac:relations/eac:cpfRelation/xpr:source" nodeset="xpr:source[last()]" position="after" ev:event="DOMActivate"/>
                            </xf:action>
                            <xf:help>Ajouter une source</xf:help>
                        </xf:trigger>
                    </xf:group>
                    <xf:trigger ref="." class="delete">
                        <xf:label>Supprimer une relation</xf:label>
                        <xf:delete nodeset="." at="1" if="count(instance('xprProsopo')/eac:cpfDescription/eac:relations/eac:cpfRelation) &gt; 1" ev:event="DOMActivate"/>
                        <xf:help>Supprimer une relation</xf:help>
                    </xf:trigger>
                </xf:repeat>
                <xf:trigger class="insert">
                    <xf:label>Nouvelle une relation</xf:label>
                    <xf:action ev:event="DOMActivate">
                        <xf:insert context="."
                                   origin="instance('xprProsopoCopy')/eac:cpfDescription/eac:relations/eac:cpfRelation"
                                   nodeset="eac:cpfRelation"
                                   at="last()"
                                   position="after"
                                   ev:event="DOMActivate"/>
                    </xf:action>
                    <xf:help>Ajouter une relation</xf:help>
                </xf:trigger>
            </xf:group>
            <span class="save">
                <xf:select1 ref="instance('xprProsopo')/eac:control/eac:localControl/eac:term" appearance="full" incremental="true">
                    <xf:label>
                        <span>Statut</span>
                    </xf:label>
                    <xf:item>
                        <xf:label>En cours</xf:label>
                        <xf:value>in progress</xf:value>
                    </xf:item>
                    <xf:item>
                        <xf:label>À revoir</xf:label>
                        <xf:value>to revise</xf:value>
                    </xf:item>
                    <xf:item>
                        <xf:label>Terminée</xf:label>
                        <xf:value>completed</xf:value>
                    </xf:item>
                </xf:select1>
                <xf:dialog id="control">
                    <xf:group ref="eac:control/eac:maintenanceHistory/eac:maintenanceEvent[1]">
                        <xf:input ref="eac:eventDescription">
                            <xf:label>Motif de la révision</xf:label>
                        </xf:input>
                    </xf:group>
                    <xf:trigger>
                        <xf:label>Annuler</xf:label>
                        <xf:hide ev:event="DOMActivate" dialog="control"/>
                    </xf:trigger>
                    <xf:trigger>
                        <xf:label>Enregistrer</xf:label>
                        <xf:action ev:event="DOMActivate">
                            <xf:dispatch name="submission" targetid="prosopo"/>
                        </xf:action>
                    </xf:trigger>
                </xf:dialog>
                <xf:trigger>
                    <xf:label>Enregistrer</xf:label>
                    <!--we are using xf:delete to distinguish which submission module we need (prosopo or inventory)-->
                    <xf:delete nodeset="instance('xprInventory')/*" ev:event="DOMActivate"/>
                    <xf:action if="/eac:eac-cpf/@xml:id" ev:event="DOMActivate">
                        <xf:show dialog="control"/>
                    </xf:action>
                    <xf:action if="not(/eac:eac-cpf/@xml:id)" ev:event="DOMActivate">
                        <xf:dispatch name="submission" targetid="prosopo"/>
                    </xf:action>
                </xf:trigger>
            </span>
        </xf:case>
        <xf:case id="sourcesPanel">
            <xf:group ref="instance('xprProsopo')/eac:control/eac:sources">
                <xf:trigger>
                    <xf:label>Ajouter une source</xf:label>
                    <xf:action ev:event="DOMActivate">
                        <xf:insert context="instance('xprProsopo')/eac:control/eac:sources" origin="instance('xprProsopoCopy')/eac:control/eac:sources/eac:source" nodeset="./*[last()]" position="after"/>
                    </xf:action>
                </xf:trigger>
                <xf:repeat id="repeatControlSource" nodeset="eac:source">
                    <xf:var name="source" value="."/>
                    <xf:select1 ref="@xlink:href" incremental="true">
                        <xf:itemset model="source" nodeset="instance('xprSources')/xpr:source">
                            <xf:label ref="."/>
                            <!--<xf:value ref="choose(@xml:id, @xml:id, .)"/>-->
                            <xf:value value="concat('#', @xml:id)"/>
                        </xf:itemset>
                    </xf:select1>
                    <xf:input ref="eac:descriptiveNote/eac:p">
                        <xf:label>commentaire</xf:label>
                    </xf:input>
                    <xf:trigger ref="." class="delete">
                        <xf:label>Supprimer une source</xf:label>
                        <xf:delete nodeset="." at="1" if="count(ancestor::eac:sources/eac:source) &gt; 1" ev:event="DOMActivate"/>
                        <xf:help>Supprimer une source</xf:help>
                    </xf:trigger>
                    <!--<xf:trigger ref="@localType">
                        <xf:label>Sélectionner une source dans la base</xf:label>
                        <xf:delete ref="parent::xpr:source/@localType" ev:event="DOMActivate"/>
                        &lt;!&ndash; to resolve display bug when adding item into itemset (gap label/value diplayed)&ndash;&gt;
                        <xf:action ev:event="DOMActivate">
                            <xf:insert origin="instance('xprProsopo')" context="instance('xprStorage')" nodeset="./*"/>
                            <xf:insert origin="instance('xprStorage')/eac:eac-cpf" context="instance('xprProsopo')" nodeset="."/>
                            <xf:delete ref="instance('xprStorage')/eac:eac-cpf"/>
                        </xf:action>
                    </xf:trigger>
                    <xf:trigger ref="self::node()[not(@localType)]">
                        <xf:label>Ajouter une nouvelle source</xf:label>
                        <xf:insert context="." origin="instance('xprNewEntries')/eac:source/@localType" nodeset="eac:source" ev:event="DOMActivate"/>
                        <xf:insert origin="instance('xprNewEntries')/xpr:source" context="instance('xprSources')" nodeset="xpr:source[1]" position="before" ev:event="DOMActivate"/>
                        <xf:setvalue ref="./@xlink:href | instance('xprSources')/xpr:source[@localType = 'new'][@xml:id = '']/@xml:id" value="concat('local-id-source', number(count(instance('xprProsopo')//*:source[@localType='new'])))" ev:event="DOMActivate"/>
                        &lt;!&ndash; to resolve display bug when adding new item into itemset (gap label/value diplayed)&ndash;&gt;
                        <xf:action ev:event="DOMActivate">
                            <xf:insert origin="instance('xprProsopo')" context="instance('xprStorage')" nodeset="./*"/>
                            <xf:insert origin="instance('xprStorage')/eac:eac-cpf" context="instance('xprProsopo')" nodeset="."/>
                            <xf:delete ref="instance('xprStorage')/eac:eac-cpf"/>
                        </xf:action>
                    </xf:trigger>
                    <xf:select1 ref="@xlink:href[parent::eac:source[not(@localType = 'new')]]" appearance="minimal" incremental="true">
                        <xf:label>Source</xf:label>
                        <xf:itemset model="source" nodeset="instance('xprSources')/xpr:source">
                            <xf:label ref="."/>
                            <xf:value ref="if(@localId, @localId, .)"/>
                        </xf:itemset>
                    </xf:select1>
                    <xf:group ref="instance('xprSources')/xpr:source[@localType = 'new'][@xml:id = current()/@xlink:href[ancestor::eac:source[@localType]]]">
                        <xf:label>Nouvelle source</xf:label>
                        <xf:input ref="." incremental="true">
                            <xf:label>Source</xf:label>
                        </xf:input>
                    </xf:group>
                    <xf:input ref="eac:descriptiveNote/eac:p">
                        <xf:label>commentaire</xf:label>
                    </xf:input>
                    <xf:trigger ref="." class="delete">
                        <xf:label>Supprimer une source</xf:label>
                        <xf:delete nodeset="." at="1" if="count(ancestor::eac:sources/eac:source) &gt; 1" ev:event="DOMActivate"/>
                        <xf:help>Supprimer une source</xf:help>
                    </xf:trigger>-->
                </xf:repeat>
                <xf:trigger>
                    <xf:label>mise à jour des Sources</xf:label>
                    <xf:action ev:event="DOMActivate" while="instance('xprProsopo')//xpr:source/@xlink:href[not(. = '')][not(. = instance('xprProsopo')//eac:control//eac:source/@xlink:href)]">
                        <!-- todo supprimer les éventuelles sources vides dans control source ! -->
                        <xf:insert context="instance('xprProsopo')/eac:control/eac:sources" origin="instance('xprProsopoCopy')/eac:control/eac:sources/eac:source" nodeset="./*[last()]" position="after"/>
                        <xf:setvalue ref="instance('xprProsopo')//eac:sources/eac:source/@xlink:href[. = '']" value="instance('xprProsopo')//xpr:source/@xlink:href[not(. = instance('xprProsopo')//eac:control//eac:source/@xlink:href)]"/>
                        <xf:setvalue ref="instance('xprProsopo')//eac:sources/eac:source/eac:sourceEntry[. = '']" value="ancestor::eac:source/@xlink:href"/>
                    </xf:action>
                </xf:trigger>
            </xf:group>
        </xf:case>
        <xf:case id="newEntitiesPanel">
            <xf:group ref="instance('xprEntities')">
                <xf:label>Nouvelle(s) entité(s)</xf:label>
                <xf:repeat nodeset="instance('xprEntities')//xpr:entity[@localType='new']">
                    <xf:group ref="eac:eac-cpf">
                        <xf:var name="newEntity" value="."/>
                        <xf:label>Nouvelle entrée</xf:label>
                        <xf:select1 ref="eac:cpfDescription/eac:identity/eac:entityType" appearance="full">
                            <xf:label>Type d'entité</xf:label>
                            <xf:item>
                                <xf:label>personne</xf:label>
                                <xf:value>person</xf:value>
                                <xf:action ev:event="xforms-select">
                                    <xf:setvalue ref="ancestor::eac:eac-cpf/eac:cpfDescription/eac:identity/@localType"
                                                 value="''"/>
                                    <xf:delete ref="ancestor::eac:eac-cpf/eac:cpfDescription//eac:nameEntry[eac:alternativeForm]"/>
                                    <xf:insert context="ancestor::eac:eac-cpf/eac:cpfDescription/eac:identity"
                                               origin="instance('xprProsopoCopy')/eac:cpfDescription/eac:identity/eac:nameEntry[eac:alternativeForm]"
                                               nodeset="eac:nameEntry[eac:authorizedForm]"
                                               position="after"/>
                                    <xf:delete ref="ancestor::eac:eac-cpf/eac:cpfDescription/eac:identity/eac:nameEntry[eac:alternativeForm]//eac:part[@localType='officeName']"/>
                                </xf:action>
                            </xf:item>
                            <xf:item>
                                <xf:label>office</xf:label>
                                <xf:value>corporateBody</xf:value>
                                <xf:action ev:event="xforms-select">
                                    <xf:setvalue ref="ancestor::eac:eac-cpf/eac:cpfDescription/eac:identity/@localType"
                                                 value="''"/>
                                    <xf:delete ref="ancestor::eac:eac-cpf/eac:cpfDescription//eac:nameEntry[eac:alternativeForm]"/>
                                    <xf:insert context="ancestor::eac:eac-cpf/eac:cpfDescription/eac:identity"
                                               origin="instance('xprProsopoCopy')/eac:cpfDescription/eac:identity/eac:nameEntry[eac:alternativeForm]"
                                               nodeset="eac:nameEntry[eac:authorizedForm]"
                                               position="after"/>
                                    <xf:delete ref="ancestor::eac:eac-cpf/eac:cpfDescription/eac:identity/eac:nameEntry[eac:alternativeForm]//eac:part[not(@localType='officeName')]"/>
                                </xf:action>
                            </xf:item>
                            <xf:item>
                                <xf:label>famille</xf:label>
                                <xf:value>family</xf:value>
                                <xf:action ev:event="xforms-select">
                                    <xf:setvalue ref="ancestor::eac:eac-cpf/eac:cpfDescription//eac:identity/@localType"
                                                 value="'family'"/>
                                    <xf:delete ref="ancestor::eac:eac-cpf/eac:cpfDescription//eac:nameEntry[eac:alternativeForm]"/>
                                    <xf:insert context="ancestor::eac:eac-cpf/eac:cpfDescription/eac:identity"
                                               origin="instance('xprProsopoCopy')/eac:cpfDescription/eac:identity/eac:nameEntry[eac:alternativeForm]"
                                               nodeset="eac:nameEntry[eac:authorizedForm]"
                                               position="after"/>
                                    <xf:delete ref="ancestor::eac:eac-cpf/eac:cpfDescription//eac:identity/eac:nameEntry[eac:alternativeForm]//eac:part[not(@localType='surname')]"/>
                                </xf:action>
                            </xf:item>
                        </xf:select1>
                        <xf:select1 ref="eac:cpfDescription/eac:identity/@localType" appearance="full">
                            <xf:label>Répertoire</xf:label>
                            <xf:itemset model="prosopo" nodeset="instance('xprEntitiesTypes')/xpr:identity[@type = $newEntity//eac:entityType]">
                                <xf:label ref="xpr:label"/>
                                <xf:value ref="xpr:value"/>
                            </xf:itemset>
                        </xf:select1>
                        <xf:input ref="eac:cpfDescription/eac:identity/eac:nameEntry[child::eac:authorizedForm]/eac:part">
                            <xf:label>Nom</xf:label>
                            <xf:action ev:event="xforms-value-changed">
                                <xf:setvalue ref="ancestor::xpr:entity/xpr:label" value="current()"/>
                            </xf:action>
                        </xf:input>
                        <xf:group ref="eac:cpfDescription/eac:description/eac:existDates/eac:dateRange/eac:fromDate">
                            <xf:label>Naissance</xf:label>
                            <xf:input ref="@standardDate">
                                <xf:label>Certaine</xf:label>
                            </xf:input>
                            <xf:input ref="@notAfter">
                                <xf:label>Avant le</xf:label>
                            </xf:input>
                            <xf:input ref="@notBefore">
                                <xf:label>Après le</xf:label>
                            </xf:input>
                        </xf:group>
                        <xf:group ref="eac:cpfDescription/eac:description/eac:existDates/eac:dateRange/eac:toDate">
                            <xf:label>Décès</xf:label>
                            <xf:input ref="@standardDate">
                                <xf:label>Certaine</xf:label>
                            </xf:input>
                            <xf:input ref="@notAfter">
                                <xf:label>Avant le</xf:label>
                            </xf:input>
                            <xf:input ref="@notBefore">
                                <xf:label>Après le</xf:label>
                            </xf:input>
                        </xf:group>
                        <xf:group
                            ref="eac:cpfDescription[eac:identity/eac:entityType = 'person']/eac:description/eac:localDescription[@localType='sex']">
                            <xf:select1 ref="eac:term">
                                <xf:label>Sexe</xf:label>
                                <xf:item>
                                    <xf:label>Homme</xf:label>
                                    <xf:value>male</xf:value>
                                </xf:item>
                                <xf:item>
                                    <xf:label>Femme</xf:label>
                                    <xf:value>female</xf:value>
                                </xf:item>
                            </xf:select1>
                        </xf:group>
                    </xf:group>
                </xf:repeat>
                <xf:trigger>
                    <xf:label>Ajouter une nouvelle entité</xf:label>
                    <xf:insert context="instance('xprEntities')"
                               origin="instance('xprNewEntries')/xpr:entity"
                               nodeset="xpr:entity"
                               at="last()"
                               position="after"
                               ev:event="DOMActivate"/>
                    <xf:insert context="instance('xprEntities')/xpr:entity[@localType = 'new'][@xml:id = '']"
                               origin="instance('xprProsopoCopy')"
                               nodeset="xpr:label"
                               position="after"
                               ev:event="DOMActivate"/>
                    <xf:setvalue ref="instance('xprEntities')/xpr:entity[@localType = 'new'][@xml:id = '']//eac:entityId
                                 | instance('xprEntities')/xpr:entity[@localType = 'new'][@xml:id = '']/@xml:id"
                                 value="concat('local-id-participant', number(count(instance('xprEntities')/xpr:entity[@localType = 'new'])))"
                                 ev:event="DOMActivate"/>
                </xf:trigger>
            </xf:group>
        </xf:case>
        <xf:case id="newSourcesPanel">
            <xf:group ref="instance('xprSources')">
                <xf:label>Nouvelle(s) source(s)</xf:label>
                <xf:repeat nodeset="instance('xprSources')//xpr:source[@localType = 'new']">
                    <xf:label>Nouvelle source</xf:label>
                    <xf:input ref="." incremental="true">
                        <xf:label>Source</xf:label>
                    </xf:input>
                </xf:repeat>
                <xf:trigger>
                    <xf:label>Ajouter une nouvelle source</xf:label>
                    <xf:insert context="instance('xprSources')"
                               origin="instance('xprNewEntries')/xpr:source"
                               nodeset="xpr:source"
                               at="last()"
                               position="after"
                               ev:event="DOMActivate"/>
                    <xf:action ev:event="DOMActivate">
                        <xf:send submission="submitGetSourceId"/>
                    </xf:action>
                </xf:trigger>
            </xf:group>
        </xf:case>
    </xf:switch>
</form>
