<form xmlns:xf="http://www.w3.org/2002/xforms" xmlns:ev="http://www.w3.org/2001/xml-events">

    <!-- identity -->
    <xf:group ref="instance('xprProsopo')//eac:cpfDescription/eac:identity">
        <xf:label>Identité</xf:label>
        <xf:select1 bind="entityType" appearance="full">
            <xf:label>Type d'entité</xf:label>
            <xf:item>
                <xf:label>personne</xf:label>
                <xf:value>person</xf:value>
                <xf:action ev:event="xforms-select">
                    <xf:delete ref="instance('xprProsopo')//eac:cpfDescription/eac:identity/eac:nameEntry//*"/>
                    <xf:insert context="instance('xprProsopo')//eac:cpfDescription/eac:identity/eac:nameEntry" origin="instance('xprSupplement')/eac:nameEntry/eac:authorizedForm"/>
                    <xf:insert context="instance('xprProsopo')//eac:cpfDescription/eac:identity/eac:nameEntry" origin="instance('xprSupplement')/eac:nameEntry//eac:part[not(@localType='officeName')]"/>
                </xf:action>
            </xf:item>
            <xf:item>
                <xf:label>office</xf:label>
                <xf:value>corporateBody</xf:value>
                <xf:action ev:event="xforms-select">
                    <xf:delete ref="instance('xprProsopo')//eac:cpfDescription/eac:identity/eac:nameEntry//*"/>
                    <xf:insert context="instance('xprProsopo')//eac:cpfDescription/eac:identity/eac:nameEntry" origin="instance('xprSupplement')/eac:nameEntry/eac:authorizedForm"/>
                    <xf:insert context="instance('xprProsopo')//eac:cpfDescription/eac:identity/eac:nameEntry" origin="instance('xprSupplement')/eac:nameEntry/eac:part[@localType='officeName']"/>
                </xf:action>
            </xf:item>
            <xf:item>
                <xf:label>famille</xf:label>
                <xf:value>family</xf:value>
                <xf:action ev:event="xforms-select">
                    <xf:delete ref="instance('xprProsopo')//eac:cpfDescription/eac:identity/eac:nameEntry//*"/>
                    <xf:insert context="instance('xprProsopo')//eac:cpfDescription/eac:identity/eac:nameEntry" origin="instance('xprSupplement')/eac:nameEntry/eac:authorizedForm"/>
                    <xf:insert context="instance('xprProsopo')//eac:cpfDescription/eac:identity/eac:nameEntry" origin="instance('xprSupplement')/eac:nameEntry//eac:part[@localType='surname']"/>
                </xf:action>
            </xf:item>
        </xf:select1>

        <xf:group>
            <xf:repeat id="repeatName" bind="nameEntry" appearance="full">
                <xf:label>
                    <xf:output value="if(./eac:authorizedForm,'Identification - forme autorisée','')"/>
                    <xf:output value="if(./eac:alternativeForm,'Identification - forme alternative','')"/>
                </xf:label>
                <xf:input ref="eac:part[@localType='surname']">
                    <xf:label>Nom</xf:label>
                </xf:input>
                <xf:input ref="eac:part[@localType='forename']">
                    <xf:label>Prénom</xf:label>
                </xf:input>
                <xf:input ref="eac:part[@localType='particle']">
                    <xf:label>Particule</xf:label>
                </xf:input>
                <xf:input ref="eac:part[@localType='common']">
                    <xf:label>Titre d'appel</xf:label>
                </xf:input>
                <xf:input ref="eac:part[@localType='formal']">
                    <xf:label>Titre institutionnel</xf:label>
                </xf:input>
                <xf:input ref="eac:part[@localType='academic']">
                    <xf:label>Titre académique</xf:label>
                </xf:input>
                <xf:input ref="eac:part[@localType='religious']">
                    <xf:label>Titre religieux</xf:label>
                </xf:input>
                <xf:input ref="eac:part[@localType='nobiliary']">
                    <xf:label>Titre de noblesse</xf:label>
                </xf:input>
                <xf:input ref="eac:part[@localType='officeName']">
                    <xf:label>Dénomination</xf:label>
                </xf:input>
                <xf:trigger ref="self::node()[./eac:alternativeForm]" class="delete">
                    <xf:label>Supprimer une forme du nom</xf:label>
                    <xf:delete nodeset="." at="1" if="./eac:alternativeForm" ev:event="DOMActivate"/>
                    <xf:help>Supprimer une forme du nom</xf:help>
                </xf:trigger>
            </xf:repeat>
            <xf:trigger ref="self::node()[.//eac:part]" class="insert">
                <xf:label>Nouvelle forme alternative du nom</xf:label>
                <xf:action ev:event="DOMActivate">
                    <xf:insert nodeset="eac:nameEntry" at="last()" position="after" ev:event="DOMActivate"/>
                    <xf:insert nodeset="instance('xprProsopo')//eac:nameEntry[index('repeatName')]/*" origin="instance('xprSupplement')/eac:nameEntry/eac:alternativeForm" at="last()" position="after"/>
                    <xf:delete ref="instance('xprProsopo')//eac:nameEntry[index('repeatName')]/eac:authorizedForm"/>
                    <xf:delete ref="instance('xprProsopo')//eac:nameEntry[index('repeatName')]//eac:alternativeForm[position() &gt; 1]"/>
                    <xf:setvalue ref="eac:nameEntry[index('repeatName')]//eac:part" value=""/>
                </xf:action>
                <xf:help>Ajouter une forme alternative du nom</xf:help>
            </xf:trigger>
        </xf:group>
    </xf:group>

    <xf:group ref="instance('xprProsopo')/eac:cpfDescription/eac:description/eac:existDates/eac:dateRange">
        <xf:label>Existence</xf:label>
        <xf:group ref="eac:fromDate">
            <xf:label>Naissance</xf:label>
            <xf:input ref="@standardDate">
                <xf:label>Certaine</xf:label>
            </xf:input>
            <xf:input ref="@notAfter">
                <xf:label>Avant le</xf:label>
            </xf:input>
            <xf:input ref="@notBefore">
                <xf:label>Après le</xf:label>
            </xf:input>
        </xf:group>
        <xf:group ref="eac:toDate">
            <xf:label>Décès</xf:label>
            <xf:input ref="@standardDate">
                <xf:label>Certaine</xf:label>
            </xf:input>
            <xf:input ref="@notAfter">
                <xf:label>Avant le</xf:label>
            </xf:input>
            <xf:input ref="@notBefore">
                <xf:label>Après le</xf:label>
            </xf:input>
        </xf:group>
    </xf:group>

    <xf:group ref="instance('xprProsopo')/eac:cpfDescription/eac:description/eac:occupations">
        <xf:label>Occupations</xf:label>
        <xf:repeat id="repeatOccupation" nodeset="eac:occupation">
            <xf:input ref="eac:term">
                <xf:label>Intitulé</xf:label>
            </xf:input>
            <xf:group ref="eac:date">
                <xf:label>Date</xf:label>
                <xf:trigger>
                    <xf:label>Intervalle</xf:label>
                    <xf:action
                        ev:event="DOMActivate"
                        if="self::eac:date">
                        <xf:insert origin="instance('xprSupplement')/eac:dateRange" nodeset="./ancestor::eac:occupation/eac:term" position="after"/>
                        <xf:setvalue ref="./ancestor::eac:occupation/eac:dateRange/eac:fromDate/@standardDate" value="current()/@standardDate"/>
                        <xf:setvalue ref="./ancestor::eac:occupation/eac:dateRange/eac:fromDate/@notAfter" value="current()/@notAfter"/>
                        <xf:setvalue ref="./ancestor::eac:occupation/eac:dateRange/eac:fromDate/@notBefore" value="current()/@notBefore"/>
                        <xf:delete nodeset="."/>
                    </xf:action>
                </xf:trigger>
                <xf:input ref="@standardDate">
                    <xf:label>Certaine</xf:label>
                </xf:input>
                <xf:input ref="@notAfter">
                    <xf:label>Avant le</xf:label>
                </xf:input>
                <xf:input ref="@notBefore">
                    <xf:label>Après le</xf:label>
                </xf:input>
            </xf:group>
            <xf:group ref="eac:dateRange">
                <xf:label>Intervalle</xf:label>
                <xf:trigger>
                    <xf:label>Date unique</xf:label>
                    <xf:action
                        ev:event="DOMActivate"
                        if="self::eac:dateRange">
                        <xf:insert origin="instance('xprSupplement')/eac:date" nodeset="./ancestor::eac:occupation/eac:term" position="after"/>
                        <xf:setvalue ref="./ancestor::eac:occupation/eac:date/@standardDate" value="current()/eac:fromDate/@standardDate"/>
                        <xf:setvalue ref="./ancestor::eac:occupation/eac:date/@notAfter" value="current()/eac:fromDate/@notAfter"/>
                        <xf:setvalue ref="./ancestor::eac:occupation/eac:date/@notBefore" value="current()/eac:fromDate/@notBefore"/>
                        <xf:delete nodeset="."/>
                    </xf:action>
                </xf:trigger>
                <xf:group ref="eac:fromDate">
                    <xf:label>Début</xf:label>
                    <xf:input ref="@standardDate">
                        <xf:label>Certaine</xf:label>
                    </xf:input>
                    <xf:input ref="@notAfter">
                        <xf:label>Avant le</xf:label>
                    </xf:input>
                    <xf:input ref="@notBefore">
                        <xf:label>Après le</xf:label>
                    </xf:input>
                </xf:group>
                <xf:group ref="eac:toDate">
                    <xf:label>Fin</xf:label>
                    <xf:input ref="@standardDate">
                        <xf:label>Certaine</xf:label>
                    </xf:input>
                    <xf:input ref="@notAfter">
                        <xf:label>Avant le</xf:label>
                    </xf:input>
                    <xf:input ref="@notBefore">
                        <xf:label>Après le</xf:label>
                    </xf:input>
                </xf:group>
            </xf:group>
            <xf:input ref="eac:descriptiveNote">
                <xf:label>Note</xf:label>
            </xf:input>
            <xf:trigger class="delete">
                <xf:label>Supprimer une occupation</xf:label>
                <xf:delete nodeset="." at="1" if="count(//eac:cpfDescription/eac:description/eac:occupations/eac:occupation) > 1" ev:event="DOMActivate"/>
                <xf:help>Supprimer une occupation</xf:help>
            </xf:trigger>
        </xf:repeat>
        <xf:trigger class="insert">
            <xf:label>Ajouter une occupation</xf:label>
            <xf:action ev:event="DOMActivate">
                <xf:insert nodeset="eac:occupation" at="index('repeatOccupation')" position="after" ev:event="DOMActivate"/>
                <xf:setvalue ref="eac:occupation[index('repeatOccupation')]//* | eac:occupation[index('repeatOccupation')]//@*" value=""/>
            </xf:action>
            <xf:help>Ajouter une occupation</xf:help>
        </xf:trigger>
    </xf:group>

    <xf:group ref="instance('xprProsopo')/eac:cpfDescription/eac:description/eac:functions">
        <xf:label>Fonctions</xf:label>
        <xf:repeat id="repeatFunction" nodeset="eac:function">
            <xf:input ref="eac:term">
                <xf:label>Intitulé</xf:label>
            </xf:input>
            <xf:group ref="eac:date">
                <xf:label>Date</xf:label>
                <xf:trigger>
                    <xf:label>Intervalle</xf:label>
                    <xf:action
                        ev:event="DOMActivate"
                        if="self::eac:date">
                        <xf:insert origin="instance('xprSupplement')/eac:dateRange" nodeset="./ancestor::eac:function/eac:term" position="after"/>
                        <xf:setvalue ref="./ancestor::eac:function/eac:dateRange/eac:fromDate/@standardDate" value="current()/@standardDate"/>
                        <xf:setvalue ref="./ancestor::eac:function/eac:dateRange/eac:fromDate/@notAfter" value="current()/@notAfter"/>
                        <xf:setvalue ref="./ancestor::eac:function/eac:dateRange/eac:fromDate/@notBefore" value="current()/@notBefore"/>
                        <xf:delete nodeset="."/>
                    </xf:action>
                </xf:trigger>
                <xf:input ref="@standardDate">
                    <xf:label>Certaine</xf:label>
                </xf:input>
                <xf:input ref="@notAfter">
                    <xf:label>Avant le</xf:label>
                </xf:input>
                <xf:input ref="@notBefore">
                    <xf:label>Après le</xf:label>
                </xf:input>
            </xf:group>
            <xf:group ref="eac:dateRange">
                <xf:label>Intervalle</xf:label>
                <xf:trigger>
                    <xf:label>Date unique</xf:label>
                    <xf:action
                        ev:event="DOMActivate"
                        if="self::eac:dateRange">
                        <xf:insert origin="instance('xprSupplement')/eac:date" nodeset="./ancestor::eac:function/eac:term" position="after"/>
                        <xf:setvalue ref="./ancestor::eac:function/eac:date/@standardDate" value="current()/eac:fromDate/@standardDate"/>
                        <xf:setvalue ref="./ancestor::eac:function/eac:date/@notAfter" value="current()/eac:fromDate/@notAfter"/>
                        <xf:setvalue ref="./ancestor::eac:function/eac:date/@notBefore" value="current()/eac:fromDate/@notBefore"/>
                        <xf:delete nodeset="."/>
                    </xf:action>
                </xf:trigger>
                <xf:group ref="eac:fromDate">
                    <xf:label>Début</xf:label>
                    <xf:input ref="@standardDate">
                        <xf:label>Certaine</xf:label>
                    </xf:input>
                    <xf:input ref="@notAfter">
                        <xf:label>Avant le</xf:label>
                    </xf:input>
                    <xf:input ref="@notBefore">
                        <xf:label>Après le</xf:label>
                    </xf:input>
                </xf:group>
                <xf:group ref="eac:toDate">
                    <xf:label>Fin</xf:label>
                    <xf:input ref="@standardDate">
                        <xf:label>Certaine</xf:label>
                    </xf:input>
                    <xf:input ref="@notAfter">
                        <xf:label>Avant le</xf:label>
                    </xf:input>
                    <xf:input ref="@notBefore">
                        <xf:label>Après le</xf:label>
                    </xf:input>
                </xf:group>
            </xf:group>
            <xf:input ref="eac:descriptiveNote">
                <xf:label>Note</xf:label>
            </xf:input>
            <xf:trigger class="delete">
                <xf:label>Supprimer une fonction</xf:label>
                <xf:delete nodeset="." at="1" if="count(//eac:cpfDescription/eac:description/eac:functions/eac:function) > 1" ev:event="DOMActivate"/>
                <xf:help>Supprimer une fonction</xf:help>
            </xf:trigger>
        </xf:repeat>
        <xf:trigger class="insert">
            <xf:label>Ajouter une fonction</xf:label>
            <xf:action ev:event="DOMActivate">
                <xf:insert nodeset="eac:function" at="index('repeatFunction')" position="after" ev:event="DOMActivate"/>
                <xf:setvalue ref="eac:function[index('repeatFunction')]//* | eac:function[index('repeatFunction')]//@*" value=""/>
            </xf:action>
            <xf:help>Ajouter une fonction</xf:help>
        </xf:trigger>
    </xf:group>

    <xf:group ref="instance('xprProsopo')/eac:cpfDescription/eac:description/eac:biogHist/eac:chronList">
        <xf:label>Évènements</xf:label>
        <xf:repeat id="repeatChronItem" bind="chronItem" appearance="full">
            <xf:label>Évènement</xf:label>
            <xf:select1 ref="@localType">
                <xf:item>
                    <xf:label>Naissance</xf:label>
                    <xf:value>birth</xf:value>
                </xf:item>
                <xf:item>
                    <xf:label>Mariage</xf:label>
                    <xf:value>marriage</xf:value>
                </xf:item>
                <xf:item>
                    <xf:label>Achat d'office</xf:label>
                    <xf:value>officePurchase</xf:value>
                </xf:item>
                <xf:item>
                    <xf:label>Lettre de provision</xf:label>
                    <xf:value>provision</xf:value>
                </xf:item>
                <xf:item>
                    <xf:label>Réception</xf:label>
                    <xf:value>reception</xf:value>
                </xf:item>
                <xf:item>
                    <xf:label>Résignation</xf:label>
                    <xf:value>relinquishment</xf:value>
                </xf:item>
                <xf:item>
                    <xf:label>Suppression des offices</xf:label>
                    <xf:value>officesEnding</xf:value>
                </xf:item>
                <xf:item>
                    <xf:label>Dispense d'age</xf:label>
                    <xf:value>exemption</xf:value>
                </xf:item>
                <xf:item>
                    <xf:label>Saisie réelle</xf:label>
                    <xf:value>seizure</xf:value>
                </xf:item>
            </xf:select1>
            <xf:group ref="eac:date">
                <xf:label>Date</xf:label>
                <xf:trigger>
                    <xf:label>Intervalle</xf:label>
                    <xf:action
                        ev:event="DOMActivate"
                        if="self::eac:date">
                        <xf:insert origin="instance('xprSupplement')/eac:dateRange" nodeset="./ancestor::eac:chronItem/*" position="before"/>
                        <xf:setvalue ref="./ancestor::eac:chronItem/eac:dateRange/eac:fromDate/@standardDate" value="current()/@standardDate"/>
                        <xf:setvalue ref="./ancestor::eac:chronItem/eac:dateRange/eac:fromDate/@notAfter" value="current()/@notAfter"/>
                        <xf:setvalue ref="./ancestor::eac:chronItem/eac:dateRange/eac:fromDate/@notBefore" value="current()/@notBefore"/>
                        <xf:delete nodeset="."/>
                    </xf:action>
                </xf:trigger>
                <xf:input ref="@standardDate">
                    <xf:label>Certaine</xf:label>
                </xf:input>
                <xf:input ref="@notAfter">
                    <xf:label>Avant le</xf:label>
                </xf:input>
                <xf:input ref="@notBefore">
                    <xf:label>Après le</xf:label>
                </xf:input>
            </xf:group>
            <xf:group ref="eac:dateRange">
                <xf:label>Intervalle</xf:label>
                <xf:trigger>
                    <xf:label>Date unique</xf:label>
                    <xf:action
                        ev:event="DOMActivate"
                        if="self::eac:dateRange">
                        <xf:insert origin="instance('xprSupplement')/eac:date" nodeset="./ancestor::eac:chronItem/*" position="before"/>
                        <xf:setvalue ref="./ancestor::eac:chronItem/eac:date/@standardDate" value="current()/eac:fromDate/@standardDate"/>
                        <xf:setvalue ref="./ancestor::eac:chronItem/eac:date/@notAfter" value="current()/eac:fromDate/@notAfter"/>
                        <xf:setvalue ref="./ancestor::eac:chronItem/eac:date/@notBefore" value="current()/eac:fromDate/@notBefore"/>
                        <xf:delete nodeset="."/>
                    </xf:action>
                </xf:trigger>
                <xf:group ref="eac:fromDate">
                    <xf:label>Début</xf:label>
                    <xf:input ref="@standardDate">
                        <xf:label>Certaine</xf:label>
                    </xf:input>
                    <xf:input ref="@notAfter">
                        <xf:label>Avant le</xf:label>
                    </xf:input>
                    <xf:input ref="@notBefore">
                        <xf:label>Après le</xf:label>
                    </xf:input>
                </xf:group>
                <xf:group ref="eac:toDate">
                    <xf:label>Fin</xf:label>
                    <xf:input ref="@standardDate">
                        <xf:label>Certaine</xf:label>
                    </xf:input>
                    <xf:input ref="@notAfter">
                        <xf:label>Avant le</xf:label>
                    </xf:input>
                    <xf:input ref="@notBefore">
                        <xf:label>Après le</xf:label>
                    </xf:input>
                </xf:group>
            </xf:group>
            <xf:input ref="eac:placeEntry">
                <xf:label>Lieu</xf:label>
            </xf:input>
            <xf:input ref="eac:event">
                <xf:label>Intitulé</xf:label>
            </xf:input>

            <xf:repeat id="repeatParticipant" nodeset="rico:participant">
                <xf:label>Participant</xf:label>
                <xf:input ref="."/>
                <xf:trigger class="delete">
                    <xf:label>Supprimer un participant</xf:label>
                    <xf:delete nodeset="." at="1" if="count(//eac:cpfDescription/eac:description/eac:biogHist/eac:chronList/eac:chronItem/rico:participant) > 1" ev:event="DOMActivate"/>
                    <xf:help>Supprimer un participant</xf:help>
                </xf:trigger>
            </xf:repeat>
            <xf:trigger class="insert">
                <xf:label>Ajouter un participant</xf:label>
                <xf:action ev:event="DOMActivate">
                    <xf:insert nodeset="rico:participant" at="index('repeatParticipant')" position="after" ev:event="DOMActivate"/>
                    <xf:setvalue ref="rico:participant[index('repeatParticipant')]//* | rico:participant[index('repeatParticipant')]//@*" value=""/>
                </xf:action>
                <xf:help>Ajouter un participant</xf:help>
            </xf:trigger>

            <xf:repeat id="repeatInvolve" nodeset="rico:involve">
                <xf:label>Implique<!-- @todo revoir ce label --></xf:label>
                <xf:input ref="."/>
                <xf:trigger class="delete">
                    <xf:label>Supprimer</xf:label>
                    <xf:delete nodeset="." at="1" if="count(//eac:cpfDescription/eac:description/eac:biogHist/eac:chronList/eac:chronItem/rico:involve) > 1" ev:event="DOMActivate"/>
                    <xf:help>Supprimer</xf:help>
                </xf:trigger>
            </xf:repeat>
            <xf:trigger class="insert">
                <xf:label>Ajouter</xf:label>
                <xf:action ev:event="DOMActivate">
                    <xf:insert nodeset="rico:involve" at="index('repeatInvolve')" position="after" ev:event="DOMActivate"/>
                    <xf:setvalue ref="rico:involve[index('repeatInvolve')]//* | rico:involve[index('repeatInvolve')]//@*" value=""/>
                </xf:action>
                <xf:help>Ajouter</xf:help>
            </xf:trigger>

            <xf:select1 ref="xpr:source/@*[local-name() = 'href']" appearance="minimal" incremental="true">
                <xf:label>Source</xf:label>
                <xf:itemset bind="bindSource">
                    <xf:label value="."/>
                    <xf:value ref="."/>
                </xf:itemset>
            </xf:select1>

            <!-- @todo source (quand l'app les prendra en charge) -->
            <xf:trigger class="delete">
                <xf:label>Supprimer un évènement</xf:label>
                <xf:delete nodeset="." at="1" if="count(//eac:cpfDescription/eac:description/eac:biogHist/eac:chronList/eac:chronItem) > 1" ev:event="DOMActivate"/>
                <xf:help>Supprimer un évènement</xf:help>
            </xf:trigger>
        </xf:repeat>
        <xf:trigger class="insert">
            <xf:label>Ajouter un évènement</xf:label>
            <xf:action ev:event="DOMActivate">
                <xf:insert nodeset="eac:chronItem" at="index('repeatChronItem')" position="after" ev:event="DOMActivate"/>
                <xf:setvalue ref="eac:chronItem[index('repeatChronItem')]//* | eac:chronItem[index('repeatChronItem')]//@*" value=""/>
            </xf:action>
            <xf:help>Ajouter un évènement</xf:help>
        </xf:trigger>
    </xf:group>
    
    <pre>
        <xf:output value="serialize(., 'yes')"/>
    </pre>
    <pre>
        <xf:output value="serialize(instance('iterator'), 'yes')"/>
    </pre>
    <xf:submit submission="submitBio">
        <xf:label>Enregistrer</xf:label>
    </xf:submit>

    <xf:group ref="instance('xprSource')">
        <xf:label>Sources</xf:label>
        <xf:input ref=".">
            <xf:label>référence</xf:label>
        </xf:input>
    </xf:group>
    <xf:submit submission="submitSource">
        <xf:label>Enregistrer</xf:label>
    </xf:submit>

</form>
