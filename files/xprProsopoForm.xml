<form xmlns:xf="http://www.w3.org/2002/xforms" xmlns:ev="http://www.w3.org/2001/xml-events">
    <xf:switch>
        <xf:case id="prosopoPanel" selected="true">
            <!-- identity -->
            <xf:group ref="instance('xprProsopo')//eac:cpfDescription/eac:identity">
                <xf:label>Identité</xf:label>
                <xf:select1 bind="entityType" appearance="full">
                    <xf:label>Type d'entité</xf:label>
                    <xf:item>
                        <xf:label>personne</xf:label>
                        <xf:value>person</xf:value>
                        <xf:action ev:event="xforms-select">
                            <xf:setvalue ref="instance('xprProsopo')//eac:cpfDescription/eac:identity/@localType" value=""/>
                            <xf:delete ref="instance('xprProsopo')//eac:nameEntry[child::eac:alternativeForm]"/>
                            <xf:insert origin="instance('xprSupplement')/eac:nameEntry" nodeset="instance('xprProsopo')//eac:nameEntry[child::eac:authorizedForm]" position="after"/>
                            <xf:delete ref="instance('xprProsopo')//eac:cpfDescription/eac:identity/eac:nameEntry[child::eac:alternativeForm]//eac:part[@localType='officeName']"/>
                        </xf:action>
                    </xf:item>
                    <xf:item>
                        <xf:label>office</xf:label>
                        <xf:value>corporateBody</xf:value>
                        <xf:action ev:event="xforms-select">
                            <xf:setvalue ref="instance('xprProsopo')//eac:cpfDescription/eac:identity/@localType" value=""/>
                            <xf:delete ref="instance('xprProsopo')//eac:nameEntry[child::eac:alternativeForm]"/>
                            <xf:insert origin="instance('xprSupplement')/eac:nameEntry" nodeset="instance('xprProsopo')//eac:nameEntry[child::eac:authorizedForm]" position="after"/>
                            <xf:delete ref="instance('xprProsopo')//eac:cpfDescription/eac:identity/eac:nameEntry[child::eac:alternativeForm]//eac:part[not(@localType='officeName')]"/>
                        </xf:action>
                    </xf:item>
                    <xf:item>
                        <xf:label>famille</xf:label>
                        <xf:value>family</xf:value>
                        <xf:action ev:event="xforms-select">
                            <xf:delete ref="instance('xprProsopo')//eac:nameEntry[child::eac:alternativeForm]"/>
                            <xf:setvalue ref="instance('xprProsopo')//eac:cpfDescription/eac:identity/@localType" value="'family'"/>
                            <xf:insert origin="instance('xprSupplement')/eac:nameEntry" nodeset="instance('xprProsopo')//eac:nameEntry[child::eac:authorizedForm]" position="after"/>
                            <xf:delete ref="instance('xprProsopo')//eac:cpfDescription/eac:identity/eac:nameEntry[child::eac:alternativeForm]//eac:part[not(@localType='surname')]"/>
                        </xf:action>
                    </xf:item>
                </xf:select1>
                <xf:select1 ref="@localType" appearance="full">
                    <!-- @todo changer le label -->
                    <xf:label>Qualité</xf:label>
                    <xf:itemset nodeset="instance('xprEntitiesTypes')/identity[@type = instance('xprProsopo')//eac:entityType]">
                        <xf:label ref="label"/>
                        <xf:value ref="value"/>
                    </xf:itemset>
                </xf:select1>
                <xf:group>
                    <xf:label>Forme(s) du nom</xf:label>
                    <xf:input ref="eac:nameEntry[child::eac:authorizedForm]eac:part" incremental="true">
                        <xf:label>Forme contrôlée</xf:label>
                    </xf:input>
                    <xf:select1 ref="instance('xprIdentities')/eac:identity">
                        <xf:label>Établir la vedette à partir d'une forme attestée</xf:label>
                        <!-- @todo voir avec EC pour le détail, pour l'instant uniquement nom et prénom(s)-->
                        <xf:item>
                            <xf:label/>
                            <xf:value/>
                        </xf:item>
                        <xf:itemset nodeset="instance('xprProsopo')//eac:nameEntry[child::eac:alternativeForm]">
                            <!--<xf:label value="concat(eac:part[@localType='officeName'], eac:part[@localType='surname'], if(ancestor::eac:identity/eac:entityType='person', ', ', ''), eac:part[@localType='forename'])"/>-->
                            <xf:label value="concat(
                                if(instance('xprProsopo')//eac:entityType[. = 'person'], concat(eac:part[@localType='surname'], ', ', eac:part[@localType='forename'], ' (', if(instance('xprProsopo')//eac:existDates//eac:fromDate/@*[not(. = '')], substring(instance('xprProsopo')//eac:existDates//eac:fromDate/@*[not(. = '')], 1, 4), '?'), ' - ', if(instance('xprProsopo')//eac:existDates//eac:toDate/@*[not(. = '')], substring(instance('xprProsopo')//eac:existDates//eac:toDate/@*[not(. = '')], 1, 4), '?'), ')'), ''),
                                if(instance('xprProsopo')//eac:entityType[. = 'corporateBody'], concat(eac:part[@localType='officeName'], ''), ''),
                                if(instance('xprProsopo')//eac:entityType[. = 'family'], concat(eac:part[@localType='surname'], ''), '')
                                )"/>
                            <xf:copy ref="."/>
                        </xf:itemset>
                        <xf:action ev:event="xforms-value-changed" if="instance('xprIdentities')/eac:identity/*:nameEntry//*:part[not(. = '')]">
                            <!-- @rmq lors de la copie le préfixe de l'espace de nom saute => utilisation de '*:element' -->
                            <!--
                         @rmq pour récupérer toutes les valeurs, faire une boucle while 
                         avec une itération (faire une instance('xprIterator') pour boucler
                         sur eac:part qui ne sont pas vides et trouver leur position
                    -->
                            <xf:setvalue ref="instance('xprProsopo')//eac:nameEntry[child::eac:authorizedForm]/eac:part" 
                                value="concat(
                                if(instance('xprProsopo')//eac:entityType[. = 'person'], concat(instance('xprIdentities')/eac:identity/*:nameEntry/*:part[@localType='surname'], ', ', instance('xprIdentities')/eac:identity/*:nameEntry/*:part[@localType='forename'], ' (', if(instance('xprProsopo')//eac:existDates//eac:fromDate/@*[not(. = '')], substring(instance('xprProsopo')//eac:existDates//eac:fromDate/@*[not(. = '')], 1, 4), '?'), ' - ', if(instance('xprProsopo')//eac:existDates//eac:toDate/@*[not(. = '')], substring(instance('xprProsopo')//eac:existDates//eac:toDate/@*[not(. = '')], 1, 4), '?'), ')'), ''),
                                if(instance('xprProsopo')//eac:entityType[. = 'corporateBody'], concat(instance('xprIdentities')/eac:identity/*:nameEntry/*:part[@localType='officeName'], ''), ''),
                                if(instance('xprProsopo')//eac:entityType[. = 'family'], concat(instance('xprIdentities')/eac:identity/*:nameEntry/*:part[@localType='surname'], ''), '')
                                )"/>
                            <!--<xf:setvalue 
                                ref="instance('xprProsopo')//eac:nameEntry[child::eac:authorizedForm]/eac:part" 
                                value="concat(instance('xprIdentities')/eac:identity/*:nameEntry/*:part[@localType='surname'], ', ', instance('xprIdentities')/eac:identity/*:nameEntry/*:part[@localType='forename'], ' (', if(instance('xprProsopo')//eac:existDates//eac:fromDate/@*[not(. = '')], substring(instance('xprProsopo')//eac:existDates//eac:fromDate/@*[not(. = '')], 1, 4), '?'), ' - ', if(instance('xprProsopo')//eac:existDates//eac:toDate/@*[not(. = '')], substring(instance('xprProsopo')//eac:existDates//eac:toDate/@*[not(. = '')], 1, 4), '?'), ')')"/>-->
                        </xf:action>
                        <!--<xf:action ev:event="xforms-value-changed" if="instance('xprProsopo')//eac:entityType[. = 'corporateBody'] and instance('xprIdentities')/eac:identity/*:nameEntry//*:part[not(. = '')]">
                            <xf:setvalue ref="instance('xprProsopo')//eac:nameEntry[child::eac:authorizedForm]/eac:part" value="instance('xprIdentities')/eac:identity/*:nameEntry/*:part[@localType='officeName']"/>
                        </xf:action>
                        <xf:action ev:event="xforms-value-changed" if="instance('xprProsopo')//eac:entityType[. = 'family'] and instance('xprIdentities')/eac:identity/*:nameEntry//*:part[not(. = '')]">
                            <xf:setvalue ref="instance('xprProsopo')//eac:nameEntry[child::eac:authorizedForm]/eac:part" value="instance('xprIdentities')/eac:identity/*:nameEntry/*:part[@localType='surname']"/>
                        </xf:action>-->
                    </xf:select1>
                    <xf:repeat id="repeatName" nodeset="eac:nameEntry[child::eac:alternativeForm]" appearance="full">
                        <xf:label>Forme attestée</xf:label>
                        <xf:input ref="eac:part[@localType='surname']">
                            <xf:label>Nom</xf:label>
                        </xf:input>
                        <xf:input ref="eac:part[@localType='forename']">
                            <xf:label>Prénom</xf:label>
                        </xf:input>
                        <xf:input ref="eac:part[@localType='particle']">
                            <xf:label>Particule</xf:label>
                        </xf:input>
                        <xf:input ref="eac:part[@localType='common']">
                            <xf:label>Titre d'appel</xf:label>
                        </xf:input>
                        <xf:input ref="eac:part[@localType='formal']">
                            <xf:label>Titre institutionnel</xf:label>
                        </xf:input>
                        <xf:input ref="eac:part[@localType='academic']">
                            <xf:label>Titre académique</xf:label>
                        </xf:input>
                        <xf:input ref="eac:part[@localType='religious']">
                            <xf:label>Titre religieux</xf:label>
                        </xf:input>
                        <xf:input ref="eac:part[@localType='nobiliary']">
                            <xf:label>Titre de noblesse</xf:label>
                        </xf:input>
                        <xf:input ref="eac:part[@localType='officeName']">
                            <xf:label>Dénomination</xf:label>
                        </xf:input>
                        <xf:repeat id="repeatNameSource" nodeset="xpr:source">
                            <xf:select1 ref="@*[local-name() = 'href']" appearance="minimal" incremental="true">
                                <xf:label>Source</xf:label>
                                <xf:itemset bind="bindSource">
                                    <xf:label value="."/>
                                    <xf:value ref="."/>
                                    <!--<xf:action ev:event="xforms-select">
                                        <xf:insert origin="instance('xprSupplement')/eac:source" context="instance('xprProsopo')//eac:sources" position="after"/>
                                        <xf:setvalue ref="instance('xprProsopo')//eac:sources/eac:source/@*[local-name() = 'href']" value="current()"/>
                                    </xf:action>
                                    <xf:action ev:event="xforms-deselect">
                                        <xf:delete ref="instance('xprProsopo')//eac:sources/eac:source[@*[local-name() = 'href'] = current()]"/>
                                    </xf:action>-->
                                </xf:itemset>
                            </xf:select1>
                            <xf:input ref=".">
                                <xf:label>commentaire</xf:label>
                            </xf:input>
                            <xf:trigger ref="." class="delete">
                                <xf:label>Supprimer une source</xf:label>
                                <xf:delete nodeset="." at="1" if="count(ancestor::eac:nameEntry/xpr:source) &gt; 1" ev:event="DOMActivate"/>
                                <xf:help>Supprimer une source</xf:help>
                            </xf:trigger>
                        </xf:repeat>
                        <xf:trigger class="insert">
                            <xf:label>Nouvelle source</xf:label>
                            <!--<xf:action ev:event="DOMActivate">
                                <xf:insert nodeset="xpr:source" at="index('repeatNameSource')" position="after" ev:event="DOMActivate"/>
                                <xf:setvalue ref="xpr:source[index('repeatNameSource')]/@*[local-name() = 'href']" value=""/>
                                <xf:setvalue ref="xpr:source[index('repeatNameSource')]" value=""/>
                            </xf:action>-->
                            <xf:action ev:event="DOMActivate">
                                <xf:insert nodeset="xpr:source" at="last()" position="after" ev:event="DOMActivate"/>
                                <xf:setvalue ref="xpr:source[last()]/@*[local-name() = 'href']" value=""/>
                                <xf:setvalue ref="xpr:source[last()]" value=""/>
                            </xf:action>
                            <xf:help>Ajouter une source</xf:help>
                        </xf:trigger>
                        <xf:trigger ref="self::node()[./eac:alternativeForm]" class="delete">
                            <xf:label>Supprimer une forme du nom</xf:label>
                            <xf:delete nodeset="." at="1" if="count(instance('xprProsopo')//eac:nameEntry[child::eac:alternativeForm]) &gt; 1" ev:event="DOMActivate"/>
                            <xf:help>Supprimer une forme du nom</xf:help>
                        </xf:trigger>
                    </xf:repeat>
                    <xf:trigger ref="self::node()[.//eac:alternativeForm]" class="insert">
                        <xf:label>Nouvelle forme attestée du nom</xf:label>
                        <!--<xf:action ev:event="DOMActivate">
                            <xf:insert nodeset="eac:nameEntry[child::eac:alternativeForm]" at="index('repeatName')" position="after" ev:event="DOMActivate"/>
                            <xf:setvalue ref="eac:nameEntry[child::eac:alternativeForm][index('repeatName')]//eac:part" value=""/>
                            <xf:setvalue ref="eac:nameEntry[child::eac:alternativeForm][index('repeatName')]//xpr:source/@*[local-name() = 'href']" value=""/>
                            <xf:setvalue ref="eac:nameEntry[child::eac:alternativeForm][index('repeatName')]//xpr:source" value=""/>
                            <xf:delete ref="eac:nameEntry[child::eac:alternativeForm][index('repeatName')]//xpr:source[position() &gt; 1]"/>
                        </xf:action>-->
                        <xf:action ev:event="DOMActivate">
                            <xf:insert nodeset="eac:nameEntry[child::eac:alternativeForm]" at="last()" position="after" ev:event="DOMActivate"/>
                            <xf:setvalue ref="eac:nameEntry[child::eac:alternativeForm][last()]//eac:part" value=""/>
                            <xf:setvalue ref="eac:nameEntry[child::eac:alternativeForm][last()]//xpr:source/@*[local-name() = 'href']" value=""/>
                            <xf:setvalue ref="eac:nameEntry[child::eac:alternativeForm][last()]//xpr:source" value=""/>
                            <xf:delete ref="eac:nameEntry[child::eac:alternativeForm][last()]//xpr:source[position() &gt; 1]"/>
                        </xf:action>
                        <xf:help>Ajouter une forme attestée du nom</xf:help>
                    </xf:trigger>
                </xf:group>
            </xf:group>
            <xf:group ref="instance('xprProsopo')/eac:cpfDescription/eac:description/eac:existDates/eac:dateRange">
                <xf:label>Existence</xf:label>
                <xf:group ref="eac:fromDate">
                    <xf:label>Naissance</xf:label>
                    <xf:input ref="@standardDate">
                        <xf:label>Certaine</xf:label>
                    </xf:input>
                    <xf:input ref="@notAfter">
                        <xf:label>Avant le</xf:label>
                    </xf:input>
                    <xf:input ref="@notBefore">
                        <xf:label>Après le</xf:label>
                    </xf:input>
                </xf:group>
                <xf:group ref="eac:toDate">
                    <xf:label>Décès</xf:label>
                    <xf:input ref="@standardDate">
                        <xf:label>Certaine</xf:label>
                    </xf:input>
                    <xf:input ref="@notAfter">
                        <xf:label>Avant le</xf:label>
                    </xf:input>
                    <xf:input ref="@notBefore">
                        <xf:label>Après le</xf:label>
                    </xf:input>
                </xf:group>
            </xf:group>

            <xf:group ref="instance('xprProsopo')/eac:cpfDescription/eac:description/eac:occupations">
                <xf:label>Occupations</xf:label>
                <xf:repeat id="repeatOccupation" nodeset="eac:occupation">
                    <xf:input ref="eac:term">
                        <xf:label>Intitulé</xf:label>
                    </xf:input>
                    <xf:group ref="eac:date">
                        <xf:label>Date</xf:label>
                        <xf:trigger>
                            <xf:label>Intervalle</xf:label>
                            <xf:action ev:event="DOMActivate" if="self::eac:date">
                                <xf:insert origin="instance('xprSupplement')/eac:dateRange" nodeset="./ancestor::eac:occupation/eac:term" position="after"/>
                                <xf:setvalue ref="./ancestor::eac:occupation/eac:dateRange/eac:fromDate/@standardDate" value="current()/@standardDate"/>
                                <xf:setvalue ref="./ancestor::eac:occupation/eac:dateRange/eac:fromDate/@notAfter" value="current()/@notAfter"/>
                                <xf:setvalue ref="./ancestor::eac:occupation/eac:dateRange/eac:fromDate/@notBefore" value="current()/@notBefore"/>
                                <xf:delete nodeset="."/>
                            </xf:action>
                        </xf:trigger>
                        <xf:input ref="@standardDate">
                            <xf:label>Certaine</xf:label>
                        </xf:input>
                        <xf:input ref="@notAfter">
                            <xf:label>Avant le</xf:label>
                        </xf:input>
                        <xf:input ref="@notBefore">
                            <xf:label>Après le</xf:label>
                        </xf:input>
                    </xf:group>
                    <xf:group ref="eac:dateRange">
                        <xf:label>Intervalle</xf:label>
                        <xf:trigger>
                            <xf:label>Date unique</xf:label>
                            <xf:action ev:event="DOMActivate" if="self::eac:dateRange">
                                <xf:insert origin="instance('xprSupplement')/eac:date" nodeset="./ancestor::eac:occupation/eac:term" position="after"/>
                                <xf:setvalue ref="./ancestor::eac:occupation/eac:date/@standardDate" value="current()/eac:fromDate/@standardDate"/>
                                <xf:setvalue ref="./ancestor::eac:occupation/eac:date/@notAfter" value="current()/eac:fromDate/@notAfter"/>
                                <xf:setvalue ref="./ancestor::eac:occupation/eac:date/@notBefore" value="current()/eac:fromDate/@notBefore"/>
                                <xf:delete nodeset="."/>
                            </xf:action>
                        </xf:trigger>
                        <xf:group ref="eac:fromDate">
                            <xf:label>Début</xf:label>
                            <xf:input ref="@standardDate">
                                <xf:label>Certaine</xf:label>
                            </xf:input>
                            <xf:input ref="@notAfter">
                                <xf:label>Avant le</xf:label>
                            </xf:input>
                            <xf:input ref="@notBefore">
                                <xf:label>Après le</xf:label>
                            </xf:input>
                        </xf:group>
                        <xf:group ref="eac:toDate">
                            <xf:label>Fin</xf:label>
                            <xf:input ref="@standardDate">
                                <xf:label>Certaine</xf:label>
                            </xf:input>
                            <xf:input ref="@notAfter">
                                <xf:label>Avant le</xf:label>
                            </xf:input>
                            <xf:input ref="@notBefore">
                                <xf:label>Après le</xf:label>
                            </xf:input>
                        </xf:group>
                    </xf:group>
                    <xf:input ref="eac:descriptiveNote">
                        <xf:label>Note</xf:label>
                    </xf:input>
                    <xf:trigger class="delete">
                        <xf:label>Supprimer une occupation</xf:label>
                        <xf:delete nodeset="." at="1" if="count(//eac:cpfDescription/eac:description/eac:occupations/eac:occupation) > 1" ev:event="DOMActivate"/>
                        <xf:help>Supprimer une occupation</xf:help>
                    </xf:trigger>
                </xf:repeat>
                <xf:trigger class="insert">
                    <xf:label>Ajouter une occupation</xf:label>
                    <!--<xf:action ev:event="DOMActivate">
                        <xf:insert nodeset="eac:occupation" at="index('repeatOccupation')" position="after" ev:event="DOMActivate"/>
                        <xf:setvalue ref="eac:occupation[index('repeatOccupation')]//* | eac:occupation[index('repeatOccupation')]//@*" value=""/>
                    </xf:action>-->
                    <xf:action ev:event="DOMActivate">
                        <xf:insert nodeset="eac:occupation" at="last()" position="after" ev:event="DOMActivate"/>
                        <xf:setvalue ref="eac:occupation[last()]//* | eac:occupation[last()]//@*" value=""/>
                    </xf:action>
                    <xf:help>Ajouter une occupation</xf:help>
                </xf:trigger>
            </xf:group>

            <xf:group ref="instance('xprProsopo')/eac:cpfDescription/eac:description/eac:functions">
                <xf:label>Fonctions</xf:label>
                <xf:repeat id="repeatFunction" nodeset="eac:function">
                    <xf:input ref="eac:term">
                        <xf:label>Intitulé</xf:label>
                    </xf:input>
                    <xf:group ref="eac:date">
                        <xf:label>Date</xf:label>
                        <xf:trigger>
                            <xf:label>Intervalle</xf:label>
                            <xf:action ev:event="DOMActivate" if="self::eac:date">
                                <xf:insert origin="instance('xprSupplement')/eac:dateRange" nodeset="./ancestor::eac:function/eac:term" position="after"/>
                                <xf:setvalue ref="./ancestor::eac:function/eac:dateRange/eac:fromDate/@standardDate" value="current()/@standardDate"/>
                                <xf:setvalue ref="./ancestor::eac:function/eac:dateRange/eac:fromDate/@notAfter" value="current()/@notAfter"/>
                                <xf:setvalue ref="./ancestor::eac:function/eac:dateRange/eac:fromDate/@notBefore" value="current()/@notBefore"/>
                                <xf:delete nodeset="."/>
                            </xf:action>
                        </xf:trigger>
                        <xf:input ref="@standardDate">
                            <xf:label>Certaine</xf:label>
                        </xf:input>
                        <xf:input ref="@notAfter">
                            <xf:label>Avant le</xf:label>
                        </xf:input>
                        <xf:input ref="@notBefore">
                            <xf:label>Après le</xf:label>
                        </xf:input>
                    </xf:group>
                    <xf:group ref="eac:dateRange">
                        <xf:label>Intervalle</xf:label>
                        <xf:trigger>
                            <xf:label>Date unique</xf:label>
                            <xf:action ev:event="DOMActivate" if="self::eac:dateRange">
                                <xf:insert origin="instance('xprSupplement')/eac:date" nodeset="./ancestor::eac:function/eac:term" position="after"/>
                                <xf:setvalue ref="./ancestor::eac:function/eac:date/@standardDate" value="current()/eac:fromDate/@standardDate"/>
                                <xf:setvalue ref="./ancestor::eac:function/eac:date/@notAfter" value="current()/eac:fromDate/@notAfter"/>
                                <xf:setvalue ref="./ancestor::eac:function/eac:date/@notBefore" value="current()/eac:fromDate/@notBefore"/>
                                <xf:delete nodeset="."/>
                            </xf:action>
                        </xf:trigger>
                        <xf:group ref="eac:fromDate">
                            <xf:label>Début</xf:label>
                            <xf:input ref="@standardDate">
                                <xf:label>Certaine</xf:label>
                            </xf:input>
                            <xf:input ref="@notAfter">
                                <xf:label>Avant le</xf:label>
                            </xf:input>
                            <xf:input ref="@notBefore">
                                <xf:label>Après le</xf:label>
                            </xf:input>
                        </xf:group>
                        <xf:group ref="eac:toDate">
                            <xf:label>Fin</xf:label>
                            <xf:input ref="@standardDate">
                                <xf:label>Certaine</xf:label>
                            </xf:input>
                            <xf:input ref="@notAfter">
                                <xf:label>Avant le</xf:label>
                            </xf:input>
                            <xf:input ref="@notBefore">
                                <xf:label>Après le</xf:label>
                            </xf:input>
                        </xf:group>
                    </xf:group>
                    <xf:input ref="eac:descriptiveNote">
                        <xf:label>Note</xf:label>
                    </xf:input>
                    <xf:trigger class="delete">
                        <xf:label>Supprimer une fonction</xf:label>
                        <xf:delete nodeset="." at="1" if="count(//eac:cpfDescription/eac:description/eac:functions/eac:function) > 1" ev:event="DOMActivate"/>
                        <xf:help>Supprimer une fonction</xf:help>
                    </xf:trigger>
                </xf:repeat>
                <xf:trigger class="insert">
                    <xf:label>Ajouter une fonction</xf:label>
                    <!--<xf:action ev:event="DOMActivate">
                        <xf:insert nodeset="eac:function" at="index('repeatFunction')" position="after" ev:event="DOMActivate"/>
                        <xf:setvalue ref="eac:function[index('repeatFunction')]//* | eac:function[index('repeatFunction')]//@*" value=""/>
                    </xf:action>-->
                    <xf:action ev:event="DOMActivate">
                        <xf:insert nodeset="eac:function" at="last()" position="after" ev:event="DOMActivate"/>
                        <xf:setvalue ref="eac:function[last()]//* | eac:function[last()]//@*" value=""/>
                    </xf:action>
                    <xf:help>Ajouter une fonction</xf:help>
                </xf:trigger>
            </xf:group>

            <xf:group ref="instance('xprProsopo')/eac:cpfDescription/eac:description/eac:biogHist/eac:chronList">
                <xf:label>Événements</xf:label>
                <xf:repeat id="repeatChronItem" bind="chronItem" appearance="full">
                    <xf:label>Événement</xf:label>
                    <xf:select1 ref="@localType">
                        <xf:itemset nodeset="instance('xprEvents')/type">
                            <xf:label ref="label"/>
                            <xf:value ref="value"/>
                        </xf:itemset>
                        <xf:action ev:event="xforms-value-changed">
                            <xf:delete nodeset="./ancestor::eac:chronItem/xpr:cost"/>
                        </xf:action>
                        <xf:action ev:event="xforms-value-changed" if="self::node()[. = 'officePurchase' or . = 'officeSale']">
                            <xf:insert origin="instance('xprSupplement')/xpr:cost" nodeset="./ancestor::eac:chronItem/eac:event" position="after"/>
                        </xf:action>
                    </xf:select1>
                    <xf:group ref="eac:date">
                        <xf:label>Date</xf:label>
                        <xf:trigger>
                            <xf:label>Intervalle</xf:label>
                            <xf:action ev:event="DOMActivate" if="self::eac:date">
                                <xf:insert origin="instance('xprSupplement')/eac:dateRange" nodeset="./ancestor::eac:chronItem/*[1]" position="before"/>
                                <xf:setvalue ref="./ancestor::eac:chronItem/eac:dateRange/eac:fromDate/@standardDate" value="current()/@standardDate"/>
                                <xf:setvalue ref="./ancestor::eac:chronItem/eac:dateRange/eac:fromDate/@notAfter" value="current()/@notAfter"/>
                                <xf:setvalue ref="./ancestor::eac:chronItem/eac:dateRange/eac:fromDate/@notBefore" value="current()/@notBefore"/>
                                <xf:delete nodeset="."/>
                            </xf:action>
                        </xf:trigger>
                        <xf:input ref="@standardDate">
                            <xf:label>Certaine</xf:label>
                        </xf:input>
                        <xf:input ref="@notAfter">
                            <xf:label>Avant le</xf:label>
                        </xf:input>
                        <xf:input ref="@notBefore">
                            <xf:label>Après le</xf:label>
                        </xf:input>
                    </xf:group>
                    <xf:group ref="eac:dateRange">
                        <xf:label>Intervalle</xf:label>
                        <xf:trigger>
                            <xf:label>Date unique</xf:label>
                            <xf:action ev:event="DOMActivate" if="self::eac:dateRange">
                                <xf:insert origin="instance('xprSupplement')/eac:date" nodeset="./ancestor::eac:chronItem/*[1]" position="before"/>
                                <xf:setvalue ref="./ancestor::eac:chronItem/eac:date/@standardDate" value="current()/eac:fromDate/@standardDate"/>
                                <xf:setvalue ref="./ancestor::eac:chronItem/eac:date/@notAfter" value="current()/eac:fromDate/@notAfter"/>
                                <xf:setvalue ref="./ancestor::eac:chronItem/eac:date/@notBefore" value="current()/eac:fromDate/@notBefore"/>
                                <xf:delete nodeset="."/>
                            </xf:action>
                        </xf:trigger>
                        <xf:group ref="eac:fromDate">
                            <xf:label>Début</xf:label>
                            <xf:input ref="@standardDate">
                                <xf:label>Certaine</xf:label>
                            </xf:input>
                            <xf:input ref="@notAfter">
                                <xf:label>Avant le</xf:label>
                            </xf:input>
                            <xf:input ref="@notBefore">
                                <xf:label>Après le</xf:label>
                            </xf:input>
                        </xf:group>
                        <xf:group ref="eac:toDate">
                            <xf:label>Fin</xf:label>
                            <xf:input ref="@standardDate">
                                <xf:label>Certaine</xf:label>
                            </xf:input>
                            <xf:input ref="@notAfter">
                                <xf:label>Avant le</xf:label>
                            </xf:input>
                            <xf:input ref="@notBefore">
                                <xf:label>Après le</xf:label>
                            </xf:input>
                        </xf:group>
                    </xf:group>
                    <xf:input ref="eac:placeEntry">
                        <xf:label>Lieu</xf:label>
                    </xf:input>
                    <xf:input ref="eac:event">
                        <xf:label>Intitulé</xf:label>
                    </xf:input>
                    <xf:input ref="xpr:cost">
                        <xf:label>Coût</xf:label>
                    </xf:input>
                    <xf:repeat id="repeatParticipant" nodeset="rico:participant">
                        <xf:label>Participant</xf:label>
                        <xf:select1 ref="@*[local-name() = 'href']" incremental="true">
                            <xf:itemset bind="bindParticipant">
                                <xf:label ref="."/>
                                <xf:value ref="@xml:id"/>
                            </xf:itemset>
                        </xf:select1>
                        <xf:trigger class="delete">
                            <xf:label>Supprimer un participant</xf:label>
                            <xf:delete nodeset="." at="1" if="count(//eac:cpfDescription/eac:description/eac:biogHist/eac:chronList/eac:chronItem/rico:participant) > 1" ev:event="DOMActivate"/>
                            <xf:help>Supprimer un participant</xf:help>
                        </xf:trigger>
                    </xf:repeat>
                    <xf:trigger class="insert">
                        <xf:label>Ajouter un participant</xf:label>
                        <!--<xf:action ev:event="DOMActivate">
                            <xf:insert nodeset="rico:participant" at="index('repeatParticipant')" position="after" ev:event="DOMActivate"/>
                            <xf:setvalue ref="rico:participant[index('repeatParticipant')]//* | rico:participant[index('repeatParticipant')]//@*" value=""/>
                        </xf:action>-->
                        <xf:action ev:event="DOMActivate">
                            <xf:insert nodeset="rico:participant" at="last()" position="after" ev:event="DOMActivate"/>
                            <xf:setvalue ref="rico:participant[last()]//* | rico:participant[last()]//@*" value=""/>
                        </xf:action>
                        <xf:help>Ajouter un participant</xf:help>
                    </xf:trigger>

                    <xf:repeat id="repeatInvolve" nodeset="rico:involve">
                        <xf:label>Implique</xf:label>
                        <xf:select1 ref="@*[local-name() = 'href']" incremental="true">
                            <xf:itemset bind="bindParticipant">
                                <xf:label ref="."/>
                                <xf:value ref="@xml:id"/>
                            </xf:itemset>
                        </xf:select1>
                        <xf:trigger class="delete">
                            <xf:label>Supprimer</xf:label>
                            <xf:delete nodeset="." at="1" if="count(//eac:cpfDescription/eac:description/eac:biogHist/eac:chronList/eac:chronItem/rico:involve) > 1" ev:event="DOMActivate"/>
                            <xf:help>Supprimer</xf:help>
                        </xf:trigger>
                    </xf:repeat>
                    <xf:trigger class="insert">
                        <xf:label>Ajouter</xf:label>
                        <!--<xf:action ev:event="DOMActivate">
                            <xf:insert nodeset="rico:involve" at="index('repeatInvolve')" position="after" ev:event="DOMActivate"/>
                            <xf:setvalue ref="rico:involve[index('repeatInvolve')]//* | rico:involve[index('repeatInvolve')]//@*" value=""/>
                        </xf:action>-->
                        <xf:action ev:event="DOMActivate">
                            <xf:insert nodeset="rico:involve" at="last()" position="after" ev:event="DOMActivate"/>
                            <xf:setvalue ref="rico:involve[last()]//* | rico:involve[last()]//@*" value=""/>
                        </xf:action>
                        <xf:help>Ajouter</xf:help>
                    </xf:trigger>
                    <xf:repeat id="repeatEventSource" nodeset="xpr:source">
                        <xf:select1 ref="@*[local-name() = 'href']" appearance="minimal" incremental="true">
                            <xf:label>Source</xf:label>
                            <xf:itemset bind="bindSource">
                                <xf:label value="."/>
                                <xf:value ref="."/>
                            </xf:itemset>
                        </xf:select1>
                        <xf:input ref=".">
                            <xf:label>commentaire</xf:label>
                        </xf:input>
                        <xf:trigger ref="." class="delete">
                            <xf:label>Supprimer une source</xf:label>
                            <xf:delete nodeset="." at="1" if="count(ancestor::eac:chronItem/xpr:source) &gt; 1" ev:event="DOMActivate"/>
                            <xf:help>Supprimer une source</xf:help>
                        </xf:trigger>
                    </xf:repeat>
                    <xf:trigger class="insert">
                        <xf:label>Nouvelle source</xf:label>
                        <!--<xf:action ev:event="DOMActivate">
                            <xf:insert nodeset="xpr:source" at="index('repeatEventSource')" position="after" ev:event="DOMActivate"/>
                            <xf:setvalue ref="xpr:source[index('repeatEventSource')]/@*[local-name() = 'href']" value=""/>
                            <xf:setvalue ref="xpr:source[index('repeatEventSource')]" value=""/>
                        </xf:action>-->
                        <xf:action ev:event="DOMActivate">
                            <xf:insert nodeset="xpr:source" at="last()" position="after" ev:event="DOMActivate"/>
                            <xf:setvalue ref="xpr:source[last()]/@*[local-name() = 'href']" value=""/>
                            <xf:setvalue ref="xpr:source[last()]" value=""/>
                        </xf:action>
                        <xf:help>Ajouter une source</xf:help>
                    </xf:trigger>
                    <xf:trigger class="delete">
                        <xf:label>Supprimer un événement</xf:label>
                        <xf:delete nodeset="." at="1" if="count(//eac:cpfDescription/eac:description/eac:biogHist/eac:chronList/eac:chronItem) > 1" ev:event="DOMActivate"/>
                        <xf:help>Supprimer un événement</xf:help>
                    </xf:trigger>
                </xf:repeat>
                <xf:trigger class="insert">
                    <xf:label>Ajouter un événement</xf:label>
                    <!--<xf:action ev:event="DOMActivate">
                        <xf:insert nodeset="eac:chronItem" at="index('repeatChronItem')" position="after" ev:event="DOMActivate"/>
                        <xf:delete ref="eac:chronItem[index('repeatChronItem')]/xpr:source[position() &gt; 1]"/>
                        <xf:delete ref="eac:chronItem[index('repeatChronItem')]/xpr:cost"/>
                        <xf:setvalue ref="eac:chronItem[index('repeatChronItem')]//* | eac:chronItem[index('repeatChronItem')]//@*" value=""/>
                    </xf:action>-->
                    <xf:action ev:event="DOMActivate">
                        <xf:insert nodeset="eac:chronItem" at="last()" position="after" ev:event="DOMActivate"/>
                        <xf:delete ref="eac:chronItem[last()]/xpr:source[position() &gt; 1]"/>
                        <xf:delete ref="eac:chronItem[last()]/xpr:cost"/>
                        <xf:setvalue ref="eac:chronItem[last()]//* | eac:chronItem[last()]//@*" value=""/>
                    </xf:action>
                    <xf:help>Ajouter un événement</xf:help>
                </xf:trigger>
            </xf:group>

            <xf:submit submission="submitBio">
                <xf:label>Enregistrer</xf:label>
            </xf:submit>
        </xf:case>
        <xf:case id="newEntity">
            <!-- identity -->
            <xf:group ref="instance('xprNewEntity')//eac:cpfDescription/eac:identity">
                <xf:label>Identité</xf:label>
                <xf:select1 bind="newEntityType" appearance="full">
                    <xf:label>Type d'entité</xf:label>
                    <xf:item>
                        <xf:label>personne</xf:label>
                        <xf:value>person</xf:value>
                        <xf:action ev:event="xforms-select">
                            <xf:setvalue ref="instance('xprNewEntity')//eac:cpfDescription/eac:identity/@localType" value=""/>
                            <xf:delete ref="instance('xprNewEntity')//eac:nameEntry[child::eac:alternativeForm]"/>
                            <xf:insert origin="instance('xprSupplement')/eac:nameEntry" nodeset="instance('xprNewEntity')//eac:nameEntry[child::eac:authorizedForm]" position="after"/>
                            <xf:delete ref="instance('xprNewEntity')//eac:cpfDescription/eac:identity/eac:nameEntry[child::eac:alternativeForm]//eac:part[@localType='officeName']"/>
                        </xf:action>
                    </xf:item>
                    <xf:item>
                        <xf:label>office</xf:label>
                        <xf:value>corporateBody</xf:value>
                        <xf:action ev:event="xforms-select">
                            <xf:setvalue ref="instance('xprNewEntity')//eac:cpfDescription/eac:identity/@localType" value=""/>
                            <xf:delete ref="instance('xprNewEntity')//eac:nameEntry[child::eac:alternativeForm]"/>
                            <xf:insert origin="instance('xprSupplement')/eac:nameEntry" nodeset="instance('xprNewEntity')//eac:nameEntry[child::eac:authorizedForm]" position="after"/>
                            <xf:delete ref="instance('xprNewEntity')//eac:cpfDescription/eac:identity/eac:nameEntry[child::eac:alternativeForm]//eac:part[not(@localType='officeName')]"/>
                        </xf:action>
                    </xf:item>
                    <xf:item>
                        <xf:label>famille</xf:label>
                        <xf:value>family</xf:value>
                        <xf:action ev:event="xforms-select">
                            <xf:delete ref="instance('xprNewEntity')//eac:nameEntry[child::eac:alternativeForm]"/>
                            <xf:setvalue ref="instance('xprNewEntity')//eac:cpfDescription/eac:identity/@localType" value="'family'"/>
                            <xf:insert origin="instance('xprSupplement')/eac:nameEntry" nodeset="instance('xprNewEntity')//eac:nameEntry[child::eac:authorizedForm]" position="after"/>
                            <xf:delete ref="instance('xprNewEntity')//eac:cpfDescription/eac:identity/eac:nameEntry[child::eac:alternativeForm]//eac:part[not(@localType='surname')]"/>
                        </xf:action>
                    </xf:item>
                </xf:select1>
                <xf:select1 ref="@localType" appearance="full">
                    <!-- @todo changer le label -->
                    <xf:label>Qualité</xf:label>
                    <xf:itemset nodeset="instance('xprEntitiesTypes')/identity[@type = instance('xprNewEntity')//eac:entityType]">
                        <xf:label ref="label"/>
                        <xf:value ref="value"/>
                    </xf:itemset>
                </xf:select1>
                <xf:group>
                    <xf:label>Forme(s) du nom</xf:label>
                    <xf:input ref="eac:nameEntry[child::eac:authorizedForm]eac:part" incremental="true">
                        <xf:label>Forme contrôlée</xf:label>
                    </xf:input>
                    <xf:select1 ref="instance('xprIdentities')/eac:identity[2]">
                        <xf:label>Établir la vedette à partir d'une forme attestée</xf:label>
                        <!-- @todo voir avec EC pour le détail, pour l'instant uniquement nom et prénom(s)-->
                        <xf:item>
                            <xf:label/>
                            <xf:value/>
                        </xf:item>
                        <xf:itemset nodeset="instance('xprNewEntity')//eac:nameEntry[child::eac:alternativeForm]">
                            <!-- @todo -->
                            <!--<xf:label value="concat(eac:part[@localType='officeName'], eac:part[@localType='surname'], if(ancestor::eac:identity/eac:entityType='person', ', ', ''), eac:part[@localType='forename'])"/>
                            -->
                            <xf:label value="concat(
                                if(instance('xprNewEntity')//eac:entityType[. = 'person'], concat(eac:part[@localType='surname'], ', ', eac:part[@localType='forename'], ' (', if(instance('xprNewEntity')//eac:existDates//eac:fromDate/@*[not(. = '')], substring(instance('xprNewEntity')//eac:existDates//eac:fromDate/@*[not(. = '')], 1, 4), '?'), ' - ', if(instance('xprNewEntity')//eac:existDates//eac:toDate/@*[not(. = '')], substring(instance('xprNewEntity')//eac:existDates//eac:toDate/@*[not(. = '')], 1, 4), '?'), ')'), ''),
                                if(instance('xprNewEntity')//eac:entityType[. = 'corporateBody'], concat(eac:part[@localType='officeName'], ''), ''),
                                if(instance('xprNewEntity')//eac:entityType[. = 'family'], concat(eac:part[@localType='surname'], ''), '')
                                )"/>
                            <xf:copy ref="."/>
                        </xf:itemset>
                        <xf:action ev:event="xforms-value-changed" if="instance('xprIdentities')/eac:identity[2]/*:nameEntry//*:part[not(. = '')]">
                            <!-- @rmq lors de la copie le préfixe de l'espace de nom saute => utilisation de '*:element' -->
                            <!--
                         @rmq pour récupérer toutes les valeurs, faire une boucle while 
                         avec une itération (faire une instance('xprIterator') pour boucler
                         sur eac:part qui ne sont pas vides et trouver leur position
                    -->
                            <xf:setvalue ref="instance('xprNewEntity')//eac:nameEntry[child::eac:authorizedForm]/eac:part" 
                                value="concat(
                                if(instance('xprNewEntity')//eac:entityType[. = 'person'], concat(instance('xprIdentities')/eac:identity[2]/*:nameEntry/*:part[@localType='surname'], ', ', instance('xprIdentities')/eac:identity[2]/*:nameEntry/*:part[@localType='forename'], ' (', if(instance('xprNewEntity')//eac:existDates//eac:fromDate/@*[not(. = '')], substring(instance('xprNewEntity')//eac:existDates//eac:fromDate/@*[not(. = '')], 1, 4), '?'), ' - ', if(instance('xprNewEntity')//eac:existDates//eac:toDate/@*[not(. = '')], substring(instance('xprNewEntity')//eac:existDates//eac:toDate/@*[not(. = '')], 1, 4), '?'), ')'), ''),
                                if(instance('xprNewEntity')//eac:entityType[. = 'corporateBody'], concat(instance('xprIdentities')/eac:identity[2]/*:nameEntry/*:part[@localType='officeName'], ''), ''),
                                if(instance('xprNewEntity')//eac:entityType[. = 'family'], concat(instance('xprIdentities')/eac:identity[2]/*:nameEntry/*:part[@localType='surname'], ''), '')
                                )"/>
                            <!--<xf:setvalue ref="instance('xprNewEntity')//eac:nameEntry[child::eac:authorizedForm]/eac:part" value="concat(instance('xprIdentities')/eac:identity[2]/*:nameEntry/*:part[@localType='surname'], ', ', instance('xprIdentities')/eac:identity[2]/*:nameEntry/*:part[@localType='forename'])"/>-->
                        </xf:action>
                        <!--<xf:action ev:event="xforms-value-changed" if="instance('xprNewEntity')//eac:entityType[. = 'corporateBody'] and instance('xprIdentities')/eac:identity[2]/*:nameEntry//*:part[not(. = '')]">
                            <xf:setvalue ref="instance('xprNewEntity')//eac:nameEntry[child::eac:authorizedForm]/eac:part" value="instance('xprIdentities')/eac:identity[2]/*:nameEntry/*:part[@localType='officeName']"/>
                        </xf:action>
                        <xf:action ev:event="xforms-value-changed" if="instance('xprNewEntity')//eac:entityType[. = 'family'] and instance('xprIdentities')/eac:identity[2]/*:nameEntry//*:part[not(. = '')]">
                            <xf:setvalue ref="instance('xprNewEntity')//eac:nameEntry[child::eac:authorizedForm]/eac:part" value="instance('xprIdentities')/eac:identity[2]/*:nameEntry/*:part[@localType='surname']"/>
                        </xf:action>-->
                    </xf:select1>
                    <xf:repeat id="newEntity_repeatName" nodeset="eac:nameEntry[child::eac:alternativeForm]" appearance="full">
                        <xf:label>Forme attestée</xf:label>
                        <xf:input ref="eac:part[@localType='surname']">
                            <xf:label>Nom</xf:label>
                        </xf:input>
                        <xf:input ref="eac:part[@localType='forename']">
                            <xf:label>Prénom</xf:label>
                        </xf:input>
                        <xf:input ref="eac:part[@localType='particle']">
                            <xf:label>Particule</xf:label>
                        </xf:input>
                        <xf:input ref="eac:part[@localType='common']">
                            <xf:label>Titre d'appel</xf:label>
                        </xf:input>
                        <xf:input ref="eac:part[@localType='formal']">
                            <xf:label>Titre institutionnel</xf:label>
                        </xf:input>
                        <xf:input ref="eac:part[@localType='academic']">
                            <xf:label>Titre académique</xf:label>
                        </xf:input>
                        <xf:input ref="eac:part[@localType='religious']">
                            <xf:label>Titre religieux</xf:label>
                        </xf:input>
                        <xf:input ref="eac:part[@localType='nobiliary']">
                            <xf:label>Titre de noblesse</xf:label>
                        </xf:input>
                        <xf:input ref="eac:part[@localType='officeName']">
                            <xf:label>Dénomination</xf:label>
                        </xf:input>
                        <xf:repeat id="newEntity_repeatNameSource-" nodeset="xpr:source">
                            <xf:select1 ref="@*[local-name() = 'href']" appearance="minimal" incremental="true">
                                <xf:label>Source</xf:label>
                                <xf:itemset bind="bindSource">
                                    <xf:label value="."/>
                                    <xf:value ref="."/>
                                </xf:itemset>
                            </xf:select1>
                            <xf:input ref=".">
                                <xf:label>commentaire</xf:label>
                            </xf:input>
                            <xf:trigger ref="." class="delete">
                                <xf:label>Supprimer une source</xf:label>
                                <xf:delete nodeset="." at="1" if="count(ancestor::eac:nameEntry/xpr:source) &gt; 1" ev:event="DOMActivate"/>
                                <xf:help>Supprimer une source</xf:help>
                            </xf:trigger>
                        </xf:repeat>
                        <xf:trigger class="insert">
                            <xf:label>Nouvelle source</xf:label>
                            <!--<xf:action ev:event="DOMActivate">
                                <xf:insert nodeset="xpr:source" at="index('newEntity_repeatNameSource')" position="after" ev:event="DOMActivate"/>
                                <xf:setvalue ref="xpr:source[index('newEntity_repeatNameSource')]/@*[local-name() = 'href']" value=""/>
                                <xf:setvalue ref="xpr:source[index('newEntity_repeatNameSource')]" value=""/>
                            </xf:action>-->
                            <xf:action ev:event="DOMActivate">
                                <xf:insert nodeset="xpr:source" at="last()" position="after" ev:event="DOMActivate"/>
                                <xf:setvalue ref="xpr:source[last()]/@*[local-name() = 'href']" value=""/>
                                <xf:setvalue ref="xpr:source[last()]" value=""/>
                            </xf:action>
                            <xf:help>Ajouter une source</xf:help>
                        </xf:trigger>
                        <xf:trigger ref="self::node()[./eac:alternativeForm]" class="delete">
                            <xf:label>Supprimer une forme du nom</xf:label>
                            <xf:delete nodeset="." at="1" if="count(instance('xprNewEntity')//eac:nameEntry[child::eac:alternativeForm]) &gt; 1" ev:event="DOMActivate"/>
                            <xf:help>Supprimer une forme du nom</xf:help>
                        </xf:trigger>
                    </xf:repeat>
                    <xf:trigger ref="self::node()[.//eac:alternativeForm]" class="insert">
                        <xf:label>Nouvelle forme attestée du nom</xf:label>
                        <!--<xf:action ev:event="DOMActivate">
                            <xf:insert nodeset="eac:nameEntry[child::eac:alternativeForm]" at="index('newEntity_repeatName')" position="after" ev:event="DOMActivate"/>
                            <xf:setvalue ref="eac:nameEntry[child::eac:alternativeForm][index('newEntity_repeatName')]//eac:part" value=""/>
                            <xf:setvalue ref="eac:nameEntry[child::eac:alternativeForm][index('newEntity_repeatName')]//xpr:source/@*[local-name() = 'href']" value=""/>
                            <xf:setvalue ref="eac:nameEntry[child::eac:alternativeForm][index('newEntity_repeatName')]//xpr:source" value=""/>
                            <xf:delete ref="eac:nameEntry[child::eac:alternativeForm][index('newEntity_repeatName')]//xpr:source[position() &gt; 1]"/>
                        </xf:action>-->
                        <xf:action ev:event="DOMActivate">
                            <xf:insert nodeset="eac:nameEntry[child::eac:alternativeForm]" at="last()" position="after" ev:event="DOMActivate"/>
                            <xf:setvalue ref="eac:nameEntry[child::eac:alternativeForm][last()]//eac:part" value=""/>
                            <xf:setvalue ref="eac:nameEntry[child::eac:alternativeForm][last()]//xpr:source/@*[local-name() = 'href']" value=""/>
                            <xf:setvalue ref="eac:nameEntry[child::eac:alternativeForm][last()]//xpr:source" value=""/>
                            <xf:delete ref="eac:nameEntry[child::eac:alternativeForm][last()]//xpr:source[position() &gt; 1]"/>
                        </xf:action>
                        <xf:help>Ajouter une forme attestée du nom</xf:help>
                    </xf:trigger>
                </xf:group>
            </xf:group>
            <xf:group ref="instance('xprNewEntity')/eac:cpfDescription/eac:description/eac:existDates/eac:dateRange">
                <xf:label>Existence</xf:label>
                <xf:group ref="eac:fromDate">
                    <xf:label>Naissance</xf:label>
                    <xf:input ref="@standardDate">
                        <xf:label>Certaine</xf:label>
                    </xf:input>
                    <xf:input ref="@notAfter">
                        <xf:label>Avant le</xf:label>
                    </xf:input>
                    <xf:input ref="@notBefore">
                        <xf:label>Après le</xf:label>
                    </xf:input>
                </xf:group>
                <xf:group ref="eac:toDate">
                    <xf:label>Décès</xf:label>
                    <xf:input ref="@standardDate">
                        <xf:label>Certaine</xf:label>
                    </xf:input>
                    <xf:input ref="@notAfter">
                        <xf:label>Avant le</xf:label>
                    </xf:input>
                    <xf:input ref="@notBefore">
                        <xf:label>Après le</xf:label>
                    </xf:input>
                </xf:group>
            </xf:group>

            <xf:group ref="instance('xprNewEntity')/eac:cpfDescription/eac:description/eac:occupations">
                <xf:label>Occupations</xf:label>
                <xf:repeat id="newEntity_repeatOccupation" nodeset="eac:occupation">
                    <xf:input ref="eac:term">
                        <xf:label>Intitulé</xf:label>
                    </xf:input>
                    <xf:group ref="eac:date">
                        <xf:label>Date</xf:label>
                        <xf:trigger>
                            <xf:label>Intervalle</xf:label>
                            <xf:action ev:event="DOMActivate" if="self::eac:date">
                                <xf:insert origin="instance('xprSupplement')/eac:dateRange" nodeset="./ancestor::eac:occupation/eac:term" position="after"/>
                                <xf:setvalue ref="./ancestor::eac:occupation/eac:dateRange/eac:fromDate/@standardDate" value="current()/@standardDate"/>
                                <xf:setvalue ref="./ancestor::eac:occupation/eac:dateRange/eac:fromDate/@notAfter" value="current()/@notAfter"/>
                                <xf:setvalue ref="./ancestor::eac:occupation/eac:dateRange/eac:fromDate/@notBefore" value="current()/@notBefore"/>
                                <xf:delete nodeset="."/>
                            </xf:action>
                        </xf:trigger>
                        <xf:input ref="@standardDate">
                            <xf:label>Certaine</xf:label>
                        </xf:input>
                        <xf:input ref="@notAfter">
                            <xf:label>Avant le</xf:label>
                        </xf:input>
                        <xf:input ref="@notBefore">
                            <xf:label>Après le</xf:label>
                        </xf:input>
                    </xf:group>
                    <xf:group ref="eac:dateRange">
                        <xf:label>Intervalle</xf:label>
                        <xf:trigger>
                            <xf:label>Date unique</xf:label>
                            <xf:action ev:event="DOMActivate" if="self::eac:dateRange">
                                <xf:insert origin="instance('xprSupplement')/eac:date" nodeset="./ancestor::eac:occupation/eac:term" position="after"/>
                                <xf:setvalue ref="./ancestor::eac:occupation/eac:date/@standardDate" value="current()/eac:fromDate/@standardDate"/>
                                <xf:setvalue ref="./ancestor::eac:occupation/eac:date/@notAfter" value="current()/eac:fromDate/@notAfter"/>
                                <xf:setvalue ref="./ancestor::eac:occupation/eac:date/@notBefore" value="current()/eac:fromDate/@notBefore"/>
                                <xf:delete nodeset="."/>
                            </xf:action>
                        </xf:trigger>
                        <xf:group ref="eac:fromDate">
                            <xf:label>Début</xf:label>
                            <xf:input ref="@standardDate">
                                <xf:label>Certaine</xf:label>
                            </xf:input>
                            <xf:input ref="@notAfter">
                                <xf:label>Avant le</xf:label>
                            </xf:input>
                            <xf:input ref="@notBefore">
                                <xf:label>Après le</xf:label>
                            </xf:input>
                        </xf:group>
                        <xf:group ref="eac:toDate">
                            <xf:label>Fin</xf:label>
                            <xf:input ref="@standardDate">
                                <xf:label>Certaine</xf:label>
                            </xf:input>
                            <xf:input ref="@notAfter">
                                <xf:label>Avant le</xf:label>
                            </xf:input>
                            <xf:input ref="@notBefore">
                                <xf:label>Après le</xf:label>
                            </xf:input>
                        </xf:group>
                    </xf:group>
                    <xf:input ref="eac:descriptiveNote">
                        <xf:label>Note</xf:label>
                    </xf:input>
                    <xf:trigger class="delete">
                        <xf:label>Supprimer une occupation</xf:label>
                        <xf:delete nodeset="." at="1" if="count(//eac:cpfDescription/eac:description/eac:occupations/eac:occupation) > 1" ev:event="DOMActivate"/>
                        <xf:help>Supprimer une occupation</xf:help>
                    </xf:trigger>
                </xf:repeat>
                <xf:trigger class="insert">
                    <xf:label>Ajouter une occupation</xf:label>
                    <!--<xf:action ev:event="DOMActivate">
                        <xf:insert nodeset="eac:occupation" at="index('newEntity_repeatOccupation')" position="after" ev:event="DOMActivate"/>
                        <xf:setvalue ref="eac:occupation[index('newEntity_repeatOccupation')]//* | eac:occupation[index('newEntity_repeatOccupation')]//@*" value=""/>
                    </xf:action>-->
                    <xf:action ev:event="DOMActivate">
                        <xf:insert nodeset="eac:occupation" at="last()" position="after" ev:event="DOMActivate"/>
                        <xf:setvalue ref="eac:occupation[last()]//* | eac:occupation[last()]//@*" value=""/>
                    </xf:action>
                    <xf:help>Ajouter une occupation</xf:help>
                </xf:trigger>
            </xf:group>

            <xf:group ref="instance('xprNewEntity')/eac:cpfDescription/eac:description/eac:functions">
                <xf:label>Fonctions</xf:label>
                <xf:repeat id="newEntity_repeatFunction" nodeset="eac:function">
                    <xf:input ref="eac:term">
                        <xf:label>Intitulé</xf:label>
                    </xf:input>
                    <xf:group ref="eac:date">
                        <xf:label>Date</xf:label>
                        <xf:trigger>
                            <xf:label>Intervalle</xf:label>
                            <xf:action ev:event="DOMActivate" if="self::eac:date">
                                <xf:insert origin="instance('xprSupplement')/eac:dateRange" nodeset="./ancestor::eac:function/eac:term" position="after"/>
                                <xf:setvalue ref="./ancestor::eac:function/eac:dateRange/eac:fromDate/@standardDate" value="current()/@standardDate"/>
                                <xf:setvalue ref="./ancestor::eac:function/eac:dateRange/eac:fromDate/@notAfter" value="current()/@notAfter"/>
                                <xf:setvalue ref="./ancestor::eac:function/eac:dateRange/eac:fromDate/@notBefore" value="current()/@notBefore"/>
                                <xf:delete nodeset="."/>
                            </xf:action>
                        </xf:trigger>
                        <xf:input ref="@standardDate">
                            <xf:label>Certaine</xf:label>
                        </xf:input>
                        <xf:input ref="@notAfter">
                            <xf:label>Avant le</xf:label>
                        </xf:input>
                        <xf:input ref="@notBefore">
                            <xf:label>Après le</xf:label>
                        </xf:input>
                    </xf:group>
                    <xf:group ref="eac:dateRange">
                        <xf:label>Intervalle</xf:label>
                        <xf:trigger>
                            <xf:label>Date unique</xf:label>
                            <xf:action ev:event="DOMActivate" if="self::eac:dateRange">
                                <xf:insert origin="instance('xprSupplement')/eac:date" nodeset="./ancestor::eac:function/eac:term" position="after"/>
                                <xf:setvalue ref="./ancestor::eac:function/eac:date/@standardDate" value="current()/eac:fromDate/@standardDate"/>
                                <xf:setvalue ref="./ancestor::eac:function/eac:date/@notAfter" value="current()/eac:fromDate/@notAfter"/>
                                <xf:setvalue ref="./ancestor::eac:function/eac:date/@notBefore" value="current()/eac:fromDate/@notBefore"/>
                                <xf:delete nodeset="."/>
                            </xf:action>
                        </xf:trigger>
                        <xf:group ref="eac:fromDate">
                            <xf:label>Début</xf:label>
                            <xf:input ref="@standardDate">
                                <xf:label>Certaine</xf:label>
                            </xf:input>
                            <xf:input ref="@notAfter">
                                <xf:label>Avant le</xf:label>
                            </xf:input>
                            <xf:input ref="@notBefore">
                                <xf:label>Après le</xf:label>
                            </xf:input>
                        </xf:group>
                        <xf:group ref="eac:toDate">
                            <xf:label>Fin</xf:label>
                            <xf:input ref="@standardDate">
                                <xf:label>Certaine</xf:label>
                            </xf:input>
                            <xf:input ref="@notAfter">
                                <xf:label>Avant le</xf:label>
                            </xf:input>
                            <xf:input ref="@notBefore">
                                <xf:label>Après le</xf:label>
                            </xf:input>
                        </xf:group>
                    </xf:group>
                    <xf:input ref="eac:descriptiveNote">
                        <xf:label>Note</xf:label>
                    </xf:input>
                    <xf:trigger class="delete">
                        <xf:label>Supprimer une fonction</xf:label>
                        <xf:delete nodeset="." at="1" if="count(//eac:cpfDescription/eac:description/eac:functions/eac:function) > 1" ev:event="DOMActivate"/>
                        <xf:help>Supprimer une fonction</xf:help>
                    </xf:trigger>
                </xf:repeat>
                <xf:trigger class="insert">
                    <xf:label>Ajouter une fonction</xf:label>
                    <!--<xf:action ev:event="DOMActivate">
                        <xf:insert nodeset="eac:function" at="index('newEntity_repeatFunction')" position="after" ev:event="DOMActivate"/>
                        <xf:setvalue ref="eac:function[index('newEntity_repeatFunction')]//* | eac:function[index('newEntity_repeatFunction')]//@*" value=""/>
                    </xf:action>-->
                    <xf:action ev:event="DOMActivate">
                        <xf:insert nodeset="eac:function" at="last()" position="after" ev:event="DOMActivate"/>
                        <xf:setvalue ref="eac:function[last()]//* | eac:function[last()]//@*" value=""/>
                    </xf:action>
                    <xf:help>Ajouter une fonction</xf:help>
                </xf:trigger>
            </xf:group>

            <xf:group ref="instance('xprNewEntity')/eac:cpfDescription/eac:description/eac:biogHist/eac:chronList">
                <xf:label>Événements</xf:label>
                <xf:repeat id="newEntity_repeatChronItem" bind="newChronItem" appearance="full">
                    <xf:label>Événement</xf:label>
                    <xf:select1 ref="@localType">
                        <xf:itemset nodeset="instance('xprEvents')/type">
                            <xf:label ref="label"/>
                            <xf:value ref="value"/>
                        </xf:itemset>
                        <xf:action ev:event="xforms-value-changed">
                            <xf:delete nodeset="./ancestor::eac:chronItem/xpr:cost"/>
                        </xf:action>
                        <xf:action ev:event="xforms-value-changed" if="self::node()[. = 'officePurchase' or . = 'officeSale']">
                            <xf:insert origin="instance('xprSupplement')/xpr:cost" nodeset="./ancestor::eac:chronItem/eac:event" position="after"/>
                        </xf:action>
                    </xf:select1>
                    <xf:group ref="eac:date">
                        <xf:label>Date</xf:label>
                        <xf:trigger>
                            <xf:label>Intervalle</xf:label>
                            <xf:action ev:event="DOMActivate" if="self::eac:date">
                                <xf:insert origin="instance('xprSupplement')/eac:dateRange" nodeset="./ancestor::eac:chronItem/*[1]" position="before"/>
                                <xf:setvalue ref="./ancestor::eac:chronItem/eac:dateRange/eac:fromDate/@standardDate" value="current()/@standardDate"/>
                                <xf:setvalue ref="./ancestor::eac:chronItem/eac:dateRange/eac:fromDate/@notAfter" value="current()/@notAfter"/>
                                <xf:setvalue ref="./ancestor::eac:chronItem/eac:dateRange/eac:fromDate/@notBefore" value="current()/@notBefore"/>
                                <xf:delete nodeset="."/>
                            </xf:action>
                        </xf:trigger>
                        <xf:input ref="@standardDate">
                            <xf:label>Certaine</xf:label>
                        </xf:input>
                        <xf:input ref="@notAfter">
                            <xf:label>Avant le</xf:label>
                        </xf:input>
                        <xf:input ref="@notBefore">
                            <xf:label>Après le</xf:label>
                        </xf:input>
                    </xf:group>
                    <xf:group ref="eac:dateRange">
                        <xf:label>Intervalle</xf:label>
                        <xf:trigger>
                            <xf:label>Date unique</xf:label>
                            <xf:action ev:event="DOMActivate" if="self::eac:dateRange">
                                <xf:insert origin="instance('xprSupplement')/eac:date" nodeset="./ancestor::eac:chronItem/*[1]" position="before"/>
                                <xf:setvalue ref="./ancestor::eac:chronItem/eac:date/@standardDate" value="current()/eac:fromDate/@standardDate"/>
                                <xf:setvalue ref="./ancestor::eac:chronItem/eac:date/@notAfter" value="current()/eac:fromDate/@notAfter"/>
                                <xf:setvalue ref="./ancestor::eac:chronItem/eac:date/@notBefore" value="current()/eac:fromDate/@notBefore"/>
                                <xf:delete nodeset="."/>
                            </xf:action>
                        </xf:trigger>
                        <xf:group ref="eac:fromDate">
                            <xf:label>Début</xf:label>
                            <xf:input ref="@standardDate">
                                <xf:label>Certaine</xf:label>
                            </xf:input>
                            <xf:input ref="@notAfter">
                                <xf:label>Avant le</xf:label>
                            </xf:input>
                            <xf:input ref="@notBefore">
                                <xf:label>Après le</xf:label>
                            </xf:input>
                        </xf:group>
                        <xf:group ref="eac:toDate">
                            <xf:label>Fin</xf:label>
                            <xf:input ref="@standardDate">
                                <xf:label>Certaine</xf:label>
                            </xf:input>
                            <xf:input ref="@notAfter">
                                <xf:label>Avant le</xf:label>
                            </xf:input>
                            <xf:input ref="@notBefore">
                                <xf:label>Après le</xf:label>
                            </xf:input>
                        </xf:group>
                    </xf:group>
                    <xf:input ref="eac:placeEntry">
                        <xf:label>Lieu</xf:label>
                    </xf:input>
                    <xf:input ref="eac:event">
                        <xf:label>Intitulé</xf:label>
                    </xf:input>

                    <xf:repeat id="newEntity_repeatParticipant" nodeset="rico:participant">
                        <xf:label>Participant</xf:label>
                        <xf:select1 ref="@*[local-name() = 'href']" incremental="true">
                            <xf:itemset bind="bindParticipant">
                                <xf:label ref="."/>
                                <xf:value ref="@xml:id"/>
                            </xf:itemset>
                        </xf:select1>
                        <xf:trigger class="delete">
                            <xf:label>Supprimer un participant</xf:label>
                            <xf:delete nodeset="." at="1" if="count(//eac:cpfDescription/eac:description/eac:biogHist/eac:chronList/eac:chronItem/rico:participant) > 1" ev:event="DOMActivate"/>
                            <xf:help>Supprimer un participant</xf:help>
                        </xf:trigger>
                    </xf:repeat>
                    <xf:trigger class="insert">
                        <xf:label>Ajouter un participant</xf:label>
                        <!--<xf:action ev:event="DOMActivate">
                            <xf:insert nodeset="rico:participant" at="index('newEntity_repeatParticipant')" position="after" ev:event="DOMActivate"/>
                            <xf:setvalue ref="rico:participant[index('newEntity_repeatParticipant')]//* | rico:participant[index('newEntity_repeatParticipant')]//@*" value=""/>
                        </xf:action>-->
                        <xf:action ev:event="DOMActivate">
                            <xf:insert nodeset="rico:participant" at="last()" position="after" ev:event="DOMActivate"/>
                            <xf:setvalue ref="rico:participant[last()]//* | rico:participant[last()]//@*" value=""/>
                        </xf:action>
                        <xf:help>Ajouter un participant</xf:help>
                    </xf:trigger>

                    <xf:repeat id="newEntity_repeatInvolve" nodeset="rico:involve">
                        <xf:label>Implique</xf:label>
                        <xf:select1 ref="@*[local-name() = 'href']" incremental="true">
                            <xf:itemset bind="bindParticipant">
                                <xf:label ref="."/>
                                <xf:value ref="@xml:id"/>
                            </xf:itemset>
                        </xf:select1>
                        <!--<xf:input ref="."/>-->
                        <xf:trigger class="delete">
                            <xf:label>Supprimer</xf:label>
                            <xf:delete nodeset="." at="1" if="count(//eac:cpfDescription/eac:description/eac:biogHist/eac:chronList/eac:chronItem/rico:involve) > 1" ev:event="DOMActivate"/>
                            <xf:help>Supprimer</xf:help>
                        </xf:trigger>
                    </xf:repeat>
                    <xf:trigger class="insert">
                        <xf:label>Ajouter</xf:label>
                        <!--<xf:action ev:event="DOMActivate">
                            <xf:insert nodeset="rico:involve" at="index('newEntity_repeatInvolve')" position="after" ev:event="DOMActivate"/>
                            <xf:setvalue ref="rico:involve[index('newEntity_repeatInvolve')]//* | rico:involve[index('newEntity_repeatInvolve')]//@*" value=""/>
                        </xf:action>-->
                        <xf:action ev:event="DOMActivate">
                            <xf:insert nodeset="rico:involve" at="last()" position="after" ev:event="DOMActivate"/>
                            <xf:setvalue ref="rico:involve[last()]//* | rico:involve[last()]//@*" value=""/>
                        </xf:action>
                        <xf:help>Ajouter</xf:help>
                    </xf:trigger>
                    <xf:repeat id="newEntity_repeatEventSource" nodeset="xpr:source">
                        <xf:select1 ref="@*[local-name() = 'href']" appearance="minimal" incremental="true">
                            <xf:label>Source</xf:label>
                            <xf:itemset bind="bindSource">
                                <xf:label value="."/>
                                <xf:value ref="."/>
                            </xf:itemset>
                        </xf:select1>
                        <xf:input ref=".">
                            <xf:label>commentaire</xf:label>
                        </xf:input>
                        <xf:trigger ref="." class="delete">
                            <xf:label>Supprimer une source</xf:label>
                            <xf:delete nodeset="." at="1" if="count(ancestor::eac:chronItem/xpr:source) &gt; 1" ev:event="DOMActivate"/>
                            <xf:help>Supprimer une source</xf:help>
                        </xf:trigger>
                    </xf:repeat>
                    <xf:trigger class="insert">
                        <xf:label>Nouvelle source</xf:label>
                        <!--<xf:action ev:event="DOMActivate">
                            <xf:insert nodeset="xpr:source" at="index('newEntity_repeatEventSource')" position="after" ev:event="DOMActivate"/>
                            <xf:setvalue ref="xpr:source[index('newEntity_repeatEventSource')]/@*[local-name() = 'href']" value=""/>
                            <xf:setvalue ref="xpr:source[index('newEntity_repeatEventSource')]" value=""/>
                        </xf:action>-->
                        <xf:action ev:event="DOMActivate">
                            <xf:insert nodeset="xpr:source" at="last()" position="after" ev:event="DOMActivate"/>
                            <xf:setvalue ref="xpr:source[last()]/@*[local-name() = 'href']" value=""/>
                            <xf:setvalue ref="xpr:source[last()]" value=""/>
                        </xf:action>
                        <xf:help>Ajouter une source</xf:help>
                    </xf:trigger>
                    <xf:trigger class="delete">
                        <xf:label>Supprimer un événement</xf:label>
                        <xf:delete nodeset="." at="1" if="count(//eac:cpfDescription/eac:description/eac:biogHist/eac:chronList/eac:chronItem) > 1" ev:event="DOMActivate"/>
                        <xf:help>Supprimer un événement</xf:help>
                    </xf:trigger>
                </xf:repeat>
                <xf:trigger class="insert">
                    <xf:label>Ajouter un événement</xf:label>
                    <!--<xf:action ev:event="DOMActivate">
                        <xf:insert nodeset="eac:chronItem" at="index('newEntity_repeatChronItem')" position="after" ev:event="DOMActivate"/>
                        <xf:delete ref="eac:chronItem[index('newEntity_repeatChronItem')]/xpr:source[position() &gt; 1]"/>
                        <xf:delete ref="eac:chronItem[index('newEntity_repeatChronItem')]/xpr:cost"/>
                        <xf:setvalue ref="eac:chronItem[index('newEntity_repeatChronItem')]//* | eac:chronItem[index('newEntity_repeatChronItem')]//@*" value=""/>
                    </xf:action>-->
                    <xf:action ev:event="DOMActivate">
                        <xf:insert nodeset="eac:chronItem" at="last()" position="after" ev:event="DOMActivate"/>
                        <xf:delete ref="eac:chronItem[last()]/xpr:source[position() &gt; 1]"/>
                        <xf:delete ref="eac:chronItem[last()]/xpr:cost"/>
                        <xf:setvalue ref="eac:chronItem[last()]//* | eac:chronItem[last()]//@*" value=""/>
                    </xf:action>
                    <xf:help>Ajouter un événement</xf:help>
                </xf:trigger>
            </xf:group>

            <xf:submit submission="submitNewEntity">
                <xf:label>Enregistrer</xf:label>
            </xf:submit>
        </xf:case>
        <xf:case id="sourcesPanel">
            <xf:group ref="instance('xprProsopo')/eac:control/eac:sources">
                <xf:trigger>
                    <xf:label>Ajouter une source</xf:label>
                    <xf:action ev:event="DOMActivate">
                        <xf:insert origin="instance('xprSupplement')/eac:source" context="instance('xprProsopo')//eac:sources"/>
                    </xf:action>
                </xf:trigger>
                <xf:repeat id="repeatControlSource" nodeset="eac:source">
                    <xf:select1 ref="@*[local-name() = 'href']" appearance="minimal" incremental="true">
                        <xf:label>Source</xf:label>
                        <xf:itemset bind="bindSource">
                            <xf:label value="."/>
                            <xf:value ref="."/>
                        </xf:itemset>
                    </xf:select1>
                    <xf:input ref="eac:descriptiveNote/eac:p">
                        <xf:label>commentaire</xf:label>
                    </xf:input>
                    <xf:trigger ref="." class="delete">
                        <xf:label>Supprimer une source</xf:label>
                        <xf:delete nodeset="." at="1" ev:event="DOMActivate"/>
                        <xf:help>Supprimer une source</xf:help>
                    </xf:trigger>
                </xf:repeat>
                <xf:trigger>
                    <xf:label>mise à jour des Sources</xf:label>
                    <xf:action ev:event="DOMActivate" while="instance('xprProsopo')//xpr:source/@*[local-name() = 'href'][not(. = '')][not(. = instance('xprProsopo')//eac:control//eac:source/@*[local-name() = 'href'])]">
                        <!-- todo supprimer les éventuelles sources vides dans control source ! -->
                        <xf:insert origin="instance('xprSupplement')/eac:source" context="instance('xprProsopo')//eac:sources"/>
                        <xf:setvalue ref="instance('xprProsopo')//eac:sources/eac:source/@*[local-name() = 'href'][. = '']" value="instance('xprProsopo')//xpr:source/@*[local-name() = 'href'][not(. = instance('xprProsopo')//eac:control//eac:source/@*[local-name() = 'href'])]"/>
                        <xf:setvalue ref="instance('xprProsopo')//eac:sources/eac:source/eac:sourceEntry[. = '']" value="ancestor::eac:source/@*[local-name() = 'href']"/>
                    </xf:action>
                </xf:trigger>
            </xf:group>
            <!--<xf:group ref="instance('xprNewEntity')/eac:control/eac:sources">
                <xf:trigger>
                    <xf:label>Ajouter une new source</xf:label>
                    <xf:action ev:event="DOMActivate">
                        <xf:insert origin="instance('xprSupplement')/eac:source" context="instance('xprNewEntity')//eac:sources"/>
                    </xf:action>
                </xf:trigger>
                <xf:repeat id="repeatControlNewSource" nodeset="eac:source">
                    <xf:select1 ref="@*[local-name() = 'href']" appearance="minimal" incremental="true">
                        <xf:label>Source</xf:label>
                        <xf:itemset bind="bindSource">
                            <xf:label value="."/>
                            <xf:value ref="."/>
                        </xf:itemset>
                    </xf:select1>
                    <xf:input ref="eac:descriptiveNote/eac:p">
                        <xf:label>commentaire</xf:label>
                    </xf:input>
                    <xf:trigger ref="." class="delete">
                        <xf:label>Supprimer une source</xf:label>
                        <xf:delete nodeset="." at="1" ev:event="DOMActivate"/>
                        <xf:help>Supprimer une source</xf:help>
                    </xf:trigger>
                </xf:repeat>
                <xf:trigger>
                    <xf:label>mise à jour des Sources</xf:label>
                    <xf:action ev:event="DOMActivate" while="instance('xprNewEntity')//xpr:source/@*[local-name() = 'href'][not(. = '')][not(. = instance('xprNewEntity')//eac:control//eac:source/@*[local-name() = 'href'])]">
                        <!-\- todo supprimer les éventuelles sources vides dans control source ! -\->
                        <xf:insert origin="instance('xprSupplement')/eac:source" context="instance('xprNewEntity')//eac:sources"/>
                        <xf:setvalue ref="instance('xprNewEntity')//eac:sources/eac:source/@*[local-name() = 'href'][. = '']" value="instance('xprNewEntity')//xpr:source/@*[local-name() = 'href'][not(. = instance('xprNewEntity')//eac:control//eac:source/@*[local-name() = 'href'])]"/>
                        <xf:setvalue ref="instance('xprNewEntity')//eac:sources/eac:source/eac:sourceEntry[. = '']" value="ancestor::eac:source/@*[local-name() = 'href']"/>
                    </xf:action>
                </xf:trigger>
            </xf:group>-->
        </xf:case>
        <xf:case id="newSource">
            <xf:group ref="instance('xprNewSource')">
                <xf:label>Sources</xf:label>
                <xf:input ref=".">
                    <xf:label>référence</xf:label>
                </xf:input>
            </xf:group>
            <xf:submit submission="submitNewSource">
                <xf:label>Enregistrer</xf:label>
            </xf:submit>
            <xf:submit submission="reloadSources">
                <xf:label>Mettre à jour les sources</xf:label>
            </xf:submit>
        </xf:case>
    </xf:switch>

</form>
