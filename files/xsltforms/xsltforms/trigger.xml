<?xml-stylesheet href="xsltforms.xsl" type="text/xsl"?>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:ev="http://www.w3.org/2001/xml-events" xmlns:xf="http://www.w3.org/2002/xforms" xmlns:foo="foo" foo:bogus="ff fix">
    <head>
        <title>xforms-xsltforms</title>
        <xf:model>
            <xf:instance id="flowers">
                <flowers xmlns="foo">
                    <flower>
                        <variety>Tulips</variety>
                        <color ref="rd"/>
                    </flower>
                    <flower>
                        <variety>Daffodils</variety>
                        <color ref=""/>
                    </flower>
                </flowers>
            </xf:instance>
            <xf:instance id="color">
                <colors xmlns="foo">
                    <color id="blk">black</color>
                    <color id="rd">red</color>
                    <color id="grn">green</color>
                </colors>
            </xf:instance>
            <xf:instance id="newColor">
                <colors xmlns="foo">
                    <color type="new" local-id=""/>
                </colors>
            </xf:instance>
        </xf:model>
    </head>
    <body>
        <xf:repeat id="fooflower" nodeset="foo:flower" appearance="full">
            <xf:var name="color" value="."/>
            <xf:label>Flower</xf:label>
            <xf:input ref="foo:variety" incremental="true">
                <xf:label>Variety</xf:label>
            </xf:input>
            <xf:select1 ref="foo:color/@ref" incremental="true">
                <xf:label>Color</xf:label>
                <xf:itemset nodeset="instance('color')/foo:color">
                    <xf:label ref="."/>
                    <xf:value ref="@id | @local-id"/>
                </xf:itemset>
            </xf:select1>
            <xf:trigger ref=".[not(foo:color/@type='new')]">
                <xf:label>Add new color</xf:label>
                <xf:insert ev:event="DOMActivate" context="foo:color" origin="instance('newColor')/foo:color/@type" nodeset="foo:color"/>
                <xf:insert ev:event="DOMActivate" context="instance('color')" origin="instance('newColor')/foo:color" nodeset="foo:color" at="last()" position="after"/>
                <xf:setvalue ev:event="DOMActivate" ref="foo:color/@ref | instance('color')/foo:color[@type='new'][@local-id='']/@local-id" value="concat('local-color-', number(count(instance('color')/foo:color[@type='new'])))"/>
            </xf:trigger>
            <xf:trigger ref=".[foo:color/@type='new']">
                <xf:label>Database color</xf:label>
                <xf:setvalue ev:event="DOMActivate" ref="foo:color/@ref" value="''"/>
                <xf:delete ev:event="DOMActivate" nodeset="foo:color/@type" />
            </xf:trigger>
            <xf:group ref="instance('color')/foo:color[@type='new'][@local-id = $color/foo:color[@type='new']/@ref]">
                <xf:input ref="." incremental="true">
                    <xf:label>New color name</xf:label>
                </xf:input>
            </xf:group>
            <xf:output value="serialize($color, 'xml')"/>
        </xf:repeat>
        
        <xf:repeat nodeset="instance('color')/foo:color">
            <xf:input ref=".">
                <xf:label>Color Name</xf:label>
            </xf:input>
        </xf:repeat>
        <xf:output value="serialize(instance('flowers'), 'xml')"/>
    </body>
</html>
