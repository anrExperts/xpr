<?xml version="1.0" encoding="UTF-8"?>
<xf:model id="source"
          xmlns:xf="http://www.w3.org/2002/xforms"
          xmlns:ev="http://www.w3.org/2001/xml-events">
    <!-- xprSource : main instance to add new sources -->
    <xf:instance id="xprSource"
                 src="/xpr/files/_xprSourceInstance.xml"/>
    <!-- xprSourceRepeat : main instance to add new sources -->
    <xf:instance id="xprSourceCopy"
                 src="/xpr/files/_xprSourceInstance.xml"/>
    <!-- xprSources : list sources -->
    <xf:instance id="xprSources"
                 src="/xpr/sources"/>

    <xf:submission mode="synchronous"
                   id="submitSource"
                   ref="instance('xprSource')"
                   resource="/xpr/sources/put"
                   method="put"
                   replace="none">
        <xf:action ev:event="xforms-submit-done">
            <xf:message level="modal">
                Body : <xf:output value="event('response-body')"/> ;
                Status : <xf:output value="event('response-status-code')"/> ;
                URI : <xf:output value="event('resource-uri')"/> ;
                Headers : <xf:output value="event('response-headers')"/> ;
                Reason : <xf:output value="event('response-reason-phrase')"/>.
            </xf:message>
            <xf:send submission="reloadSources"/>
        </xf:action>

        <xf:action ev:event="xforms-submit-error">
            <xf:message>Votre formulaire n’a pas pu être enregistré, merci de corriger les erreurs</xf:message>
        </xf:action>
    </xf:submission>

    <xf:submission mode="synchronous"
                   id="submitNewSource"
                   ref="instance('xprSource')"
                   resource="/xpr/sources/put"
                   method="put"
                   replace="none">
        <xf:action ev:event="xforms-submit">
            <xf:insert nodeset="instance('xprSource')"
                       origin="instance('xprSources')/xpr:source[@localType = 'new'][@xml:id = instance('xprProsopo')//*:source/@xlink:href][1]"/>
            <xf:delete ref="instance('xprSource')/@localType"/>
            <xf:delete ref="instance('xprSource')/@xlink:href"/>
        </xf:action>
        <xf:action ev:event="xforms-submit-done">
            <xf:message level="modal">
                Body : <xf:output value="event('response-body')"/> ;
                Status : <xf:output value="event('response-status-code')"/> ;
                URI : <xf:output value="event('resource-uri')"/> ;
                Headers : <xf:output value="event('response-headers')"/> ;
                Reason : <xf:output value="event('response-reason-phrase')"/>.
            </xf:message>
            <xf:setvalue ref="instance('xprSources')/xpr:source[@localType = 'new'][. = event('response-body')//*:id]/@localType"
                         value="'stored'"/>
            <xf:setvalue ref="instance('xprProsopo')//*:source[@xlink:href = instance('xprSources')/xpr:source[. = event('response-body')//*:id]/@xml:id]/@xlink:href
                            | instance('xprProsopo')//*:source[@xlink:href = instance('xprSources')/xpr:source[. = event('response-body')//*:id]]/@xlink:href"
                         value="event('response-body')//*:id"/>
            <xf:setvalue ref="instance('xprProsopo')//eac:source[@xlink:href = event('response-body')//*:id][not(./@xlink:href = ./eac:sourceEntry)]/eac:sourceEntry"
                         value="event('response-body')//*:id"/>
            <xf:delete ref="instance('xprProsopo')//*:source[@localType = 'new'][@xlink:href = event('response-body')//*:id]/@localType"/>
        </xf:action>

        <xf:action ev:event="xforms-submit-error">
            <xf:message>Votre formulaire n’a pas pu être enregistré, merci de corriger les erreurs</xf:message>
        </xf:action>
    </xf:submission>
</xf:model>
