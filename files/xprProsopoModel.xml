<xf:model id="prosopo" xmlns:xf="http://www.w3.org/2002/xforms" xmlns:ev="http://www.w3.org/2001/xml-events">
        <!-- xprProsopo -->
        <xf:action ev:event="xforms-ready">
                <xf:action while="instance('xprProsopo')//eac:date[not(@standardDate)] 
                        | instance('xprProsopo')//eac:fromDate[not(@standardDate)] 
                        | instance('xprProsopo')//eac:toDate[not(@standardDate)]" ev:event="xforms-ready">
                        <xf:insert context="instance('xprProsopo')//eac:date[not(@standardDate)] 
                                | instance('xprProsopo')//eac:fromDate[not(@standardDate)] 
                                | instance('xprProsopo')//eac:toDate[not(@standardDate)]" origin="instance('xprSupplement')/eac:date/@standardDate"/>
                </xf:action>
                <xf:action while="instance('xprProsopo')//eac:date[not(@notAfter)]
                        | instance('xprProsopo')//eac:fromDate[not(@notAfter)]
                        | instance('xprProsopo')//eac:toDate[not(@notAfter)]" ev:event="xforms-ready">
                        <xf:insert context="instance('xprProsopo')//eac:date[not(@notAfter)]
                                | instance('xprProsopo')//eac:fromDate[not(@notAfter)]
                                | instance('xprProsopo')//eac:toDate[not(@notAfter)]" origin="instance('xprSupplement')/eac:date/@notAfter"/>
                </xf:action>
                <xf:action while="instance('xprProsopo')//eac:date[not(@notBefore)]
                        | instance('xprProsopo')//eac:fromDate[not(@notBefore)]
                        | instance('xprProsopo')//eac:toDate[not(@notBefore)]" ev:event="xforms-ready">
                        <xf:insert context="instance('xprProsopo')//eac:date[not(@notBefore)]
                                | instance('xprProsopo')//eac:fromDate[not(@notBefore)]
                                | instance('xprProsopo')//eac:toDate[not(@notBefore)]" origin="instance('xprSupplement')/eac:date/@notBefore"/>
                </xf:action>
        </xf:action>

        <!--Instances principales-->
        <xf:instance id="xprProsopo" src="/xpr/files/_xprProsopoInstance.xml"/>

        <!-- xprSupplement et xprEntitiesTypes servent également à xprNewEntity -->
        <xf:instance id="xprSupplement" src="/xpr/files/_xprSupplement.xml"/>

        <xf:instance id="xprEntitiesTypes">
                <EntitiesSubTypes xmlns="">
                        <identity type="person">
                                <label>Expert</label>
                                <value>expert</value>
                        </identity>
                        <identity type="person">
                                <label>Maçon</label>
                                <value>mason</value>
                        </identity>
                        <identity type="person">
                                <label>Tiers</label>
                                <value>person</value>
                        </identity>
                        <identity type="corporateBody">
                                <label>Office</label>
                                <value>office</value>
                        </identity>
                        <identity type="corporateBody">
                                <label>Notaire</label>
                                <value>notary</value>
                        </identity>
                        <identity type="corporateBody">
                                <label>Autre</label>
                                <value>org</value>
                        </identity>
                        <identity type="family">
                                <label>famille</label>
                                <value>family</value>
                        </identity>
                </EntitiesSubTypes>
        </xf:instance>

        <xf:instance id="xprEvents">
                <event xmlns="">
                        <type>
                                <label>Naissance</label>
                                <value>birth</value>
                        </type>
                        <type>
                                <label>Mariage</label>
                                <value>marriage</value>
                        </type>
                        <type>
                                <label>Maîtrise</label>
                                <value>master</value>
                        </type>
                        <type>
                                <label>Achat d'office</label>
                                <value>officePurchase</value>
                        </type>
                        <type>
                                <label>Provision d'office</label>
                                <value>provision</value>
                        </type>
                        <type>
                                <label>Réception</label>
                                <value>reception</value>
                        </type>
                        <type>
                                <label>Présence dans les Almanachs</label>
                                <value>almanacs</value>
                        </type>
                        <type>
                                <label>Honorariat</label>
                                <value>honorary</value>
                        </type>
                        <type>
                                <label>Résignation</label>
                                <value>relinquishment</value>
                        </type>
                        <type>
                                <label>Vente d'office</label>
                                <value>officeSale</value>
                        </type>
                        <type>
                                <label>Suppression des offices</label>
                                <value>officesEnding</value>
                        </type>
                        <type>
                                <label>Dispense d'age</label>
                                <value>exemption</value>
                        </type>
                        <type>
                                <label>Sentence d'interdiction</label>
                                <value>barringFromOffice</value>
                        </type>
                        <type>
                                <label>Faillite</label>
                                <value>bankruptcy</value>
                        </type>
                        <type>
                                <label>Saisie réelle</label>
                                <value>seizure</value>
                        </type>
                        <type>
                                <label>Décès</label>
                                <value>death</value>
                        </type>
                </event>
        </xf:instance>

        <xf:bind id="entityType" nodeset="instance('xprProsopo')/eac:cpfDescription/eac:identity/eac:entityType"/>
        <!--<xf:bind nodeset="instance('xprProsopo')/eac:cpfDescription/eac:identity/eac:nameEntry[./eac:authorizedForm]/eac:part" required="true()"/>-->
        <xf:bind id="nameEntry" nodeset="instance('xprProsopo')/eac:cpfDescription/eac:identity/eac:nameEntry[./eac:alternativeForm]"/>
        <xf:bind id="chronItem" nodeset="instance('xprProsopo')/eac:cpfDescription/eac:description/eac:biogHist/eac:chronList/eac:chronItem"/>
        <xf:bind id="chronItemType" nodeset="instance('xprProsopo')/eac:cpfDescription/eac:description/eac:biogHist/eac:chronList/eac:chronItem/@localType"/>
        <xf:bind id="chronItemDate" nodeset="instance('xprProsopo')/eac:cpfDescription/eac:description/eac:biogHist/eac:chronList/eac:chronItem/eac:date"/>
        <xf:bind id="chronItemPlace" nodeset="instance('xprProsopo')/eac:cpfDescription/eac:description/eac:biogHist/eac:chronList/eac:chronItem/eac:placeEntry"/>
        <xf:bind id="chronItemEvent" nodeset="instance('xprProsopo')/eac:cpfDescription/eac:description/eac:biogHist/eac:chronList/eac:chronItem/eac:event"/>
        <xf:bind id="chronItemParticipant" nodeset="instance('xprProsopo')/eac:cpfDescription/eac:description/eac:biogHist/eac:chronList/eac:chronItem/rico:participant"/>
        <xf:bind id="chronItemInvolve" nodeset="instance('xprProsopo')/eac:cpfDescription/eac:description/eac:biogHist/eac:chronList/eac:chronItem/rico:involve"/>
        <xf:bind id="chronItemSource" nodeset="instance('xprProsopo')/eac:cpfDescription/eac:description/eac:biogHist/eac:chronList/eac:chronItem/xpr:source"/>

        <xf:bind id="bindSource" nodeset="instance('xprSources')/*"/>
        <xf:bind id="bindParticipant" nodeset="instance('xprEntities')/*"/>

        <xf:submission id="submitBio" resource="/xpr/biographies/put" method="put" replace="none">
                <xf:action ev:event="xforms-submit">
                        <xf:delete nodeset="instance('xprProsopo')//@standardDate[. = '']"/>
                        <xf:delete nodeset="instance('xprProsopo')//@notBefore[. = '']"/>
                        <xf:delete nodeset="instance('xprProsopo')//@notAfter[. = '']"/>
                </xf:action>
                <xf:action ev:event="xforms-submit" if="instance('xprProsopo')//eac:nameEntry[child::eac:authorizedForm]/eac:part[. = '']">
                        <xf:setvalue ref="instance('xprProsopo')//eac:nameEntry[child::eac:authorizedForm]/eac:part[. = '']" 
                                value="concat(
                                if(instance('xprProsopo')//eac:entityType[. = 'person'], concat(instance('xprProsopo')//eac:nameEntry[child::eac:alternativeForm][position() = 1]/eac:part[@localType='surname'], ', ', instance('xprProsopo')//eac:nameEntry[child::eac:alternativeForm][position() = 1]/eac:part[@localType='forename'], ' (', if(instance('xprProsopo')//eac:existDates//eac:fromDate/@*[not(. = '')], substring(instance('xprProsopo')//eac:existDates//eac:fromDate/@*[not(. = '')], 1, 4), '?'), ' - ', if(instance('xprProsopo')//eac:existDates//eac:toDate/@*[not(. = '')], substring(instance('xprProsopo')//eac:existDates//eac:toDate/@*[not(. = '')], 1, 4), '?'), ')'), ''),
                                if(instance('xprProsopo')//eac:entityType[. = 'corporateBody'], concat(instance('xprProsopo')//eac:nameEntry[child::eac:alternativeForm][position() = 1]/eac:part[@localType='officeName'], ''), ''),
                                if(instance('xprProsopo')//eac:entityType[. = 'family'], concat(instance('xprProsopo')//eac:nameEntry[child::eac:alternativeForm][position() = 1]/eac:part[@localType='surname'], ''), '')
                                )"/>
                        <!--<xf:setvalue ref="instance('xprProsopo')//eac:nameEntry[child::eac:authorizedForm]/eac:part[. = '']" value="concat(instance('xprProsopo')//eac:nameEntry[child::eac:alternativeForm][position() = 1]/eac:part[@localType='officeName'], instance('xprProsopo')//eac:nameEntry[child::eac:alternativeForm][position() = 1]/eac:part[@localType='surname'], if(instance('xprProsopo')//eac:identity/eac:entityType='person', ', ', ''), instance('xprProsopo')//eac:nameEntry[child::eac:alternativeForm]/eac:part[@localType='forename'])"/>-->
                </xf:action>
                <xf:action ev:event="xforms-submit" while="instance('xprProsopo')//xpr:source/@*[local-name() = 'href'][not(. = '')][not(. = instance('xprProsopo')//eac:control//eac:source/@*[local-name() = 'href'])]">
                        <xf:insert origin="instance('xprSupplement')/eac:source" context="instance('xprProsopo')//eac:sources"/>
                        <xf:setvalue ref="instance('xprProsopo')//eac:sources/eac:source/@*[local-name() = 'href'][. = '']" value="instance('xprProsopo')//xpr:source/@*[local-name() = 'href'][not(. = instance('xprProsopo')//eac:control//eac:source/@*[local-name() = 'href'])]"/>
                        <xf:setvalue ref="instance('xprProsopo')//eac:sources/eac:source/eac:sourceEntry[. = '']" value="ancestor::eac:source/@*[local-name() = 'href']"/>
                </xf:action>
                <xf:action ev:event="xforms-submit-done">
                        <xf:message level="ephemeral"> So Good ! </xf:message>
                        <xf:load show="replace">
                                <xf:resource value="'/xpr/biographies/new'"/>
                        </xf:load>
                </xf:action>
                <xf:action ev:event="xforms-submit-error">
                        <xf:message>Votre formulaire n’a pas pu être enregistré, merci de corriger les erreurs</xf:message>
                        <xf:action while="instance('xprProsopo')//eac:date[not(@standardDate)] 
                                | instance('xprProsopo')//eac:fromDate[not(@standardDate)] 
                                | instance('xprProsopo')//eac:toDate[not(@standardDate)]" ev:event="xforms-submit-error">
                                <xf:insert context="instance('xprProsopo')//eac:date[not(@standardDate)] 
                                        | instance('xprProsopo')//eac:fromDate[not(@standardDate)] 
                                        | instance('xprProsopo')//eac:toDate[not(@standardDate)]" origin="instance('xprSupplement')/eac:date/@standardDate"/>
                        </xf:action>
                        <xf:action while="instance('xprProsopo')//eac:date[not(@notAfter)]
                                | instance('xprProsopo')//eac:fromDate[not(@notAfter)]
                                | instance('xprProsopo')//eac:toDate[not(@notAfter)]" ev:event="xforms-submit-error-ready">
                                <xf:insert context="instance('xprProsopo')//eac:date[not(@notAfter)]
                                        | instance('xprProsopo')//eac:fromDate[not(@notAfter)]
                                        | instance('xprProsopo')//eac:toDate[not(@notAfter)]" origin="instance('xprSupplement')/eac:date/@notAfter"/>
                        </xf:action>
                        <xf:action while="instance('xprProsopo')//eac:date[not(@notBefore)]
                                | instance('xprProsopo')//eac:fromDate[not(@notBefore)]
                                | instance('xprProsopo')//eac:toDate[not(@notBefore)]" ev:event="xforms-submit-error">
                                <xf:insert context="instance('xprProsopo')//eac:date[not(@notBefore)]
                                        | instance('xprProsopo')//eac:fromDate[not(@notBefore)]
                                        | instance('xprProsopo')//eac:toDate[not(@notBefore)]" origin="instance('xprSupplement')/eac:date/@notBefore"/>
                        </xf:action>
                </xf:action>
        </xf:submission>

        <!-- instance xprEntities (liste des fiches prosopo présentes dans la base (servie par Basex))-->
        <xf:instance id="xprEntities" src="/xpr/entities"/>

        <!-- instance xprNewEntity -->
        <xf:instance id="xprNewEntity" src="/xpr/files/_xprProsopoInstance.xml"/>

        <xf:bind id="newEntityType" nodeset="instance('xprNewEntity')/eac:cpfDescription/eac:identity/eac:entityType"/>
        <xf:bind id="newNameEntry" nodeset="instance('xprNewEntity')/eac:cpfDescription/eac:identity/eac:nameEntry[./eac:alternativeForm]"/>
        <xf:bind id="newChronItem" nodeset="instance('xprNewEntity')/eac:cpfDescription/eac:description/eac:biogHist/eac:chronList/eac:chronItem"/>

        <xf:submission id="submitNewEntity" ref="instance('xprNewEntity')" resource="/xpr/biographies/put" method="put" replace="none">
                <xf:action ev:event="xforms-submit">
                        <xf:delete nodeset="instance('xprNewEntity')//@standardDate[. = '']"/>
                        <xf:delete nodeset="instance('xprNewEntity')//@notBefore[. = '']"/>
                        <xf:delete nodeset="instance('xprNewEntity')//@notAfter[. = '']"/>
                </xf:action>
                <xf:action ev:event="xforms-submit" while="instance('xprNewEntity')//xpr:source/@*[local-name() = 'href'][not(. = '')][not(. = instance('xprNewEntity')//eac:control//eac:source/@*[local-name() = 'href'])]">
                        <xf:insert origin="instance('xprSupplement')/eac:source" context="instance('xprNewEntity')//eac:sources"/>
                        <xf:setvalue ref="instance('xprNewEntity')//eac:sources/eac:source/@*[local-name() = 'href'][. = '']" value="instance('xprNewEntity')//xpr:source/@*[local-name() = 'href'][not(. = instance('xprNewEntity')//eac:control//eac:source/@*[local-name() = 'href'])]"/>
                        <xf:setvalue ref="instance('xprNewEntity')//eac:sources/eac:source/eac:sourceEntry[. = '']" value="ancestor::eac:source/@*[local-name() = 'href']"/>
                </xf:action>
                <xf:action ev:event="xforms-submit" if="instance('xprNewEntity')//eac:nameEntry[child::eac:authorizedForm]/eac:part[. = '']">
                        <xf:setvalue ref="instance('xprNewEntity')//eac:nameEntry[child::eac:authorizedForm]/eac:part[. = '']" 
                                value="concat(
                                if(instance('xprNewEntity')//eac:entityType[. = 'person'], concat(instance('xprNewEntity')//eac:nameEntry[child::eac:alternativeForm][position() = 1]/eac:part[@localType='surname'], ', ', instance('xprNewEntity')//eac:nameEntry[child::eac:alternativeForm][position() = 1]/eac:part[@localType='forename'], ' (', if(instance('xprNewEntity')//eac:existDates//eac:fromDate/@*[not(. = '')], substring(instance('xprNewEntity')//eac:existDates//eac:fromDate/@*[not(. = '')], 1, 4), '?'), ' - ', if(instance('xprNewEntity')//eac:existDates//eac:toDate/@*[not(. = '')], substring(instance('xprNewEntity')//eac:existDates//eac:toDate/@*[not(. = '')], 1, 4), '?'), ')'), ''),
                                if(instance('xprNewEntity')//eac:entityType[. = 'corporateBody'], concat(instance('xprNewEntity')//eac:nameEntry[child::eac:alternativeForm][position() = 1]/eac:part[@localType='officeName'], ''), ''),
                                if(instance('xprNewEntity')//eac:entityType[. = 'family'], concat(instance('xprNewEntity')//eac:nameEntry[child::eac:alternativeForm][position() = 1]/eac:part[@localType='surname'], ''), '')
                                )"/>
                        <!--<xf:setvalue ref="instance('xprNewEntity')//eac:nameEntry[child::eac:authorizedForm]/eac:part" value="concat(instance('xprNewEntity')//eac:nameEntry[child::eac:alternativeForm][position() = 1]/eac:part[@localType='officeName'], instance('xprNewEntity')//eac:nameEntry[child::eac:alternativeForm][position() = 1]/eac:part[@localType='surname'], if(instance('xprNewEntity')//eac:identity/eac:entityType='person', ', ', ''), instance('xprNewEntity')//eac:nameEntry[child::eac:alternativeForm]/eac:part[@localType='forename'])"/>-->
                </xf:action>
                <xf:action ev:event="xforms-submit-done">
                        <xf:message level="ephemeral">So Good !</xf:message>
                        <xf:send submission="reloadEntities"/>
                        <xf:send submission="reloadNewEntity"/>
                </xf:action>
                <xf:action ev:event="xforms-submit-error">
                        <xf:message>Votre formulaire n’a pas pu être enregistré, merci de corriger les erreurs</xf:message>
                        <xf:action while="instance('xprNewEntity')//eac:date[not(@standardDate)] 
                                | instance('xprNewEntity')//eac:fromDate[not(@standardDate)] 
                                | instance('xprNewEntity')//eac:toDate[not(@standardDate)]" ev:event="xforms-submit-error">
                                <xf:insert context="instance('xprNewEntity')//eac:date[not(@standardDate)] 
                                        | instance('xprNewEntity')//eac:fromDate[not(@standardDate)] 
                                        | instance('xprNewEntity')//eac:toDate[not(@standardDate)]" origin="instance('xprSupplement')/eac:date/@standardDate"/>
                        </xf:action>
                        <xf:action while="instance('xprNewEntity')//eac:date[not(@notAfter)]
                                | instance('xprNewEntity')//eac:fromDate[not(@notAfter)]
                                | instance('xprNewEntity')//eac:toDate[not(@notAfter)]" ev:event="xforms-submit-error">
                                <xf:insert context="instance('xprNewEntity')//eac:date[not(@notAfter)]
                                        | instance('xprNewEntity')//eac:fromDate[not(@notAfter)]
                                        | instance('xprNewEntity')//eac:toDate[not(@notAfter)]" origin="instance('xprSupplement')/eac:date/@notAfter"/>
                        </xf:action>
                        <xf:action while="instance('xprNewEntity')//eac:date[not(@notBefore)]
                                | instance('xprNewEntity')//eac:fromDate[not(@notBefore)]
                                | instance('xprNewEntity')//eac:toDate[not(@notBefore)]" ev:event="xforms-submit-error">
                                <xf:insert context="instance('xprNewEntity')//eac:date[not(@notBefore)]
                                        | instance('xprNewEntity')//eac:fromDate[not(@notBefore)]
                                        | instance('xprNewEntity')//eac:toDate[not(@notBefore)]" origin="instance('xprSupplement')/eac:date/@notBefore"/>
                        </xf:action>
                </xf:action>
        </xf:submission>

        <xf:submission id="reloadEntities" method="get" resource="/xpr/entities" replace="instance" instance="xprEntities"/>

        <xf:submission id="reloadNewEntity" resource="/xpr/files/_xprProsopoInstance.xml" replace="instance" instance="xprNewEntity">
                <xf:action ev:event="xforms-submit-done">
                        <xf:insert origin="instance('xprProsopo')/*" context="instance('xprStorage')/eac:eac-cpf[@xml:id]" position="after"/>
                        <xf:setvalue ref="instance('xprStorage')/eac:eac-cpf[@xml:id]/@xml:id" value="instance('xprProsopo')/@xml:id"/>
                        <xf:insert origin="instance('xprStorage')/eac:eac-cpf[@xml:id]" nodeset="instance('xprProsopo')"/>
                        <xf:delete ref="instance('xprStorage')/eac:eac-cpf/*"/>
                </xf:action>
        </xf:submission>

        <!-- instance xprSources (liste des sources présentes dans la base)-->
        <xf:instance id="xprSources" src="/xpr/sources"/>

        <xf:instance id="xprNewSource" src="/xpr/files/_xprSourceInstance.xml"/>

        <xf:submission id="submitNewSource" ref="instance('xprNewSource')" resource="/xpr/sources/put" method="put" replace="none">
                <xf:action ev:event="xforms-submit-done">
                        <xf:message level="ephemeral">So Good !</xf:message>
                        <xf:send submission="reloadSources"/>
                        <xf:send submission="reloadNewSource"/>
                </xf:action>
                <xf:action ev:event="xforms-submit-error">
                        <xf:message>Votre formulaire n’a pas pu être enregistré, merci de corriger les erreurs</xf:message>
                </xf:action>
        </xf:submission>

        <xf:submission id="reloadSources" method="get" resource="/xpr/sources" replace="instance" instance="xprSources"/>

        <xf:submission id="reloadNewSource" resource="/xpr/files/_xprSourceInstance.xml" replace="instance" instance="xprNewSource">
                <xf:action ev:event="xforms-submit-done">
                        <xf:insert origin="instance('xprProsopo')/*" context="instance('xprStorage')/eac:eac-cpf[@xml:id]" position="after"/>
                        <xf:insert origin="instance('xprNewEntity')/*" context="instance('xprStorage')/eac:eac-cpf[not(@xml:id)]" position="after"/>
                        <xf:setvalue ref="instance('xprStorage')/eac:eac-cpf[@xml:id]/@xml:id" value="instance('xprProsopo')/@xml:id"/>
                        <xf:insert origin="instance('xprStorage')/eac:eac-cpf[@xml:id]" nodeset="instance('xprProsopo')"/>
                        <xf:insert origin="instance('xprStorage')/eac:eac-cpf[not(@xml:id)]" nodeset="instance('xprNewEntity')"/>
                        <xf:delete ref="instance('xprStorage')/eac:eac-cpf/*"/>
                </xf:action>
        </xf:submission>

        <xf:instance id="xprIdentities">
                <xpr xmlns="xpr" xmlns:eac="eac">
                        <eac:identity/>
                        <eac:identity/>
                </xpr>
        </xf:instance>

        <xf:instance id="xprStorage">
                <xpr xmlns="xpr">
                        <eac-cpf xml:id="" xmlns="eac" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xpr="xpr" xmlns:tei="http://www.tei-c.org/ns/1.0" xmlns:rico="rico"/>
                        <eac-cpf xmlns="eac" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xpr="xpr" xmlns:tei="http://www.tei-c.org/ns/1.0" xmlns:rico="rico"/>
                </xpr>
        </xf:instance>

</xf:model>
