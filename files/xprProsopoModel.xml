<xf:model id="prosopo" xmlns:xf="http://www.w3.org/2002/xforms" xmlns:ev="http://www.w3.org/2001/xml-events">
        <xf:action ev:event="xforms-ready">
                <xf:action while="instance('xprProsopo')//eac:date[not(@standardDate)] 
                        | instance('xprProsopo')//eac:fromDate[not(@standardDate)] 
                        | instance('xprProsopo')//eac:toDate[not(@standardDate)]" ev:event="xforms-ready">
                        <xf:insert context="instance('xprProsopo')//eac:date[not(@standardDate)] 
                                | instance('xprProsopo')//eac:fromDate[not(@standardDate)] 
                                | instance('xprProsopo')//eac:toDate[not(@standardDate)]" origin="instance('xprSupplement')/eac:date/@standardDate"/>
                </xf:action>
                <xf:action while="instance('xprProsopo')//eac:date[not(@notAfter)]
                        | instance('xprProsopo')//eac:fromDate[not(@notAfter)]
                        | instance('xprProsopo')//eac:toDate[not(@notAfter)]" ev:event="xforms-ready">
                        <xf:insert context="instance('xprProsopo')//eac:date[not(@notAfter)]
                                | instance('xprProsopo')//eac:fromDate[not(@notAfter)]
                                | instance('xprProsopo')//eac:toDate[not(@notAfter)]" origin="instance('xprSupplement')/eac:date/@notAfter"/>
                </xf:action>
                <xf:action while="instance('xprProsopo')//eac:date[not(@notBefore)]
                        | instance('xprProsopo')//eac:fromDate[not(@notBefore)]
                        | instance('xprProsopo')//eac:toDate[not(@notBefore)]" ev:event="xforms-ready">
                        <xf:insert context="instance('xprProsopo')//eac:date[not(@notBefore)]
                                | instance('xprProsopo')//eac:fromDate[not(@notBefore)]
                                | instance('xprProsopo')//eac:toDate[not(@notBefore)]" origin="instance('xprSupplement')/eac:date/@notBefore"/>
                </xf:action>
        </xf:action>

        <!--Instance principale-->
        <xf:instance id="xprProsopo" src="/xpr/files/_xprProsopoInstance.xml"/>
        
        <xf:instance id="xprNewEntity" src="/xpr/files/_xprProsopoInstance.xml"/>
        
        <xf:submission id="submitNewEntity" ref="instance('xprNewEntity')" resource="/xpr/biographies/put" method="put" replace="none">
                <xf:action ev:event="xforms-submit">
                        <xf:delete nodeset="instance('xprNewEntity')//@standardDate[. = '']"/>
                        <xf:delete nodeset="instance('xprNewEntity')//@notBefore[. = '']"/>
                        <xf:delete nodeset="instance('xprNewEntity')//@notAfter[. = '']"/>
                </xf:action>
                <xf:action ev:event="xforms-submit-done">
                        <xf:message level="ephemeral">So Good !</xf:message>
                        <xf:send submission="reloadEntities"/>
                </xf:action>
                <xf:action ev:event="xforms-submit-error">
                        <xf:message>Votre formulaire n’a pas pu être enregistré, merci de corriger les erreurs</xf:message>
                </xf:action>
        </xf:submission>
        
        <xf:submission id="reloadEntities" method="get" resource="/xpr/entities" replace="instance" instance="xprEntities"/>
        
        <xf:instance id="xprEntities" src="/xpr/entities"/>

        <xf:instance id="xprSources" src="/xpr/sources"/>

        <xf:instance id="xprSupplement" src="/xpr/files/_xprSupplement.xml"/>

        <xf:submission id="submitBio" resource="/xpr/biographies/put" method="put" replace="none">
                <xf:action ev:event="xforms-submit">
                        <xf:delete nodeset="instance('xprProsopo')//@standardDate[. = '']"/>
                        <xf:delete nodeset="instance('xprProsopo')//@notBefore[. = '']"/>
                        <xf:delete nodeset="instance('xprProsopo')//@notAfter[. = '']"/>
                </xf:action>
                <xf:action ev:event="xforms-submit-done">
                        <xf:message level="ephemeral"> So Good ! </xf:message>
                        <xf:load show="replace">
                                <xf:resource value="'/xpr/biographies/new'"/>
                        </xf:load>
                </xf:action>
                <xf:action ev:event="xforms-submit-error">
                        <xf:message>Votre formulaire n’a pas pu être enregistré, merci de corriger les erreurs</xf:message>
                </xf:action>
        </xf:submission>

        <xf:submission id="reloadSources" method="get" resource="/xpr/sources" replace="instance" instance="xprSources"/>

        <xf:bind id="entityType" nodeset="eac:cpfDescription/eac:identity/eac:entityType"/>
        <xf:bind id="nameEntry" nodeset="eac:cpfDescription/eac:identity/eac:nameEntry[./eac:alternativeForm]"/>

        <xf:bind id="chronItem" nodeset="instance('xprProsopo')/eac:cpfDescription/eac:description/eac:biogHist/eac:chronList/eac:chronItem"/>
        <xf:bind id="chronItemType" nodeset="instance('xprProsopo')/eac:cpfDescription/eac:description/eac:biogHist/eac:chronList/eac:chronItem/@localType"/>
        <xf:bind id="chronItemDate" nodeset="instance('xprProsopo')/eac:cpfDescription/eac:description/eac:biogHist/eac:chronList/eac:chronItem/eac:date"/>
        <xf:bind id="chronItemPlace" nodeset="instance('xprProsopo')/eac:cpfDescription/eac:description/eac:biogHist/eac:chronList/eac:chronItem/eac:placeEntry"/>
        <xf:bind id="chronItemEvent" nodeset="instance('xprProsopo')/eac:cpfDescription/eac:description/eac:biogHist/eac:chronList/eac:chronItem/eac:event"/>
        <xf:bind id="chronItemParticipant" nodeset="instance('xprProsopo')/eac:cpfDescription/eac:description/eac:biogHist/eac:chronList/eac:chronItem/rico:participant"/>
        <xf:bind id="chronItemInvolve" nodeset="instance('xprProsopo')/eac:cpfDescription/eac:description/eac:biogHist/eac:chronList/eac:chronItem/rico:involve"/>
        <xf:bind id="chronItemSource" nodeset="instance('xprProsopo')/eac:cpfDescription/eac:description/eac:biogHist/eac:chronList/eac:chronItem/xpr:source"/>


        <xf:bind id="bindSource" nodeset="instance('xprSources')/*"/>
        
        <!--<xf:bind nodeset="instance('xprProsopo')//eac:nameEntry[child::eac:alternativeForm]//@xml:id" calculate="concat('name', count(ancestor::eac:nameEntry/preceding-sibling::eac:nameEntry) + 1)"/>-->
        <!--<xf:bind nodeset="instance('xprProsopo')//eac:nameEntry[child::eac:alternativeForm]//@xml:id" calculate="concat(ancestor::eac:nameEntry/eac:part[@localType='surname'], 'toto')"/>-->


        <xf:instance id="xprSource" src="/xpr/files/_xprSourceInstance.xml"/>

        <xf:submission id="submitSource" ref="instance('xprSource')" resource="/xpr/sources/put" method="put" replace="none">
                <xf:action ev:event="xforms-submit-done">
                        <xf:message level="ephemeral">So Good !</xf:message>
                        <xf:send submission="reloadSources"/>
                </xf:action>
                <xf:action ev:event="xforms-submit-error">
                        <xf:message>Votre formulaire n’a pas pu être enregistré, merci de corriger les erreurs</xf:message>
                </xf:action>
        </xf:submission>

</xf:model>
