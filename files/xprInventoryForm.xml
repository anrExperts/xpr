<form xmlns:xf="http://www.w3.org/2002/xforms" xmlns:ev="http://www.w3.org/2001/xml-events">
    <xf:group ref="xpr:sourceDesc">
        <xf:input ref="xpr:idno/@unitid" incremental="true">
            <xf:label>Cote</xf:label>
        </xf:input>
        <xf:input ref="xpr:date/@when" incremental="true">
            <xf:label>Date de l'inventaire</xf:label>
        </xf:input>
        <xf:input ref="xpr:location" incremental="true">
            <xf:label>Pages, folios</xf:label>
        </xf:input>
        <xf:select1 ref="xpr:expert/@ref" incremental="true">
            <xf:label>Patronyme</xf:label>
            <xf:itemset nodeset="instance('xprEntities')/*[@type='expert']">
                <xf:label value="."/>
                <xf:value ref="@xml:id"/>
            </xf:itemset>
        </xf:select1>
    </xf:group>
    <xf:group ref="xpr:place">
        <xf:label>Adresse au moment du décès</xf:label>
        <xf:input ref="xpr:address/xpr:street" incremental="true">
            <xf:label>Voie</xf:label>
        </xf:input>
        <xf:input ref="xpr:address/xpr:buildingNumber" incremental="true">
            <xf:label>Numéro de la voie</xf:label>
        </xf:input>
        <xf:input ref="xpr:complement" incremental="true">
            <xf:label>Précisions géographiques</xf:label>
        </xf:input>
        <xf:input ref="xpr:parish" incremental="true">
            <xf:label>Paroisse</xf:label>
        </xf:input>
        <xf:input ref="xpr:city" incremental="true">
            <xf:label>Ville</xf:label>
        </xf:input>
        <xf:input ref="xpr:district" incremental="true">
            <xf:label>Département</xf:label>
        </xf:input>
        <xf:input ref="xpr:owner" incremental="true">
            <xf:label>Propriétaire</xf:label>
        </xf:input>
    </xf:group>
    <xf:group ref="xpr:relations">
        <xf:label>Relations</xf:label>
        <xf:repeat id="repeatRelation" nodeset="xpr:relation">
            <xf:select1 ref="@arcrole" incremental="true">
                <xf:label>Type de relation</xf:label>
                <xf:itemset nodeset="instance('xprRelationsTypes')/type">
                    <xf:label ref="label"/>
                    <xf:value ref="value"/>
                </xf:itemset>
            </xf:select1>
            <xf:input ref="xpr:relationEntry/eac:nameEntry[eac:authorizedForm]/eac:part">
                <xf:label>Forme contrôlée</xf:label>
            </xf:input>
            <xf:group ref="xpr:relationEntry/eac:nameEntry[eac:alternativeForm]">
                <xf:label>Forme attestée</xf:label>
                <xf:input ref="eac:part[@localType='surname']">
                    <xf:label>Nom</xf:label>
                </xf:input>
                <xf:input ref="eac:part[@localType='forename']">
                    <xf:label>Prénom</xf:label>
                </xf:input>
                <xf:input ref="eac:part[@localType='particle']">
                    <xf:label>Particule</xf:label>
                </xf:input>
                <xf:input ref="eac:part[@localType='common']">
                    <xf:label>Titre d'appel</xf:label>
                </xf:input>
                <xf:input ref="eac:part[@localType='formal']">
                    <xf:label>Titre institutionnel</xf:label>
                </xf:input>
                <xf:input ref="eac:part[@localType='academic']">
                    <xf:label>Titre académique</xf:label>
                </xf:input>
                <xf:input ref="eac:part[@localType='religious']">
                    <xf:label>Titre religieux</xf:label>
                </xf:input>
                <xf:input ref="eac:part[@localType='nobiliary']">
                    <xf:label>Titre de noblesse</xf:label>
                </xf:input>
            </xf:group>
            <xf:select1 ref="xpr:relationEntry/@sex" incremental="true">
                <xf:label>Sexe</xf:label>
                <xf:item>
                    <xf:label>Homme</xf:label>
                    <xf:value>male</xf:value>
                </xf:item>
                <xf:item>
                    <xf:label>Femme</xf:label>
                    <xf:value>female</xf:value>
                </xf:item>
            </xf:select1>
            <xf:select1 ref="xpr:relationEntry/@type">
                <xf:label>Répertoire</xf:label>
                <xf:item>
                    <xf:label>Expert (parisien)</xf:label>
                    <xf:value>expert</xf:value>
                </xf:item>
                <!--<xf:item>
                    <!-\- @todo ?-\->
                    <xf:label>Expert (autre)</xf:label>
                    <xf:value>expertExt</xf:value>
                </xf:item>-->
                <xf:item>
                    <xf:label>Maçon</xf:label>
                    <xf:value>mason</xf:value>
                </xf:item>
                <xf:item>
                    <xf:label>Autre</xf:label>
                    <xf:value>person</xf:value>
                </xf:item>
            </xf:select1>
            <xf:input ref="xpr:occupation">
                <xf:label>Profession</xf:label>
            </xf:input>
            <xf:input ref="xpr:address">
                <xf:label>Adresse</xf:label>
            </xf:input>
            <xf:trigger class="delete">
                <xf:label>&#10007;</xf:label>
                <xf:delete nodeset="." at="1" ev:event="DOMActivate" if="count(//xpr:relation) > 1 and @href=''"/>
                <xf:help>Supprimer une relation.</xf:help>
            </xf:trigger>
        </xf:repeat>
        <xf:trigger>
            <xf:label>ajouter une relation</xf:label>
            <xf:action ev:event="DOMActivate">
                <xf:insert nodeset="xpr:relation" at="index('repeatRelation')" position="after"/>
                <xf:setvalue ref="xpr:relation[index('repeatRelation')]//* | xpr:relation[index('repeatRelation')]//@*" value=""/>
            </xf:action>
        </xf:trigger>
    </xf:group>
    <xf:group ref="xpr:wealth">
        <xf:label>Fortune</xf:label>
        <xf:select1 ref="xpr:state" incremental="true">
            <xf:label>Propriétaire/locataire</xf:label>
            <xf:item>
                <xf:label>Propriétaire</xf:label>
                <xf:value>propriétaire</xf:value>
                <xf:action ev:event="xforms-select">
                    <xf:setvalue ref="@type">owner</xf:setvalue>
                </xf:action>
            </xf:item>
            <xf:item>
                <xf:label>Locataire</xf:label>
                <xf:value>locataire</xf:value>
                <xf:action ev:event="xforms-select">
                    <xf:setvalue ref="@type">occupant</xf:setvalue>
                </xf:action>
            </xf:item>
        </xf:select1>
        <xf:group ref="xpr:possessions">
            <xf:label>Biens mobiliers</xf:label>
            <xf:input ref="xpr:movables">
                <xf:label>Somme totale</xf:label>
            </xf:input>
        </xf:group>
        <xf:group ref="xpr:possessions">
            <xf:label>Biens immobiliers</xf:label>
            <xf:group ref="xpr:estate">
                <xf:label>Habitation principale</xf:label>
                <xf:input ref="@rooms">
                    <xf:label>Nombre de pièces</xf:label>
                </xf:input>
            </xf:group>
            <xf:group ref="xpr:workshop">
                <xf:label>Atelier</xf:label>
                <xf:input ref="@rooms">
                    <xf:label>Nombre de pièces</xf:label>
                </xf:input>
                <xf:input ref="@equipment">
                    <xf:label>Montant total du matériel</xf:label>
                </xf:input>
            </xf:group>
            <xf:group>
                <xf:label>Autres</xf:label>
                <xf:repeat id="repeatOther" nodeset="xpr:other">
                    <xf:input ref="xpr:desc">
                        <xf:label>Description</xf:label>
                    </xf:input>
                    <xf:input ref="@rooms">
                        <xf:label>Nombre de pièces</xf:label>
                    </xf:input>
                    <xf:select1 ref="xpr:place">
                        <xf:label>Localisation</xf:label>
                        <xf:item>
                            <xf:label>Paris</xf:label>
                            <xf:value>Paris</xf:value>
                            <xf:action ev:event="xforms-select">
                                <xf:setvalue ref="@type">Paris</xf:setvalue>
                            </xf:action>
                        </xf:item>
                        <xf:item>
                            <xf:label>Banlieue</xf:label>
                            <xf:value>Banlieue</xf:value>
                            <xf:action ev:event="xforms-select">
                                <xf:setvalue ref="@type">suburbs</xf:setvalue>
                            </xf:action>
                        </xf:item>
                        <xf:item>
                            <xf:label>Province</xf:label>
                            <xf:value>province</xf:value>
                            <xf:action ev:event="xforms-select">
                                <xf:setvalue ref="@type">province</xf:setvalue>
                            </xf:action>
                        </xf:item>
                    </xf:select1>
                    <xf:trigger class="delete">
                        <xf:label>&#10007;</xf:label>
                        <xf:delete nodeset="." at="1" ev:event="DOMActivate" if="count(//xpr:wealth/xpr:possessions/xpr:other) > 1"/>
                        <xf:help>Supprimer un bien immobilier.</xf:help>
                    </xf:trigger>
                </xf:repeat>
                <xf:trigger class="insert">
                    <xf:label>Ajouter un bien immobilier</xf:label>
                    <xf:action ev:event="DOMActivate">
                        <xf:insert nodeset="xpr:other" at="index('repeatOther')" position="after" ev:event="DOMActivate"/>
                        <xf:setvalue ref="xpr:other[index('repeatOther')]/@rooms" value=""/>
                        <xf:setvalue ref="xpr:other[index('repeatOther')]/xpr:place" value=""/>
                        <xf:setvalue ref="xpr:other[index('repeatOther')]/xpr:place/@type" value=""/>
                    </xf:action>
                    <xf:help>Ajouter un bien immobilier.</xf:help>
                </xf:trigger>
            </xf:group>
        </xf:group>
        <xf:input ref="xpr:dowry">
            <xf:label>Dot de la femme</xf:label>
        </xf:input>
        <xf:input ref="xpr:contribution">
            <xf:label>Apport de l'expert lors du mariage</xf:label>
        </xf:input>
    </xf:group>
    <xf:group ref="xpr:knowledge">
        <xf:label>Savoir - culture</xf:label>
        <xf:group ref="xpr:books">
            <xf:label>Livres</xf:label>
            <xf:input ref="@volumes">
                <xf:label>Nombre de volumes</xf:label>
            </xf:input>
            <xf:input ref="xpr:value">
                <xf:label>Valeur totale des volumes</xf:label>
            </xf:input>
            <xf:input ref="xpr:bookseller">
                <xf:label>Nom de l'expert libraire</xf:label>
            </xf:input>
        </xf:group>
        <xf:group ref="xpr:drawings">
            <xf:label>Dessins</xf:label>
            <xf:input ref="@quantity">
                <xf:label>Quantité</xf:label>
            </xf:input>
            <xf:textarea ref=".">
                <xf:label>Description</xf:label>
            </xf:textarea>
        </xf:group>
        <xf:group ref="xpr:paintings">
            <xf:label>Peintures</xf:label>
            <xf:input ref="@quantity">
                <xf:label>Quantité</xf:label>
            </xf:input>
            <xf:textarea ref=".">
                <xf:label>Description</xf:label>
            </xf:textarea>
        </xf:group>
    </xf:group>
    <xf:group ref="xpr:comments">
        <xf:label>Commentaires libres</xf:label>
        <xf:textarea ref=".">
            <xf:label>Commentaires</xf:label>
            <xf:help>Ce champ permet de signaler les collectionneurs ou les aspects remarquables.</xf:help>
        </xf:textarea>
    </xf:group>
    <!--<xf:trigger>
        <xf:label>Enregistrer</xf:label>
        <xf:action ev:event="DOMActivate">
            <!-\- initialisation de l'instance xprIterate pour les ajouts successifs des personnes dans la bdd -\->
            <xf:setvalue ref="instance('xprIterate')" value="1"/>

            <!-\- initialisation de l'instance prosopo -\->
            <xf:insert origin="instance('xprSupplement')/eac:nameEntry" nodeset="instance('xprProsopo')/eac:cpfDescription/eac:identity/eac:nameEntry" at="last()"/>
            <xf:delete ref="instance('xprProsopo')/eac:cpfDescription/eac:identity/eac:nameEntry[eac:alternativeForm]/eac:part[@localType='officeName']"/>

            <xf:action while="count(instance('xprInventory')//xpr:relation[@href = '']) &gt; instance('xprIterate')">
                <xf:send submission="submitEntity"/>
            </xf:action>
        </xf:action>
    </xf:trigger>-->
    <xf:trigger>
        <xf:label>Enregistrer</xf:label>
        <xf:action ev:event="DOMActivate">
            <xf:action while="instance('xprInventory')//xpr:relation[@href = '']">
                <xf:send submission="submitEntity"/>
            </xf:action>
            <xf:action ev:event="xforms-value-changed" ev:observer="testOb" if="not(instance('xprInventory')/xpr:relations//xpr:relation[@href = ''])">
                <!-- @todo créer une instance response pour placer l'observer dessus (pour chaque relation => un element response )-->
                <!-- OK fonctionne avec un bind => testOb-->
                <xf:send submission="submitInventory"/>
            </xf:action>
        </xf:action>
    </xf:trigger>
</form>
